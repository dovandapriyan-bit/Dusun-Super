<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sistem Keamanan Dusun - FULL</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  body { background:#f4f7ff; font-family: Inter, 'Segoe UI', Arial, sans-serif; }
  .card { border-radius:12px; box-shadow:0 6px 18px rgba(20,30,60,0.06); }
  .form-control, .btn { border-radius:10px; }
  #map { width:100%; height:350px; border-radius:8px; }
  .small-muted { font-size:.9rem; color:#555; }
  .hidden { display:none !important; }
</style>
</head>
<body>
<div class="container py-4">

  <div id="app" class="mx-auto" style="max-width:1100px;">
    <h3 class="mb-3 text-center">Sistem Keamanan Dusun — FULL</h3>

    <!-- AUTH / CREATE UI -->
    <div id="authCard" class="card p-3 mb-4">
      <div class="row g-3">
        <!-- Left: Buat Dusun -->
        <div class="col-md-6">
          <h5>Buat Dusun (Kepala Dusun)</h5>
          <div class="mb-2">
            <input id="namaDusun" class="form-control mb-2" placeholder="Nama Dusun">
            <input id="desa" class="form-control mb-2" placeholder="Desa">
            <input id="kota" class="form-control mb-2" placeholder="Kota">
            <input id="kabupaten" class="form-control mb-2" placeholder="Kabupaten">
            <input id="kecamatan" class="form-control mb-2" placeholder="Kecamatan">
            <!-- Kode Dusun tampil sebagai input agar bisa copy -->
            <div class="input-group mb-2 d-none" id="kodeGroup">
              <input id="kodeDusunField" class="form-control" placeholder="Kode Dusun (generated)" readonly>
              <button class="btn btn-outline-secondary" id="copyKodeBtn" title="Copy Kode">Copy</button>
            </div>
            <div class="d-grid gap-2">
              <button id="generateBtn" class="btn btn-primary" onclick="generateKode()">Generate Kode</button>
              <button id="saveDusunBtn" class="btn btn-success hidden" onclick="simpanDusun()">Simpan Dusun</button>
            </div>
            <div class="small-muted mt-2">Setelah generate, salin kode dan bagikan ke warga. Kepala Dusun juga akan melihat kode ini di dashboard-nya.</div>
          </div>
        </div>

        <!-- Right: Daftar / Login -->
        <div class="col-md-6">
          <h5>Daftar Warga</h5>
          <div class="mb-2">
            <input id="namaWarga" class="form-control mb-2" placeholder="Nama Lengkap">
            <input id="noHpDaftar" class="form-control mb-2" placeholder="No HP">
            <input id="alamat" class="form-control mb-2" placeholder="Alamat (Jalan)">
            <input id="blok" class="form-control mb-2" placeholder="Blok (opsional)">
            <input id="nomor" class="form-control mb-2" placeholder="No Rumah (opsional)">
            <div class="row g-2 mb-2">
              <div class="col"><input id="rt" class="form-control" placeholder="RT"></div>
              <div class="col"><input id="rw" class="form-control" placeholder="RW"></div>
            </div>
            <select id="roleWarga" class="form-control mb-2">
              <option value="kepala_desa">Kepala Desa</option>
              <option value="kepala_dusun">Kepala Dusun</option>
              <option value="ketua_rt">Ketua RT</option>
              <option value="ketua_rw">Ketua RW</option>
              <option value="kepala_keluarga">Kepala Keluarga</option>
              <option value="istri">Istri</option>
              <option value="anak">Anak</option>
              <option value="lainnya">Lainnya</option>
            </select>
            <input id="kodeDusunInput" class="form-control mb-2" placeholder="Kode Dusun (dapat dari Kepala Dusun)">
            <input id="passwordDaftar" type="password" class="form-control mb-2" placeholder="Password">
            <div class="d-grid gap-2">
              <button class="btn btn-success" onclick="daftarWarga()">Daftar</button>
              <button class="btn btn-outline-secondary" onclick="clearRegister()">Reset Form</button>
            </div>
          </div>

          <hr>

          <h5>Login</h5>
          <div>
            <input id="noHpLogin" class="form-control mb-2" placeholder="No HP">
            <input id="passwordLogin" type="password" class="form-control mb-2" placeholder="Password">
            <div class="d-grid gap-2">
              <button class="btn btn-primary" onclick="login()">Login</button>
            </div>
            <div class="small-muted mt-2">Catatan: pendaftaran menggunakan <b>Kode Dusun</b> dari Kepala Dusun.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboardCard" class="card p-3 hidden">
      <div class="d-flex justify-content-between align-items-start">
        <div>
          <h4 id="dashTitle">Dashboard Dusun</h4>
          <div class="small-muted">Selamat datang, <b id="userName"></b> · <span id="realtimeClock"></span></div>
        </div>
        <div class="text-end">
          <button class="btn btn-danger btn-sm" onclick="logout()">Logout</button>
        </div>
      </div>

      <!-- Kode dusun only for kepala_dusun -->
      <div id="kodeDashboard" class="card p-3 mt-3 d-none">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <div class="small-muted">Kode Dusun</div>
            <h5 id="profileKode"></h5>
          </div>
          <div>
            <div class="small-muted">Sisa waktu pergantian</div>
            <div id="profileCountdown" style="font-weight:600"></div>
          </div>
        </div>
      </div>

      <div class="row g-3 mt-3">
        <div class="col-lg-5">
          <!-- Laporan SOS -->
          <div class="card p-3 mb-3">
            <h6>Buat Laporan SOS</h6>
            <select id="jenisKejadian" class="form-control mb-2">
              <option value="Kemalingan">Kemalingan</option>
              <option value="Kebakaran">Kebakaran</option>
              <option value="Medis">Medis</option>
              <option value="Ambulance">Ambulance</option>
              <option value="Mencurigakan">Mencurigakan</option>
            </select>
            <select id="lokasiOption" class="form-control mb-2" onchange="toggleLokasi()">
              <option value="saat_ini">Lokasi Saat Ini</option>
              <option value="lainnya">Lokasi Lain</option>
            </select>
            <textarea id="lokasiDesc" class="form-control mb-2 hidden" placeholder="Deskripsi lokasi (opsional)"></textarea>
            <div class="d-grid">
              <button class="btn btn-danger" onclick="kirimLaporan()">Kirim Laporan</button>
            </div>
          </div>

          <!-- Statistik -->
          <div class="card p-3 mb-3">
            <h6>Statistik Kejadian</h6>
            <canvas id="chartKejadian"></canvas>
          </div>

          <div class="card p-3 mb-3">
            <h6>Daftar Laporan Terbaru</h6>
            <div id="listLaporan"></div>
          </div>
        </div>

        <div class="col-lg-7">
          <!-- Map & Pos -->
          <div class="card p-3 mb-3">
            <h6>Pos Jaga Dusun</h6>
            <div id="map" class="mb-3">Memuat peta...</div>
            <div class="d-flex gap-2">
              <button class="btn btn-primary" onclick="promptTambahPos()">Tambah Pos RT</button>
              <button class="btn btn-outline-secondary" onclick="loadPosJaga()">Muat Ulang Pos</button>
            </div>
            <div id="listPos" class="mt-3"></div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Google Maps (ganti key di bawah) -->
<script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY"></script>

<script>
/* ========== Firebase init ========== */
const firebaseConfig = {
  apiKey: "AIzaSyA6GAeIc7ZesIed9MAelUf6x_sBFdp9E-Q",
  authDomain: "dusun-super.firebaseapp.com",
  projectId: "dusun-super",
  storageBucket: "dusun-super.firebasestorage.app",
  messagingSenderId: "1083284057385",
  appId: "1:1083284057385:web:21cfe467b047bb5a241b38",
  measurementId: "G-LJ6KP57Q9M"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ========== State ========== */
let currentUser = null;       // object user setelah login
let currentDusunId = null;    // id doc dusun user
let map = null;
let markers = [];
let chart = null;
let kodeWatcherUnsub = null;
let kodeCountdownInterval = null;

/* ========= Utilities ========= */
function $(id){ return document.getElementById(id); }
function showToast(text){ alert(text); }

/* ========= Generate & Save Dusun ========= */
function generateKode(){
  const code = "DSN" + Math.random().toString(36).substring(2,8).toUpperCase();
  $('kodeDusunField').value = code;
  $('kodeGroup').classList.remove('d-none');
  $('generateBtn').classList.add('hidden');
  $('saveDusunBtn').classList.remove('hidden');
}
$('copyKodeBtn').addEventListener('click', ()=>{
  const val = $('kodeDusunField').value;
  if(!val) return showToast("Belum ada kode untuk disalin.");
  navigator.clipboard?.writeText(val).then(()=> showToast("Kode disalin ke clipboard."));
});

async function simpanDusun(){
  const nama = $('namaDusun').value.trim();
  const desa = $('desa').value.trim();
  const kota = $('kota').value.trim();
  const kab = $('kabupaten').value.trim();
  const kec = $('kecamatan').value.trim();
  const code = $('kodeDusunField').value.trim();
  if(!nama || !desa || !kota || !kab || !kec || !code) return showToast("Lengkapi semua field & generate kode.");

  const codeExpiresAt = Date.now() + 3600000; // 1 jam
  try{
    const docRef = await db.collection('dusun').add({
      nama, desa, kota, kabupaten: kab, kecamatan: kec,
      code, codeExpiresAt, createdAt: Date.now()
    });
    showToast("Dusun tersimpan. Kode: " + code);
    // reset UI
    $('generateBtn').classList.remove('hidden');
    $('saveDusunBtn').classList.add('hidden');
    // leave kode field visible so kepala dusun bisa copy
    // advise user to register as kepala_dusun with the code
  }catch(e){
    console.error(e);
    showToast("Gagal menyimpan dusun: " + e.message);
  }
}

/* ========= Registration (users stored in Firestore) ========= */
async function daftarWarga(){
  const nama = $('namaWarga').value.trim();
  const noHp = $('noHpDaftar').value.trim();
  const alamat = $('alamat').value.trim();
  const blok = $('blok').value.trim();
  const nomor = $('nomor').value.trim();
  const rt = $('rt').value.trim();
  const rw = $('rw').value.trim();
  const role = $('roleWarga').value;
  const kode = $('kodeDusunInput').value.trim();
  const pass = $('passwordDaftar').value;
  if(!nama||!noHp||!alamat||!rt||!rw||!role||!kode||!pass) return showToast("Lengkapi field wajib.");

  // verify kode dusun
  const q = await db.collection('dusun').where('code','==',kode).get();
  if(q.empty) return showToast("Kode dusun tidak valid. Pastikan kode terbaru dari Kepala Dusun.");
  const dusunDoc = q.docs[0];
  const dusunId = dusunDoc.id;

  // store user with doc id = phone (or auto id)
  try{
    await db.collection('users').doc(noHp).set({
      nama, noHp, alamat, blok, nomor, rt, rw, role, dusunId, password: pass, createdAt: Date.now()
    });
    showToast("Pendaftaran berhasil. Silakan login.");
    // clear fields
    $('namaWarga').value=''; $('noHpDaftar').value=''; $('alamat').value=''; $('blok').value='';
    $('nomor').value=''; $('rt').value=''; $('rw').value=''; $('kodeDusunInput').value=''; $('passwordDaftar').value='';
  }catch(e){
    console.error(e);
    showToast("Gagal mendaftar: " + e.message);
  }
}
function clearRegister(){
  $('namaWarga').value=''; $('noHpDaftar').value=''; $('alamat').value=''; $('blok').value='';
  $('nomor').value=''; $('rt').value=''; $('rw').value=''; $('kodeDusunInput').value=''; $('passwordDaftar').value='';
}

/* ========= Login ========= */
async function login(){
  const noHp = $('noHpLogin').value.trim();
  const pass = $('passwordLogin').value;
  if(!noHp||!pass) return showToast("Masukkan No HP & Password");

  const doc = await db.collection('users').doc(noHp).get();
  if(!doc.exists) return showToast("User tidak ditemukan");
  const user = doc.data();
  if(user.password !== pass) return showToast("Password salah");
  currentUser = { id: doc.id, ...user };
  currentDusunId = user.dusunId || null;

  // show dashboard
  document.querySelector('#authCard').classList.add('hidden');
  document.querySelector('#dashboardCard').classList.remove('hidden');
  $('userName').innerText = currentUser.nama || currentUser.noHp;

  // realtime clock
  startClock();

  // if kepala_dusun -> show kode & start watcher
  if(currentUser.role === 'kepala_dusun'){
    $('kodeDashboard').classList.remove('d-none');
    // find the dusun doc (we have dusunId)
    if(currentDusunId){
      startKodeListener(currentDusunId, true);
    } else {
      // try to find dusun by matching code in user doc (if we stored kode there)
      showToast("Anda terdaftar sebagai Kepala Dusun tetapi tidak terikat ke dusun. Pastikan mendaftar dengan kode dusun yang dibuat.");
    }
  } else {
    $('kodeDashboard').classList.add('d-none');
  }

  // load map, laporan, chart
  waitForMapsThenInit();
  loadPosJaga();
  loadLaporanAndChart();

  // listen laporan changes for this dusun realtime
  if(currentDusunId){
    db.collection('laporan').where('dusunId','==',currentDusunId)
      .onSnapshot(()=> loadLaporanAndChart());
  }
}

/* ========= Logout ========= */
function logout(){
  currentUser = null;
  currentDusunId = null;
  // remove listeners
  if(kodeWatcherUnsub){ kodeWatcherUnsub(); kodeWatcherUnsub = null; }
  if(kodeCountdownInterval){ clearInterval(kodeCountdownInterval); kodeCountdownInterval = null; }
  // reset UI
  document.querySelector('#authCard').classList.remove('hidden');
  document.querySelector('#dashboardCard').classList.add('hidden');
}

/* ========= Clock ========= */
function startClock(){
  setInterval(()=>{
    const now = new Date();
    $('realtimeClock').innerText = now.toLocaleString('id-ID', { weekday:'long', year:'numeric', month:'long', day:'numeric', hour:'2-digit', minute:'2-digit', second:'2-digit' });
  },1000);
}

/* ========= Laporan SOS ========= */
function toggleLokasi(){
  const v = $('lokasiOption')?.value;
  if(v === 'lainnya') $('lokasiDesc').classList.remove('hidden'); else $('lokasiDesc').classList.add('hidden');
}
async function kirimLaporan(){
  if(!currentUser) return showToast("Login dulu untuk lapor.");
  const kejadian = $('jenisKejadian').value;
  const lokasiOpt = $('lokasiOption').value;
  const lokasi = lokasiOpt === 'lainnya' ? $('lokasiDesc').value.trim() : 'Lokasi Saat Ini';
  if(!kejadian) return showToast("Pilih jenis kejadian");
  try{
    await db.collection('laporan').add({
      dusunId: currentDusunId,
      uid: currentUser.id,
      kejadian, lokasi, createdAt: Date.now()
    });
    showToast("Laporan terkirim.");
    $('lokasiDesc').value='';
  }catch(e){ console.error(e); showToast("Gagal kirim laporan: " + e.message); }
}

/* ========= Load laporan & render chart ========= */
async function loadLaporanAndChart(){
  if(!currentDusunId) return;
  const snap = await db.collection('laporan').where('dusunId','==',currentDusunId).orderBy('createdAt','desc').limit(100).get();
  const reports = snap.docs.map(d => ({ id:d.id, ...d.data() }));
  // list
  const list = $('listLaporan'); list.innerHTML = '';
  if(reports.length === 0) list.innerHTML = '<div class="small-muted">Belum ada laporan.</div>';
  reports.slice(0,20).forEach(r => {
    const dt = new Date(r.createdAt).toLocaleString();
    const el = document.createElement('div'); el.className='mb-2';
    el.innerHTML = `<div><b>${r.kejadian}</b> — ${r.lokasi || ''}</div><div class="small-muted">${dt}</div>`;
    list.appendChild(el);
  });
  // chart
  const counts = {};
  reports.forEach(r => counts[r.kejadian] = (counts[r.kejadian]||0)+1);
  const labels = Object.keys(counts).length ? Object.keys(counts) : ['Tidak ada'];
  const data = labels.map(l => counts[l] || 0);
  if(chart) chart.destroy();
  const ctx = document.getElementById('chartKejadian').getContext('2d');
  chart = new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets: [{ label:'Jumlah', data, backgroundColor: labels.map((_,i)=>['#36a2eb','#ff6384','#ffce56','#4caf50','#9c27b0'][i%5]) }] },
    options: { responsive:true, plugins:{ legend:{ display:false } } }
  });
}

/* ========= Google Maps & Pos Jaga ========= */
function waitForMapsThenInit(){
  if(window.google && window.google.maps && !map){
    map = new google.maps.Map(document.getElementById('map'), { center:{lat:-6.200000, lng:106.816666}, zoom:12 });
  }
  if(!map){
    setTimeout(waitForMapsThenInit, 500);
  }
}
async function loadPosJaga(){
  waitForMapsThenInit();
  // clear markers
  markers.forEach(m=>m.setMap(null)); markers = [];
  $('listPos').innerHTML = '';
  if(!currentDusunId) return;
  const snap = await db.collection('dusun').doc(currentDusunId).collection('posJaga').get();
  if(snap.empty) { $('listPos').innerHTML = '<div class="small-muted">Belum ada pos jaga.</div>'; return; }
  const bounds = new google.maps.LatLngBounds();
  snap.forEach(doc=>{
    const p = doc.data();
    const el = document.createElement('div'); el.className='mb-2'; el.innerText = `${p.nama} — Lat:${p.lat}, Lng:${p.lng}`;
    $('listPos').appendChild(el);
    if(map && p.lat && p.lng){
      const marker = new google.maps.Marker({ position:{lat:p.lat, lng:p.lng}, map, title:p.nama });
      markers.push(marker);
      bounds.extend(marker.getPosition());
    }
  });
  if(markers.length) map.fitBounds(bounds);
}
async function promptTambahPos(){
  if(!currentUser) return showToast("Login dulu.");
  const nama = prompt("Nama pos (contoh: Pos RT 01)");
  if(!nama) return;
  const lat = parseFloat(prompt("Latitude (contoh -6.200)"));
  const lng = parseFloat(prompt("Longitude (contoh 106.816)"));
  if(Number.isNaN(lat) || Number.isNaN(lng)) return showToast("Koordinat tidak valid.");
  try{
    await db.collection('dusun').doc(currentDusunId).collection('posJaga').add({ nama, lat, lng, createdAt: Date.now() });
    showToast("Pos tersimpan.");
    loadPosJaga();
  }catch(e){ console.error(e); showToast("Gagal simpan pos: " + e.message); }
}

/* ========= Kode watcher + auto rotate jika kepala_dusun =========
   - Jika current user kepala_dusun, pas login kita listen dokumen dusun,
     tampilkan code & countdown; jika expired, kita buat kode baru dan update Firestore.
*/
function startKodeListener(dusunId, amIKepalaDusun){
  // unsubscribe existing
  if(kodeWatcherUnsub){ kodeWatcherUnsub(); kodeWatcherUnsub = null; }
  const ref = db.collection('dusun').doc(dusunId);
  kodeWatcherUnsub = ref.onSnapshot(async snap=>{
    if(!snap.exists) return;
    const data = snap.data();
    const code = data.code || '';
    const expires = data.codeExpiresAt || 0;
    $('profileKode').innerText = code;
    // show code in create form too so kepala dusun can copy later
    $('kodeGroup').classList.remove('d-none');
    $('kodeDusunField').value = code;
    // start countdown timer
    if(kodeCountdownInterval) clearInterval(kodeCountdownInterval);
    kodeCountdownInterval = setInterval(async ()=>{
      const now = Date.now();
      const remaining = Math.max(0, Math.floor((expires - now) / 1000));
      const hh = Math.floor(remaining/3600);
      const mm = Math.floor((remaining%3600)/60);
      const ss = remaining%60;
      $('profileCountdown').innerText = `${hh}h ${mm}m ${ss}s`;
      $('countdownTimer')?.innerText = `${hh}h ${mm}m ${ss}s`;
      if(remaining <= 0){
        // expired -> if kepala dusun, rotate code
        if(amIKepalaDusun && currentUser && currentUser.role==='kepala_dusun'){
          const newCode = "DSN" + Math.random().toString(36).substring(2,8).toUpperCase();
          const newExpires = Date.now() + 3600000;
          try{
            await ref.update({ code: newCode, codeExpiresAt: newExpires });
            // the onSnapshot will pick up new values and update UI
          }catch(e){ console.error("Gagal update kode:", e); }
        }
      }
    }, 1000);
  });
}

/* ========= On load: nothing to do ========= */
window.addEventListener('load', ()=>{
  // nothing — UI waits for user actions
});
</script>
</body>
</html>
