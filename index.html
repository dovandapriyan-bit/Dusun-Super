<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Sistem Keamanan Dusun</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, getDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA6GAeIc7ZesIed9MAelUf6x_sBFdp9E-Q",
      authDomain: "dusun-super.firebaseapp.com",
      projectId: "dusun-super",
      storageBucket: "dusun-super.firebasestorage.app",
      messagingSenderId: "1083284057385",
      appId: "1:1083284057385:web:21cfe467b047bb5a241b38",
      measurementId: "G-LJ6KP57Q9M"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ==== GENERATE CODE ====
    function generateCode(length=6){
      const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
      let code = "";
      for(let i=0;i<length;i++){
        code += chars.charAt(Math.floor(Math.random()*chars.length));
      }
      return code;
    }

    // ==== BUAT DUSUN ====
    async function createDusun(){
      const nama = document.getElementById("dusunNama").value.trim();
      const kota = document.getElementById("dusunKota").value.trim();
      const kab  = document.getElementById("dusunKab").value.trim();
      const kec  = document.getElementById("dusunKec").value.trim();

      if(!nama || !kota || !kab || !kec) return alert("Lengkapi semua field!");

      // generate kode dan tampilkan
      const code = generateCode();
      document.getElementById("dusunCode").value = code;

      // ubah tombol jadi "Simpan"
      document.getElementById("btnBuatDusun").style.display = "none";
      document.getElementById("btnSimpanDusun").style.display = "block";
    }

    async function simpanDusun(){
      const nama = document.getElementById("dusunNama").value.trim();
      const kota = document.getElementById("dusunKota").value.trim();
      const kab  = document.getElementById("dusunKab").value.trim();
      const kec  = document.getElementById("dusunKec").value.trim();
      const code = document.getElementById("dusunCode").value.trim();

      const ref = doc(collection(db,"dusun"));
      await setDoc(ref,{
        namaDusun:nama,
        kota:kota,
        kabupaten:kab,
        kecamatan:kec,
        code:code
      });

      sessionStorage.setItem("joinDusunCode", code);
      alert("Dusun berhasil dibuat dengan kode: " + code);
      showAuth(); // langsung arahkan ke login
    }

    // ==== REGISTER ====
    async function registerUser(){
      const nama = document.getElementById("regNama").value.trim();
      const hp   = document.getElementById("regHp").value.trim();
      const kode = document.getElementById("regKode").value.trim();

      if(!nama || !hp || !kode) return alert("Lengkapi semua field!");

      const q = query(collection(db,"dusun"), where("code","==",kode));
      const snap = await getDocs(q);
      if(snap.empty) return alert("Kode dusun tidak valid!");

      const dusunDoc = snap.docs[0];
      const dusunId = dusunDoc.id;

      await setDoc(doc(db,"users",hp),{
        nama:nama,
        hp:hp,
        dusunId:dusunId
      });

      sessionStorage.setItem("uid", hp);
      sessionStorage.setItem("dusunId", dusunId);

      alert("Pendaftaran berhasil!");
      showDashboard();
    }

    // ==== LOGIN ====
    async function loginUser(){
      const hp   = document.getElementById("loginHp").value.trim();
      const kode = document.getElementById("loginKode").value.trim();

      if(!hp || !kode) return alert("Isi nomor HP dan kode dusun!");

      const userRef = doc(db,"users",hp);
      const userSnap = await getDoc(userRef);
      if(!userSnap.exists()) return alert("User tidak ditemukan!");

      const userData = userSnap.data();
      const q = query(collection(db,"dusun"), where("code","==",kode));
      const snap = await getDocs(q);
      if(snap.empty) return alert("Kode dusun salah!");

      const dusunDoc = snap.docs[0];
      const dusunId = dusunDoc.id;

      if(userData.dusunId !== dusunId){
        return alert("Kode dusun tidak sesuai dengan akun Anda!");
      }

      sessionStorage.setItem("uid", hp);
      sessionStorage.setItem("dusunId", dusunId);

      alert("Login berhasil!");
      showDashboard();
    }

    // ==== UI ====
    function showSection(id){
      ["buatDusun","authSection","dashboard"].forEach(s=>document.getElementById(s).classList.add("d-none"));
      document.getElementById(id).classList.remove("d-none");
    }
    function showCreateDusun(){ showSection("buatDusun"); }
    function showAuth(){ 
      document.getElementById("regKode").value = sessionStorage.getItem("joinDusunCode") || "";
      document.getElementById("loginKode").value = sessionStorage.getItem("joinDusunCode") || "";
      showSection("authSection"); 
    }
    function showDashboard(){
      showSection("dashboard");
      document.getElementById("userInfo").innerText =
        "Selamat datang, UID: " + sessionStorage.getItem("uid") + 
        " | Dusun ID: " + sessionStorage.getItem("dusunId");
    }

    window.createDusun = createDusun;
    window.simpanDusun = simpanDusun;
    window.registerUser = registerUser;
    window.loginUser = loginUser;
    window.showCreateDusun = showCreateDusun;
    window.showAuth = showAuth;
  </script>
</head>
<body class="bg-light p-4">

  <div class="container">
    <h2 class="mb-4 text-center">üåê Sistem Keamanan Dusun</h2>
    <div class="text-center mb-3">
      <button class="btn btn-success me-2" onclick="showCreateDusun()">Buat Dusun</button>
      <button class="btn btn-primary" onclick="showAuth()">Login / Daftar</button>
    </div>

    <!-- BUAT DUSUN -->
    <div id="buatDusun" class="card p-4 d-none">
      <h4 class="mb-3">Buat Dusun Baru</h4>
      <input id="dusunNama" class="form-control mb-2" placeholder="Nama Dusun">
      <input id="dusunKota" class="form-control mb-2" placeholder="Kota">
      <input id="dusunKab" class="form-control mb-2" placeholder="Kabupaten">
      <input id="dusunKec" class="form-control mb-2" placeholder="Kecamatan">
      <input id="dusunCode" class="form-control mb-2" placeholder="Kode Dusun" readonly>
      <button id="btnBuatDusun" class="btn btn-warning w-100" onclick="createDusun()">Generate Kode</button>
      <button id="btnSimpanDusun" class="btn btn-success w-100 d-none" onclick="simpanDusun()">Simpan</button>
    </div>

    <!-- LOGIN / REGISTER -->
    <div id="authSection" class="card p-4 d-none">
      <h4 class="mb-3">Daftar Warga</h4>
      <input id="regNama" class="form-control mb-2" placeholder="Nama">
      <input id="regHp" class="form-control mb-2" placeholder="Nomor HP">
      <input id="regKode" class="form-control mb-2" placeholder="Kode Dusun">
      <button class="btn btn-success w-100 mb-3" onclick="registerUser()">Daftar</button>

      <h4 class="mb-3">Login</h4>
      <input id="loginHp" class="form-control mb-2" placeholder="Nomor HP">
      <input id="loginKode" class="form-control mb-2" placeholder="Kode Dusun">
      <button class="btn btn-primary w-100" onclick="loginUser()">Login</button>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard" class="card p-4 d-none">
      <h4>Dashboard</h4>
      <p id="userInfo"></p>
      <button class="btn btn-danger" onclick="sessionStorage.clear(); location.reload();">Logout</button>
    </div>
  </div>

</body>
</html>
