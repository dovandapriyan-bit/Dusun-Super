<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistem Keamanan Dusun</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-messaging.js"></script>
  <style>
    body {
      margin: 0; padding: 0;
      font-family: sans-serif;
      min-height: 100vh;
      background: linear-gradient(to bottom right, #dbeafe, #ffffff, #f0f9ff);
      color: #111;
    }
    .card {
      background: #fff;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      max-width: 400px;
      margin: 20px auto;
    }
    .btn {
      display: block;
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
    }
    .btn-blue { background: #2563eb; color:#fff; }
    .btn-red { background: #dc2626; color:#fff; }
    .btn-green { background: #16a34a; color:#fff; }
    .btn-yellow { background: #ca8a04; color:#fff; }
    .hidden { display: none; }
    h2 { text-align:center; color:#1e3a8a; }
    input, select {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    .list-item {
      background:#f9fafb;
      border:1px solid #e5e7eb;
      border-radius:8px;
      padding:10px;
      margin:5px 0;
    }
  </style>
</head>
<body>

  <!-- LOGIN -->
  <div id="loginPage" class="card">
    <h2>Login Warga</h2>
    <input id="email" type="email" placeholder="Email">
    <input id="password" type="password" placeholder="Password">
    <button class="btn btn-blue" onclick="login()">Login</button>
    <p style="text-align:center;">Belum punya akun? <a href="#" onclick="showRegister()">Daftar</a></p>
  </div>

  <!-- REGISTER -->
  <div id="registerPage" class="card hidden">
    <h2>Daftar Warga</h2>
    <input id="regEmail" type="email" placeholder="Email">
    <input id="regPassword" type="password" placeholder="Password">
    <input id="regName" type="text" placeholder="Nama Lengkap">
    <input id="regRT" type="text" placeholder="RT">
    <input id="regRW" type="text" placeholder="RW">
    <input id="regBlock" type="text" placeholder="Blok / Nomor Rumah">
    <input id="regDusunCode" type="text" placeholder="Kode Dusun">
    <input id="regPhoto" type="file" accept="image/*">
    <button class="btn btn-green" onclick="register()">Daftar</button>
    <p style="text-align:center;"><a href="#" onclick="showLogin()">Sudah punya akun? Login</a></p>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboard" class="card hidden">
    <h2>Dashboard Dusun</h2>
    <p id="welcome"></p>
    <button class="btn btn-red" onclick="sendSOS('Kemalingan')">ðŸš¨ Kemalingan</button>
    <button class="btn btn-yellow" onclick="sendSOS('Kebakaran')">ðŸ”¥ Kebakaran</button>
    <button class="btn btn-green" onclick="sendSOS('Medis')">ðŸ’Š Medis</button>
    <button class="btn btn-blue" onclick="sendSOS('Ambulance')">ðŸš‘ Ambulance</button>
    <h3>Laporan Masuk</h3>
    <div id="sosList"></div>
    <button class="btn btn-blue" onclick="logout()">Logout</button>
  </div>

  <script>
    // Firebase config (jangan dirubah tanpa perintahmu)
    const firebaseConfig = {
      apiKey: "AIzaSyA6GAeIc7ZesIed9MAelUf6x_sBFdp9E-Q",
      authDomain: "dusun-super.firebaseapp.com",
      projectId: "dusun-super",
      storageBucket: "dusun-super.firebasestorage.app",
      messagingSenderId: "1083284057385",
      appId: "1:1083284057385:web:21cfe467b047bb5a241b38",
      measurementId: "G-LJ6KP57Q9M"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // NAVIGATION
    function showRegister() {
      document.getElementById("loginPage").classList.add("hidden");
      document.getElementById("registerPage").classList.remove("hidden");
    }
    function showLogin() {
      document.getElementById("registerPage").classList.add("hidden");
      document.getElementById("loginPage").classList.remove("hidden");
    }

    // REGISTER
    async function register() {
      const email = document.getElementById("regEmail").value;
      const password = document.getElementById("regPassword").value;
      const name = document.getElementById("regName").value;
      const rt = document.getElementById("regRT").value;
      const rw = document.getElementById("regRW").value;
      const block = document.getElementById("regBlock").value;
      const dusunCode = document.getElementById("regDusunCode").value;

      try {
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        const uid = userCredential.user.uid;
        await db.collection("warga").doc(uid).set({
          email, name, rt, rw, block, dusunCode, role: "warga", verified: false, createdAt: new Date()
        });
        alert("Registrasi berhasil, menunggu verifikasi kepala keluarga.");
        showLogin();
      } catch (error) {
        alert(error.message);
      }
    }

    // LOGIN
    async function login() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      try {
        await auth.signInWithEmailAndPassword(email, password);
        document.getElementById("loginPage").classList.add("hidden");
        document.getElementById("dashboard").classList.remove("hidden");
        const user = auth.currentUser;
        document.getElementById("welcome").innerText = "Selamat datang, " + user.email;
        listenSOS();
      } catch (error) {
        alert(error.message);
      }
    }

    // LOGOUT
    async function logout() {
      await auth.signOut();
      document.getElementById("dashboard").classList.add("hidden");
      document.getElementById("loginPage").classList.remove("hidden");
    }

    // SEND SOS
    async function sendSOS(type) {
      const user = auth.currentUser;
      if (!user) return;
      const wargaDoc = await db.collection("warga").doc(user.uid).get();
      const data = wargaDoc.data();
      await db.collection("sos").add({
        uid: user.uid,
        name: data.name,
        rt: data.rt,
        rw: data.rw,
        dusunCode: data.dusunCode,
        type,
        responders: [],
        status: "open",
        createdAt: new Date()
      });
      alert("SOS terkirim: " + type);
    }

    // LISTEN SOS
    function listenSOS() {
      const user = auth.currentUser;
      if (!user) return;
      db.collection("sos").orderBy("createdAt", "desc").onSnapshot(snapshot => {
        const sosList = document.getElementById("sosList");
        sosList.innerHTML = "";
        snapshot.forEach(doc => {
          const data = doc.data();
          const div = document.createElement("div");
          div.className = "list-item";
          div.innerHTML = `<b>${data.type}</b> oleh ${data.name} (RT ${data.rt}/RW ${data.rw})<br>
                           Status: ${data.status}<br>
                           Respon: ${(data.responders || []).join(", ")}<br>
                           <button onclick="respondSOS('${doc.id}')">Respon</button>`;
          sosList.appendChild(div);
        });
      });
    }

    // RESPOND SOS
    async function respondSOS(id) {
      const user = auth.currentUser;
      const docRef = db.collection("sos").doc(id);
      const docSnap = await docRef.get();
      const data = docSnap.data();
      const responders = data.responders || [];
      if (!responders.includes(user.email)) {
        responders.push(user.email);
        await docRef.update({ responders });
      }
    }
  </script>
</body>
</html>
