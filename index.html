<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Aplikasi Keamanan Dusun</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, getDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA6GAeIc7ZesIed9MAelUf6x_sBFdp9E-Q",
      authDomain: "dusun-super.firebaseapp.com",
      projectId: "dusun-super",
      storageBucket: "dusun-super.firebasestorage.app",
      messagingSenderId: "1083284057385",
      appId: "1:1083284057385:web:21cfe467b047bb5a241b38",
      measurementId: "G-LJ6KP57Q9M"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ==== GENERATE CODE UNIK ====
    function generateCode(length=6){
      const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
      let code = "";
      for(let i=0;i<length;i++){
        code += chars.charAt(Math.floor(Math.random()*chars.length));
      }
      return code;
    }

    // ==== BUAT DUSUN ====
    async function createDusun(){
      const nama = document.getElementById("dusunNama").value.trim();
      const kota = document.getElementById("dusunKota").value.trim();
      const kab  = document.getElementById("dusunKab").value.trim();
      const kec  = document.getElementById("dusunKec").value.trim();

      if(!nama || !kota || !kab || !kec) return alert("Lengkapi semua field!");

      const code = generateCode();

      const ref = doc(collection(db,"dusun"));
      await setDoc(ref,{
        namaDusun:nama,
        kota:kota,
        kabupaten:kab,
        kecamatan:kec,
        code:code
      });

      alert("Dusun berhasil dibuat! Kode: " + code);
      // simpan kode sementara untuk gabung
      sessionStorage.setItem("newDusunCode", code);
      showJoinDusun();
    }

    // ==== GABUNG DUSUN ====
    async function joinDusun(){
      const code = document.getElementById("dusunCodeJoin").value.trim();
      if(!code) return alert("Masukkan kode dusun!");

      const q = query(collection(db,"dusun"), where("code","==",code));
      const snap = await getDocs(q);
      if(snap.empty) return alert("Kode dusun tidak ditemukan!");

      sessionStorage.setItem("joinDusunCode", code);
      alert("Kode valid! Silakan login atau daftar.");
      showAuth(); // alihkan ke login/daftar
    }

    // ==== REGISTER USER ====
    async function registerUser(){
      const nama = document.getElementById("regNama").value.trim();
      const hp   = document.getElementById("regHp").value.trim();
      const kode = document.getElementById("regKode").value.trim();

      if(!nama || !hp || !kode) return alert("Lengkapi semua field!");

      const q = query(collection(db,"dusun"), where("code","==",kode));
      const snap = await getDocs(q);
      if(snap.empty) return alert("Kode dusun tidak valid!");

      const dusunDoc = snap.docs[0];
      const dusunId = dusunDoc.id;

      await setDoc(doc(db,"users",hp),{
        nama:nama,
        hp:hp,
        dusunId:dusunId
      });

      sessionStorage.setItem("uid", hp);
      sessionStorage.setItem("dusunId", dusunId);

      alert("Pendaftaran berhasil!");
      showDashboard();
    }

    // ==== LOGIN USER ====
    async function loginUser(){
      const hp   = document.getElementById("loginHp").value.trim();
      const kode = document.getElementById("loginKode").value.trim();

      if(!hp || !kode) return alert("Isi nomor HP dan kode dusun!");

      const userRef = doc(db,"users",hp);
      const userSnap = await getDoc(userRef);
      if(!userSnap.exists()) return alert("User tidak ditemukan!");

      const userData = userSnap.data();

      const q = query(collection(db,"dusun"), where("code","==",kode));
      const snap = await getDocs(q);
      if(snap.empty) return alert("Kode dusun salah!");

      const dusunDoc = snap.docs[0];
      const dusunId = dusunDoc.id;

      if(userData.dusunId !== dusunId){
        return alert("Kode dusun tidak sesuai dengan akun Anda!");
      }

      sessionStorage.setItem("uid", hp);
      sessionStorage.setItem("dusunId", dusunId);

      alert("Login berhasil!");
      showDashboard();
    }

    // ==== UI HANDLER ====
    function showSection(id){
      document.getElementById("buatDusun").style.display="none";
      document.getElementById("gabungDusun").style.display="none";
      document.getElementById("authSection").style.display="none";
      document.getElementById("dashboard").style.display="none";
      document.getElementById(id).style.display="block";
    }
    function showCreateDusun(){ showSection("buatDusun"); }
    function showJoinDusun(){
      document.getElementById("dusunCodeJoin").value = sessionStorage.getItem("newDusunCode") || "";
      showSection("gabungDusun");
    }
    function showAuth(){ 
      document.getElementById("regKode").value = sessionStorage.getItem("joinDusunCode") || "";
      document.getElementById("loginKode").value = sessionStorage.getItem("joinDusunCode") || "";
      showSection("authSection"); 
    }
    function showDashboard(){
      showSection("dashboard");
      document.getElementById("userInfo").innerText =
        "Selamat datang, UID: " + sessionStorage.getItem("uid") + 
        " | Dusun ID: " + sessionStorage.getItem("dusunId");
    }

    window.createDusun = createDusun;
    window.joinDusun = joinDusun;
    window.registerUser = registerUser;
    window.loginUser = loginUser;
    window.showCreateDusun = showCreateDusun;
    window.showJoinDusun = showJoinDusun;
    window.showAuth = showAuth;
  </script>
</head>
<body>
  <h2>Aplikasi Keamanan Dusun</h2>

  <button onclick="showCreateDusun()">Buat Dusun</button>
  <button onclick="showJoinDusun()">Gabung Dusun</button>

  <!-- BUAT DUSUN -->
  <div id="buatDusun" style="display:none;">
    <h3>Buat Dusun</h3>
    <input id="dusunNama" placeholder="Nama Dusun"><br>
    <input id="dusunKota" placeholder="Kota"><br>
    <input id="dusunKab" placeholder="Kabupaten"><br>
    <input id="dusunKec" placeholder="Kecamatan"><br>
    <button onclick="createDusun()">Simpan</button>
  </div>

  <!-- GABUNG DUSUN -->
  <div id="gabungDusun" style="display:none;">
    <h3>Gabung Dusun</h3>
    <input id="dusunCodeJoin" placeholder="Kode Dusun"><br>
    <button onclick="joinDusun()">Gabung</button>
  </div>

  <!-- LOGIN & REGISTER -->
  <div id="authSection" style="display:none;">
    <h3>Daftar</h3>
    <input id="regNama" placeholder="Nama"><br>
    <input id="regHp" placeholder="No HP"><br>
    <input id="regKode" placeholder="Kode Dusun"><br>
    <button onclick="registerUser()">Daftar</button>

    <h3>Login</h3>
    <input id="loginHp" placeholder="No HP"><br>
    <input id="loginKode" placeholder="Kode Dusun"><br>
    <button onclick="loginUser()">Login</button>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboard" style="display:none;">
    <h3>Dashboard</h3>
    <p id="userInfo"></p>
    <button onclick="sessionStorage.clear(); location.reload();">Logout</button>
  </div>
</body>
</html>
