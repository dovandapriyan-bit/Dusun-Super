<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <title>Sistem Keamanan Dusun — Full</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    :root{
      --card-radius:12px;
      --accent: #ef4444; /* tombol SOS merah */
      --muted: #6b7280;
    }
    body{
      background: #f4f7ff;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      padding: 18px;
    }
    .card{ border-radius: var(--card-radius); box-shadow: 0 6px 18px rgba(20,30,60,0.06); }
    .form-control, .btn { border-radius: 8px; }
    input.upper { text-transform: uppercase; }
    .muted { color: var(--muted); font-size: 0.92rem; }
    .small { font-size: 0.85rem; color: #374151; }
    #map { width: 100%; height: 300px; border-radius: 8px; background: #eef; display:block; }
    .hidden { display: none !important; }
    .topbar { display:flex;align-items:center;justify-content:space-between;gap:12px; }
    .section-gap { margin-top: 14px; }
    /* SOS button large round */
    .sos-btn {
      position: fixed;
      right: 18px;
      bottom: 18px;
      width: 84px;
      height: 84px;
      border-radius: 50%;
      background: var(--accent);
      color: white;
      border: none;
      box-shadow: 0 8px 20px rgba(239,68,68,0.24);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:700;
      font-size:18px;
      z-index: 9999;
    }
    @media(min-width:992px){
      .sos-btn { right: 28px; bottom: 28px; width:100px; height:100px; font-size:20px; }
    }
    @media(max-width:768px){
      #map { height: 220px; }
    }
  </style>
</head>
<body>
  <div class="container" style="max-width:1100px;">
    <h3 class="text-center mb-4">Sistem Keamanan Dusun</h3>

    <!-- AUTH / REGISTER -->
    <div id="authCard" class="card p-3 mb-4">
      <div class="row g-3">
        <div class="col-12 col-md-6">
          <h5 class="mb-3">Daftar Warga</h5>
          <div class="row g-2">
            <div class="col-12"><input id="reg_nama" class="form-control" placeholder="NAMA LENGKAP"></div>
            <div class="col-12"><input id="reg_hp" class="form-control" placeholder="NOMOR HP (0812... atau +628...)" oninput="formatPhoneTyping(this)"></div>
            <div class="col-12"><input id="reg_password" type="password" class="form-control" placeholder="PASSWORD (min 6)"></div>
            <div class="col-12">
              <select id="reg_role" class="form-control">
                <option value="warga">WARGA</option>
                <option value="kepala_dusun">KEPALA DUSUN</option>
                <option value="ketua_rt">KETUA RT</option>
                <option value="ketua_rw">KETUA RW</option>
                <option value="kepala_keluarga">KEPALA KELUARGA</option>
                <option value="lainnya">LAINNYA</option>
              </select>
            </div>

            <!-- Region dropdowns dynamic -->
            <div class="col-12 col-sm-6"><select id="reg_prov_select" class="form-control"><option value="">Pilih Provinsi</option></select></div>
            <div class="col-12 col-sm-6"><select id="reg_kab_select" class="form-control"><option value="">Pilih Kabupaten/Kota</option></select></div>
            <div class="col-12 col-sm-6"><select id="reg_kec_select" class="form-control"><option value="">Pilih Kecamatan</option></select></div>
            <div class="col-12 col-sm-6"><select id="reg_des_select" class="form-control"><option value="">Pilih Desa/Kelurahan</option></select></div>

            <div class="col-6"><input id="reg_rt" class="form-control" placeholder="RT (mis. 001)" maxlength="3" onblur="padRT(this)"></div>
            <div class="col-6"><input id="reg_rw" class="form-control" placeholder="RW (mis. 001)" maxlength="3" onblur="padRW(this)"></div>

            <div class="col-12"><textarea id="reg_alamat_lengkap" class="form-control" placeholder="ALAMAT LENGKAP (Jalan, No., RT/RW)"></textarea></div>
            <div class="col-6"><input id="reg_blok" class="form-control" placeholder="BLOK (opsional)"></div>
            <div class="col-6"><input id="reg_no" class="form-control" placeholder="NO RUMAH (opsional)"></div>

            <div class="col-12 d-grid">
              <button class="btn btn-success" onclick="onRegister()">Daftar</button>
            </div>
            <div class="col-12">
              <button class="btn btn-link p-0" onclick="clearRegister()">Reset form</button>
            </div>
          </div>
        </div>

        <div class="col-12 col-md-6">
          <h5 class="mb-3">Login</h5>
          <div class="row g-2">
            <div class="col-12"><input id="login_hp" class="form-control" placeholder="NOMOR HP (0812... atau +628...)" oninput="formatPhoneTyping(this)"></div>
            <div class="col-12"><input id="login_pass" type="password" class="form-control" placeholder="PASSWORD"></div>
            <div class="col-12 d-grid">
              <button class="btn btn-primary" onclick="onLogin()">Login</button>
            </div>
            <div class="col-12">
              <div class="muted">Semua pendaftaran tanpa KODE DUSUN. Masukkan KODE setelah login jika ingin bergabung ke dusun.</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboardCard" class="card p-3 hidden">
      <div class="topbar mb-3">
        <div>
          <h4 class="mb-0">Dashboard Dusun</h4>
          <div class="muted">Selamat datang, <b id="display_name"></b> · <span id="display_role"></span></div>
          <div class="small">Waktu: <span id="clock"></span></div>
        </div>
        <div class="text-end">
          <button id="btnLogout" class="btn btn-danger btn-sm" onclick="onLogout()">Logout</button>
        </div>
      </div>

      <!-- Join Dusun (warga selain kepala) -->
      <div id="joinDusunPanel" class="card p-3 mb-3 d-none">
        <h6>Masukkan Kode Dusun</h6>
        <div class="input-group">
          <input id="joinKodeDusun" class="form-control upper" placeholder="KODE DUSUN">
          <button class="btn btn-primary" onclick="joinDusun()">Gabung</button>
        </div>
        <div class="muted mt-2">Masukkan kode yang diberikan Kepala Dusun untuk bergabung.</div>
      </div>

      <!-- Buat Dusun (hanya kepala_dusun) -->
      <div id="buatDusunPanel" class="card p-3 mb-3 d-none">
        <h6>Buat Dusun (Kepala Dusun)</h6>
        <div class="row g-2">
          <div class="col-12"><input id="dusun_nama" class="form-control upper" placeholder="NAMA DUSUN"></div>
          <div class="col-12 col-md-6"><select id="dusun_prov_select" class="form-control"><option value="">Pilih Provinsi</option></select></div>
          <div class="col-12 col-md-6"><select id="dusun_kab_select" class="form-control"><option value="">Pilih Kabupaten/Kota</option></select></div>
          <div class="col-12 col-md-6"><select id="dusun_kec_select" class="form-control"><option value="">Pilih Kecamatan</option></select></div>
          <div class="col-12 col-md-6"><select id="dusun_des_select" class="form-control"><option value="">Pilih Desa/Kelurahan</option></select></div>

          <div id="kode_group" class="input-group mb-2 hidden">
            <input id="dusun_code" class="form-control" readonly placeholder="KODE DUSUN">
            <button id="copy_code_btn" class="btn btn-outline-secondary" type="button" onclick="copyDusunCode()">COPY</button>
          </div>

          <div class="col-12 d-flex gap-2">
            <button id="generate_btn" class="btn btn-primary" onclick="onGenerateCode()">Generate Kode</button>
            <button id="save_dusun_btn" class="btn btn-success hidden" onclick="onSaveDusun()">Simpan Dusun</button>
          </div>
        </div>
      </div>

      <!-- Kepala Dusun Info -->
      <div id="kepalaDusunInfo" class="card p-3 mb-3 d-none">
        <h6>Kepala Dusun</h6>
        <div id="kepalaDusunDetail" class="muted">Memuat data...</div>
      </div>

      <div class="row g-3">
        <div class="col-lg-5">
          <div class="card p-3 mb-3">
            <h6>Buat Laporan SOS</h6>
            <div class="mb-2">
              <select id="lap_jenis" class="form-control">
                <option>Kemalingan</option>
                <option>Kebakaran</option>
                <option>Medis</option>
                <option>Ambulance</option>
                <option>Mencurigakan</option>
              </select>
            </div>
            <div class="mb-2">
              <select id="lap_loc_opt" class="form-control" onchange="toggleLokasiInput()">
                <option value="saat_ini">Lokasi Saat Ini (jika diizinkan)</option>
                <option value="lainnya">Deskripsi Lokasi</option>
              </select>
            </div>
            <div class="mb-2">
              <textarea id="lap_lokasi" class="form-control hidden" placeholder="Deskripsi lokasi (opsional)"></textarea>
            </div>
            <div class="d-grid">
              <button class="btn btn-danger" onclick="sendReport()">Kirim Laporan</button>
            </div>
          </div>

          <div class="card p-3 mb-3">
            <h6>Statistik Kejadian</h6>
            <div style="height:220px;"><canvas id="chartKejadian" style="width:100%;height:100%"></canvas></div>
          </div>

          <div class="card p-3 mb-3">
            <h6>Daftar Laporan Terbaru</h6>
            <div id="listReports" class="muted">Memuat...</div>
          </div>
        </div>

        <div class="col-lg-7">
          <div class="card p-3 mb-3">
            <h6>Pos Jaga Dusun</h6>
            <div id="map">Peta (aktifkan Google Maps jika ingin marker visual)</div>
            <div class="mt-3 d-flex gap-2">
              <button class="btn btn-primary" onclick="prepareSetPos()">Set Lokasi Pos (klik lalu konfirmasi)</button>
              <button class="btn btn-outline-secondary" onclick="loadPos()">Muat Ulang Pos</button>
            </div>
            <div id="listPos" class="mt-3"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="mt-3 muted small">Catatan: ganti konfigurasi Firebase di bagian <code>firebaseConfig</code> sebelum digunakan.</div>
  </div>

  <!-- SOS button (fixed) -->
  <button class="sos-btn" id="btnSOS" title="SOS" onclick="triggerSOS()">SOS</button>

  <!-- OPTIONAL Google Maps script (if want map visual): <script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY"></script> -->

  <script>
  /************************************************
   * GANTI firebaseConfig dengan milik Anda
   ************************************************/
  const firebaseConfig = {
    // Contoh (ganti dengan nilai project Anda):
    // apiKey: "AIzaSy...YOUR_KEY...",
    // authDomain: "your-project.firebaseapp.com",
    // projectId: "your-project",
    // storageBucket: "your-project.appspot.com",
    // messagingSenderId: "....",
    // appId: "1:...:web:..."
  };
  // jika config belum diisi user, inisialisasi tetap dipanggil conditionally
  if(firebaseConfig && firebaseConfig.apiKey){
    firebase.initializeApp(firebaseConfig);
  } else {
    // create dummy firebase namespace to avoid immediate exceptions (still require real config to work)
    console.warn("firebaseConfig kosong — ganti dengan konfigurasi Firebase project Anda.");
    // don't attempt to use firebase APIs if not configured
  }

  const auth = firebaseConfig && firebaseConfig.apiKey ? firebase.auth() : null;
  const db = firebaseConfig && firebaseConfig.apiKey ? firebase.firestore() : null;

  // State
  let currentUser = null;
  let currentWargaDoc = null;
  let currentDusunDoc = null;
  let laporanChart = null;
  let mapObj = null;
  let posMarkers = [];

  // Helpers
  const $ = id => document.getElementById(id);
  const show = id => { const el = $(id); if(el) el.classList.remove('hidden'); };
  const hide = id => { const el = $(id); if(el) el.classList.add('hidden'); };
  const Toast = (title, icon='success') => Swal.fire({ title, icon, toast:true, position:'top-end', showConfirmButton:false, timer:2000 });
  const Err = (t) => Swal.fire("Error", t, "error");

  function normalizePhoneForKey(v){
    let s = (v||"").replace(/\s+/g,"").replace(/\D/g,"");
    if(s.startsWith("0")) s = "62" + s.substring(1);
    if(!s.startsWith("62")) s = "62" + s;
    return s;
  }
  function formatPhoneTyping(el){
    let raw = el.value.replace(/[^\d\+]/g,"");
    if(raw.startsWith("+")) { let digits = raw.replace(/\D/g,""); el.value = "+" + digits; } else el.value = raw;
  }
  function padRT(el){ el.value = (el.value||"").replace(/\D/g,"").padStart(3,"0"); }
  function padRW(el){ el.value = (el.value||"").replace(/\D/g,"").padStart(3,"0"); }

  function updateClock(){ const now = new Date(); $('clock').innerText = now.toLocaleString(); setTimeout(updateClock,1000); }

  function initChart(){
    const ctx = document.getElementById('chartKejadian').getContext('2d');
    laporanChart = new Chart(ctx, {
      type: 'bar',
      data: { labels: ['Kebakaran','Kemalingan','Medis','Ambulance','Mencurigakan'], datasets: [{ label: 'Jumlah', data: [0,0,0,0,0] }] },
      options: { responsive:true, maintainAspectRatio:false }
    });
  }

  /* ================= REGION DROPDOWNS (EMSIFA API) ================= */
  const API_REG = "https://www.emsifa.com/api-wilayah-indonesia/api/";
  async function loadRegionDropdowns(){
    try{
      const resProv = await fetch(API_REG + 'provinces.json');
      const provs = await resProv.json();
      const dusProv = $('dusun_prov_select');
      const regProv = $('reg_prov_select');
      provs.forEach(p => {
        if(dusProv) dusProv.innerHTML += `<option value="${p.id}">${p.name}</option>`;
        if(regProv) regProv.innerHTML += `<option value="${p.id}">${p.name}</option>`;
      });

      // dusun form handlers
      if($('dusun_prov_select')){
        $('dusun_prov_select').addEventListener('change', async function(){
          $('dusun_kab_select').innerHTML = '<option value="">Pilih Kabupaten/Kota</option>';
          $('dusun_kec_select').innerHTML = '<option value="">Pilih Kecamatan</option>';
          $('dusun_des_select').innerHTML = '<option value="">Pilih Desa/Kelurahan</option>';
          if(this.value){
            const r = await fetch(API_REG + 'regencies/' + this.value + '.json');
            const ks = await r.json();
            ks.forEach(k => dusun_kab_select.innerHTML += `<option value="${k.id}">${k.name}</option>`);
          }
        });
        $('dusun_kab_select').addEventListener('change', async function(){
          $('dusun_kec_select').innerHTML = '<option value="">Pilih Kecamatan</option>';
          $('dusun_des_select').innerHTML = '<option value="">Pilih Desa/Kelurahan</option>';
          if(this.value){
            const r = await fetch(API_REG + 'districts/' + this.value + '.json');
            const ks = await r.json();
            ks.forEach(k => dusun_kec_select.innerHTML += `<option value="${k.id}">${k.name}</option>`);
          }
        });
        $('dusun_kec_select').addEventListener('change', async function(){
          $('dusun_des_select').innerHTML = '<option value="">Pilih Desa/Kelurahan</option>';
          if(this.value){
            const r = await fetch(API_REG + 'villages/' + this.value + '.json');
            const ks = await r.json();
            ks.forEach(k => dusun_des_select.innerHTML += `<option value="${k.id}">${k.name}</option>`);
          }
        });
      }

      // register form handlers
      if($('reg_prov_select')){
        $('reg_prov_select').addEventListener('change', async function(){
          $('reg_kab_select').innerHTML = '<option value="">Pilih Kabupaten/Kota</option>';
          $('reg_kec_select').innerHTML = '<option value="">Pilih Kecamatan</option>';
          $('reg_des_select').innerHTML = '<option value="">Pilih Desa/Kelurahan</option>';
          if(this.value){
            const r = await fetch(API_REG + 'regencies/' + this.value + '.json');
            const ks = await r.json();
            ks.forEach(k => reg_kab_select.innerHTML += `<option value="${k.id}">${k.name}</option>`);
          }
        });
        $('reg_kab_select').addEventListener('change', async function(){
          $('reg_kec_select').innerHTML = '<option value="">Pilih Kecamatan</option>';
          $('reg_des_select').innerHTML = '<option value="">Pilih Desa/Kelurahan</option>';
          if(this.value){
            const r = await fetch(API_REG + 'districts/' + this.value + '.json');
            const ks = await r.json();
            ks.forEach(k => reg_kec_select.innerHTML += `<option value="${k.id}">${k.name}</option>`);
          }
        });
        $('reg_kec_select').addEventListener('change', async function(){
          $('reg_des_select').innerHTML = '<option value="">Pilih Desa/Kelurahan</option>';
          if(this.value){
            const r = await fetch(API_REG + 'villages/' + this.value + '.json');
            const ks = await r.json();
            ks.forEach(k => reg_des_select.innerHTML += `<option value="${k.id}">${k.name}</option>`);
          }
        });
      }
    }catch(e){
      console.warn('Gagal muat wilayah', e);
    }
  }

  /* ================= REGISTER (no auto-login final) ================= */
  async function onRegister(){
    if(!auth || !db){ Err("Firebase belum dikonfigurasi. Masukkan firebaseConfig di script."); return; }

    const nama = $('reg_nama').value.trim();
    const hp = $('reg_hp').value.trim();
    const password = $('reg_password').value;
    const role = $('reg_role').value || 'warga';
    const prov = $('reg_prov_select').selectedOptions[0]?.text || '';
    const kab = $('reg_kab_select').selectedOptions[0]?.text || '';
    const kec = $('reg_kec_select').selectedOptions[0]?.text || '';
    const des = $('reg_des_select').selectedOptions[0]?.text || '';
    const rt = $('reg_rt').value.trim();
    const rw = $('reg_rw').value.trim();
    const alamatFull = $('reg_alamat_lengkap').value.trim();
    const blok = $('reg_blok').value.trim();
    const no = $('reg_no').value.trim();

    if(!nama || !hp || !password){ Err("Lengkapi: Nama, HP, Password"); return; }
    if(password.length < 6){ Err("Password minimal 6 karakter"); return; }

    try{
      const norm = normalizePhoneForKey(hp);
      const dup = await db.collection('Warga').where('phone','==',norm).limit(1).get();
      if(!dup.empty){ Err("Nomor HP sudah terdaftar"); return; }

      const fakeEmail = norm + "@dusun.fake";

      // create user (this action will auto sign-in the new user)
      const userCred = await auth.createUserWithEmailAndPassword(fakeEmail, password);
      const uid = userCred.user.uid;

      // create warga doc while signed in (ensures write allowed by rules that require auth)
      await db.collection('Warga').doc(uid).set({
        nama,
        phone: norm,
        role,
        status: 'pending',
        kodeDusun: null,
        provinsi: prov,
        kabupaten: kab,
        kecamatan: kec,
        desa: des,
        rt, rw, alamat: alamatFull, blok, no,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      // Immediately sign out to honor "do not auto-login" requirement
      await auth.signOut();

      Swal.fire({
        title: "Pendaftaran Berhasil",
        html: "Akun berhasil dibuat. Silakan login untuk melanjutkan.",
        icon: "success"
      });
      clearRegister();
    }catch(err){
      Err(err.message || String(err));
    }
  }

  function clearRegister(){
    ['reg_nama','reg_hp','reg_password','reg_role','reg_rt','reg_rw','reg_alamat_lengkap','reg_blok','reg_no'].forEach(id=>{
      const el = $(id); if(el) el.value = '';
    });
  }

  /* ================= LOGIN ================= */
  async function onLogin(){
    if(!auth){ Err("Firebase belum dikonfigurasi."); return; }
    const hp = $('login_hp').value.trim();
    const pass = $('login_pass').value;
    if(!hp || !pass){ Err("Nomor HP & password wajib"); return; }
    try{
      const norm = normalizePhoneForKey(hp);
      const fakeEmail = norm + "@dusun.fake";
      await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
      const userCred = await auth.signInWithEmailAndPassword(fakeEmail, pass);
      currentUser = userCred.user;
      await loadUserProfile();
      Toast("Login berhasil");
      showDashboard();
    }catch(err){
      Err(err.message || String(err));
    }
  }

  async function loadUserProfile(){
    if(!auth) return;
    const uid = auth.currentUser?.uid;
    if(!uid) return;
    const doc = await db.collection('Warga').doc(uid).get();
    if(doc.exists){
      currentWargaDoc = { id: doc.id, data: doc.data() };
      if(currentWargaDoc.data.kodeDusun){
        const q = await db.collection('Dusun').where('kode','==', currentWargaDoc.data.kodeDusun).limit(1).get();
        if(!q.empty) currentDusunDoc = { id: q.docs[0].id, data: q.docs[0].data() };
      } else currentDusunDoc = null;
    } else {
      currentWargaDoc = null;
      currentDusunDoc = null;
    }
  }

  auth && auth.onAuthStateChanged(async (u) => {
    if(u){
      currentUser = u;
      await loadUserProfile();
      showDashboard();
    } else {
      currentUser = null;
      currentWargaDoc = null;
      currentDusunDoc = null;
      showAuth();
    }
  });

  function showAuth(){ show('authCard'); hide('dashboardCard'); }
  function showDashboard(){ hide('authCard'); show('dashboardCard'); updateClock(); renderRoleUI(); }

  /* ================= RENDER / ROLE UI ================= */
  function renderRoleUI(){
    $('display_name').innerText = currentWargaDoc?.data?.nama || 'Pengguna';
    $('display_role').innerText = (currentWargaDoc?.data?.role || 'warga').toUpperCase();

    const role = currentWargaDoc?.data?.role || 'warga';

    // not joined yet
    if(!currentWargaDoc?.data?.kodeDusun){
      show('joinDusunPanel');
      hide('kepalaDusunInfo');
      hide('buatDusunPanel');
      $('listReports').innerHTML = '<div class="muted">Belum terhubung ke dusun. Masukkan kode dusun pada panel "Masukkan Kode Dusun".</div>';
      return;
    }

    hide('joinDusunPanel');

    // if user is kepala_dusun -> show create Dusun panel
    if(role === 'kepala_dusun'){
      show('buatDusunPanel');
      loadDusunOwnedByUser();
    } else {
      hide('buatDusunPanel');
    }

    // load dusun data, reports, pos
    if(currentDusunDoc && currentDusunDoc.data){
      showDusunDetails();
      subscribeReportsForDusun(currentDusunDoc.data.kode);
      loadPos();
      if(currentDusunDoc.data.kepalaId) loadKepalaDusunInfo(currentDusunDoc.data.kepalaId);
    } else {
      // try to fetch by kode if missing
      (async ()=>{
        try{
          const k = currentWargaDoc.data.kodeDusun;
          const q = await db.collection('Dusun').where('kode','==',k).limit(1).get();
          if(!q.empty) {
            currentDusunDoc = { id: q.docs[0].id, data: q.docs[0].data() };
            showDusunDetails();
            subscribeReportsForDusun(currentDusunDoc.data.kode);
            loadPos();
            if(currentDusunDoc.data.kepalaId) loadKepalaDusunInfo(currentDusunDoc.data.kepalaId);
          } else {
            $('listReports').innerHTML = '<div class="muted">Dusun tidak ditemukan (kode mungkin salah).</div>';
          }
        }catch(e){ console.warn(e); }
      })();
    }
  }

  /* ================= JOIN DUSUN ================= */
  async function joinDusun(){
    if(!db){ Err("Firebase belum dikonfigurasi."); return; }
    const kode = $('joinKodeDusun').value.trim().toUpperCase();
    if(!kode){ Err("Masukkan kode dusun"); return; }
    try{
      const snap = await db.collection('Dusun').where('kode','==',kode).limit(1).get();
      if(snap.empty){ Err("Kode dusun tidak ditemukan"); return; }
      const dusunDoc = snap.docs[0];
      await db.collection('Warga').doc(currentWargaDoc.id).update({ kodeDusun: kode });
      currentWargaDoc.data.kodeDusun = kode;
      currentDusunDoc = { id: dusunDoc.id, data: dusunDoc.data() };
      Toast("Berhasil bergabung ke dusun");
      renderRoleUI();
    }catch(e){ Err(e.message || String(e)); }
  }

  /* ================= DUSUN: Generate & Save (Kepala Dusun) ================= */
  function onGenerateCode(){
    const code = Math.random().toString(36).substring(2,9).toUpperCase();
    $('dusun_code').value = code;
    $('kode_group').classList.remove('hidden');
    $('save_dusun_btn').classList.remove('hidden');
  }
  function copyDusunCode(){
    const v = $('dusun_code').value || '';
    if(!v) return;
    navigator.clipboard.writeText(v).then(()=>Toast("Kode disalin"));
  }
  async function onSaveDusun(){
    if(!db){ Err("Firebase belum dikonfigurasi."); return; }
    const nama = $('dusun_nama').value.trim();
    const provText = $('dusun_prov_select').selectedOptions[0]?.text || '';
    const kabText = $('dusun_kab_select').selectedOptions[0]?.text || '';
    const kecText = $('dusun_kec_select').selectedOptions[0]?.text || '';
    const desText = $('dusun_des_select').selectedOptions[0]?.text || '';
    const code = $('dusun_code').value.trim();
    if(!nama || !code){ Err("Nama & kode dusun wajib"); return; }
    try{
      const q = await db.collection('Dusun').where('kode','==',code).get();
      if(!q.empty){ Err("Kode sudah terpakai, generate ulang"); return; }
      const now = firebase.firestore.FieldValue.serverTimestamp();
      const docRef = await db.collection('Dusun').add({
        nama,
        provinsi: provText,
        kabupaten: kabText,
        kecamatan: kecText,
        desa: desText,
        kode: code,
        kepalaId: currentUser.uid,
        createdAt: now,
        active: true
      });
      await db.collection('Warga').doc(currentWargaDoc.id).update({ kodeDusun: code });
      currentWargaDoc.data.kodeDusun = code;
      currentDusunDoc = { id: docRef.id, data: { nama, provinsi: provText, kabupaten: kabText, kecamatan: kecText, desa: desText, kode: code, kepalaId: currentUser.uid } };
      Toast("Dusun dibuat dan Anda sekarang menjadi Kepala Dusun");
      renderRoleUI();
    }catch(e){ Err(e.message || String(e)); }
  }
  async function loadDusunOwnedByUser(){
    try{
      const snap = await db.collection('Dusun').where('kepalaId','==',currentUser.uid).limit(1).get();
      if(!snap.empty){
        currentDusunDoc = { id: snap.docs[0].id, data: snap.docs[0].data() };
        $('dusun_code').value = currentDusunDoc.data.kode || '';
        $('kode_group').classList.remove('hidden');
        $('save_dusun_btn').classList.add('hidden');
      }
    }catch(e){ console.warn(e); }
  }

  /* ================= Kepala Dusun Info ================= */
  async function loadKepalaDusunInfo(kepalaId){
    try{
      const doc = await db.collection('Warga').doc(kepalaId).get();
      if(doc.exists){
        const data = doc.data();
        let alamat = "";
        if(data.alamat) alamat += data.alamat + ", ";
        if(data.blok) alamat += "Blok " + data.blok + " ";
        if(data.no) alamat += "No. " + data.no + ", ";
        alamat += `RT ${data.rt || '-'} / RW ${data.rw || '-'}, ${data.desa || ''}, ${data.kecamatan || ''}, ${data.kabupaten || ''}, ${data.provinsi || ''}`;
        $('kepalaDusunDetail').innerHTML = `<div><strong>${data.nama || '-'}</strong></div><div class="small">${alamat}</div><div class="small">HP: ${data.phone || '-'}</div>`;
        show('kepalaDusunInfo');
      } else {
        $('kepalaDusunDetail').innerText = "Data kepala dusun tidak ditemukan.";
        show('kepalaDusunInfo');
      }
    }catch(e){ console.warn(e); }
  }

  /* ================= REPORTS ================= */
  async function sendReport(){
    if(!currentWargaDoc){ Err("Anda harus login"); return; }
    if(!currentWargaDoc.data.kodeDusun){ Err("Anda harus bergabung dengan dusun terlebih dahulu"); return; }
    const jenis = $('lap_jenis').value;
    const lokasiOpt = $('lap_loc_opt').value;
    const lokasiDesc = $('lap_lokasi').value.trim();
    let lat = null, lng = null;
    if(lokasiOpt === 'saat_ini' && navigator.geolocation){
      try{
        const pos = await new Promise((res,rej) => navigator.geolocation.getCurrentPosition(res,rej,{ timeout:8000 }));
        lat = pos.coords.latitude; lng = pos.coords.longitude;
      }catch(e){ console.warn("GPS denied/failed", e); }
    }
    try{
      await db.collection('Laporan').add({
        jenis,
        lokasiDeskripsi: lokasiDesc || null,
        lat, lng,
        dusunCode: currentWargaDoc.data.kodeDusun || null,
        userId: currentWargaDoc.id,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        status: 'open'
      });
      Toast("Laporan terkirim");
    }catch(e){ Err(e.message || String(e)); }
  }

  /* ================= Real-time laporan subscribe ================= */
  let laporanUnsub = null;
  function subscribeReportsForDusun(kodeDusun){
    if(laporanUnsub) laporanUnsub();
    if(!kodeDusun) { updateChartCounts({}); return; }
    laporanUnsub = db.collection('Laporan').where('dusunCode','==',kodeDusun).orderBy('createdAt','desc').onSnapshot(snapshot=>{
      const arr = []; snapshot.forEach(doc=> arr.push({ id: doc.id, data: doc.data() }));
      renderReports(arr);
      const counts = {}; arr.forEach(r => counts[r.data.jenis] = (counts[r.data.jenis]||0) + 1);
      updateChartCounts(counts);
    });
  }
  function renderReports(arr){
    const container = $('listReports'); container.innerHTML = '';
    if(!arr.length){ container.innerHTML = '<div class="muted">Belum ada laporan.</div>'; return; }
    arr.forEach(r=>{
      const d = r.data;
      const time = d.createdAt ? new Date(d.createdAt.seconds*1000).toLocaleString() : '-';
      const el = document.createElement('div'); el.className = 'mb-2 p-2 border rounded';
      el.innerHTML = `<div><strong>${d.jenis}</strong> <span class="muted small">· ${time}</span></div><div class="muted small">${d.lokasiDeskripsi || ''}${d.lat ? `<br>Lat:${d.lat.toFixed(5)} Lng:${d.lng.toFixed(5)}` : ''}</div>`;
      container.appendChild(el);
    });
  }
  function updateChartCounts(counts){
    const labels = ['Kebakaran','Kemalingan','Medis','Ambulance','Mencurigakan'];
    const data = labels.map(l => counts[l] || 0);
    if(laporanChart){ laporanChart.data.datasets[0].data = data; laporanChart.update(); }
  }

  /* ================= POS JAGA: set lokasi via GPS (no manual lat/lng) ================= */
  // When user clicks "Set Lokasi Pos", call this to capture location and save
  async function prepareSetPos(){
    if(!currentWargaDoc){ Err("Anda harus login"); return; }
    const role = currentWargaDoc.data.role;
    if(role !== 'kepala_dusun' && role !== 'ketua_rt' && role !== 'ketua_rw'){ Err("Hanya Kepala Dusun/RT/RW yang boleh menambah pos"); return; }

    const { value: nama } = await Swal.fire({
      title: 'Nama Pos Jaga',
      input: 'text',
      inputLabel: 'Nama Pos (contoh: Pos RT 01)',
      inputPlaceholder: 'Masukkan nama pos',
      showCancelButton: true
    });
    if(!nama) return;

    Swal.fire({ title: 'Mencoba mengambil lokasi... (beri izin jika diminta)', allowOutsideClick:false, didOpen: ()=>Swal.showLoading() });
    try{
      const pos = await new Promise((res,rej)=> navigator.geolocation.getCurrentPosition(res,rej,{ timeout:15000 }));
      Swal.close();
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      // simpan ke firestore
      await db.collection('PosDusun').add({
        nama,
        lat, lng,
        dusunCode: currentDusunDoc.data.kode,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      Toast("Pos tersimpan dengan lokasi Anda");
      loadPos();
    }catch(e){
      Swal.close();
      Err("Gagal mendapatkan lokasi. Pastikan GPS diizinkan dan coba lagi.");
    }
  }

  async function loadPos(){
    if(!currentDusunDoc || !currentDusunDoc.data){ $('listPos').innerHTML = '<div class="muted">Belum ada pos.</div>'; return; }
    const snap = await db.collection('PosDusun').where('dusunCode','==', currentDusunDoc.data.kode).get();
    const list = $('listPos'); list.innerHTML = '';
    snap.forEach(doc=>{
      const d = doc.data();
      const el = document.createElement('div'); el.className = 'p-2 border rounded mb-2';
      el.innerHTML = `<div><strong>${d.nama}</strong></div><div class="muted small">${d.lat||'-'}, ${d.lng||'-'}</div>`;
      list.appendChild(el);
    });
  }

  /* ================= SOS action (placeholder) ================= */
  function triggerSOS(){
    // simple visual confirm; implement real integration (call center, webhook) as needed
    Swal.fire({
      title: "Kirim SOS?",
      html: "Anda akan mengirim tanda darurat ke sistem dusun. Lanjutkan?",
      icon: "warning",
      showCancelButton: true,
      confirmButtonText: "Kirim SOS"
    }).then(async (res)=>{
      if(res.isConfirmed){
        // create a Laporan SOS with jenis = 'SOS'
        if(!currentWargaDoc || !currentWargaDoc.data.kodeDusun){ Err("Anda harus bergabung dengan dusun untuk mengirim SOS"); return; }
        try{
          await db.collection('Laporan').add({
            jenis: 'SOS',
            lokasiDeskripsi: null,
            lat: null, lng: null,
            dusunCode: currentWargaDoc.data.kodeDusun,
            userId: currentWargaDoc.id,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            status: 'open'
          });
          Toast("SOS terkirim!");
        }catch(e){ Err(e.message || String(e)); }
      }
    });
  }

  /* ================= Misc helpers & init ================= */
  function showDusunDetails(){
    if(!currentDusunDoc || !currentDusunDoc.data) return;
    $('listReports').innerHTML = '<div class="muted">Memuat laporan...</div>';
    $('kepalaDusunDetail') && ( $('kepalaDusunDetail').innerHTML = 'Memuat data kepala dusun...' );
  }

  async function onLogout(){
    if(auth){ await auth.signOut(); }
    currentUser = null; currentWargaDoc = null; currentDusunDoc = null;
    Toast("Logout berhasil");
    showAuth();
  }

  // load region dropdowns and init chart & clock on load
  window.addEventListener('load', async ()=>{
    updateClock();
    initChart();
    await loadRegionDropdowns();
  });

  </script>
</body>
</html>
