<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <title>SISTEM KEAMANAN DUSUN â€” FULL (Lengkap)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <style>
    :root{ --muted:#6b7280; --accent:#ef4444; --safe:#16a34a; --caution:#f59e0b; --danger:#ef4444; --card-radius:12px; }
    body{background:#f4f7ff;font-family:Inter,Segoe UI,Arial,sans-serif;padding:16px;-webkit-text-size-adjust:100%;}
    .card{border-radius:var(--card-radius);box-shadow:0 8px 30px rgba(14,30,60,0.06);margin-bottom:16px;}
    .form-control,.btn{border-radius:8px;}
    .muted{color:var(--muted);font-size:0.95rem;}
    #map, #posFormMap, #posViewMap { width:100%; height:360px; border-radius:8px; }
    .hidden{display:none!important;}
    .sos-btn{width:110px;height:110px;border-radius:999px;background:var(--accent);color:#fff;font-weight:800;display:flex;align-items:center;justify-content:center;font-size:18px;border:none;cursor:pointer;box-shadow:0 12px 32px rgba(239,68,68,0.25);margin:0 auto;}
    @media(max-width:767px){ .sos-btn{width:96px;height:96px;position:fixed;left:50%;transform:translateX(-50%);bottom:18px;z-index:999;} body{padding-bottom:160px;} }
    .pos-photo{max-width:100%;max-height:160px;border-radius:8px;margin-top:6px;display:block;}
    .small{font-size:0.85rem;color:#555;}
    .kejadian-option{display:inline-block;margin:6px;text-align:center;cursor:pointer;padding:8px;border-radius:8px;border:1px solid #eee;background:#fff;width:110px;}
    .kejadian-option span{display:block;margin-top:6px;font-size:0.9rem;}
    .status-aman{color:var(--safe);font-weight:700}.status-waspada{color:var(--caution);font-weight:700}.status-rawan{color:var(--danger);font-weight:700}
    .table-sm td,.table-sm th{padding:.35rem .5rem;}
    .modal-overlay{position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:1200;}
    .modal-box{width:90%;max-width:760px;background:#fff;padding:14px;border-radius:10px;box-shadow:0 10px 40px rgba(0,0,0,.2);}
    .file-label{display:inline-block;padding:.45rem .6rem;border-radius:8px;background:#f8fafc;border:1px dashed #e5e7eb;cursor:pointer;}
  </style>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>

  <!-- Extras -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
</head>
<body>
<div class="container" style="max-width:1200px;">
  <h3 class="text-center mb-3">SISTEM KEAMANAN DUSUN â€” FULL</h3>

  <!-- AUTH / REGISTER -->
  <div id="authCard" class="card p-3">
    <div class="row g-3">
      <div class="col-md-6">
        <h5>Pendaftaran Warga</h5>
        <input id="reg_nama" class="form-control mb-2" placeholder="Nama lengkap">
        <input id="reg_hp" class="form-control mb-2" placeholder="Nomor HP (0812...)" oninput="formatPhoneTyping(this)">
        <input id="reg_password" type="password" class="form-control mb-2" placeholder="Password (disimpan hanya di Auth)">
        <label class="form-label small">Pilih Status / Subrole</label>
        <select id="reg_status" class="form-control mb-2">
          <optgroup label="A. Kepala">
            <option value="kepala_desa">Kepala Desa</option>
            <option value="kepala_dusun">Kepala Dusun</option>
            <option value="ketua_rt_rw">Ketua RT / RW</option>
            <option value="kepala_keluarga">Kepala Keluarga</option>
          </optgroup>
          <optgroup label="B. Istri">
            <option value="istri">Istri</option>
            <option value="istri_kepala_dusun">Istri / Kepala Dusun</option>
          </optgroup>
          <optgroup label="C. Anak">
            <option value="anak">Anak</option>
          </optgroup>
          <optgroup label="Lainnya">
            <option value="warga">Warga</option>
          </optgroup>
        </select>

        <!-- Region dropdowns (EMSIFA) -->
        <label class="form-label small">Provinsi / Kabupaten / Kecamatan / Desa / Dusun</label>
        <select id="reg_prov" class="form-control mb-1"><option value="">Pilih Provinsi</option></select>
        <select id="reg_kab" class="form-control mb-1"><option value="">Pilih Kabupaten/Kota</option></select>
        <select id="reg_kec" class="form-control mb-1"><option value="">Pilih Kecamatan</option></select>
        <select id="reg_des" class="form-control mb-1"><option value="">Pilih Desa/Kelurahan</option></select>
        <select id="reg_dus" class="form-control mb-1"><option value="">Pilih Dusun (jika tersedia)</option></select>

        <div class="row g-2 mb-2">
          <div class="col"><input id="reg_blok" class="form-control" placeholder="Blok (opsional)"></div>
          <div class="col"><input id="reg_no" class="form-control" placeholder="No Rumah (opsional)"></div>
        </div>
        <div class="row g-2 mb-2">
          <div class="col"><input id="reg_rt" class="form-control" placeholder="RT (mis. 001)" maxlength="3" onblur="padRT(this)"></div>
          <div class="col"><input id="reg_rw" class="form-control" placeholder="RW (mis. 001)" maxlength="3" onblur="padRW(this)"></div>
        </div>

        <textarea id="reg_alamat" class="form-control mb-2" placeholder="Alamat lengkap (diisi otomatis dari dropdown)"></textarea>

        <div class="d-grid gap-2">
          <button id="btnRegister" class="btn btn-success" onclick="onRegister()">Daftar</button>
          <button class="btn btn-outline-secondary" onclick="clearRegister()">Reset</button>
        </div>
        <div class="muted mt-2">Setelah mendaftar: <strong>jangan langsung login</strong>. Silakan login di panel sebelah.</div>
      </div>

      <div class="col-md-6">
        <h5>Login</h5>
        <input id="login_hp" class="form-control mb-2" placeholder="Nomor HP (contoh: 0812...)" oninput="formatPhoneTyping(this)">
        <input id="login_pass" type="password" class="form-control mb-2" placeholder="Password">
        <div class="d-grid gap-2 mb-2">
          <button class="btn btn-primary" onclick="onLogin()">Login</button>
        </div>
        <div class="muted small">Password disimpan hanya di Firebase Auth. Jika terjadi error terkait API key, periksa konfigurasi Firebase.</div>
      </div>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dashboardCard" class="card p-3 hidden">
    <div class="topbar d-flex justify-content-between align-items-center mb-2">
      <div>
        <h4>Dashboard Dusun</h4>
        <div class="muted">Selamat datang, <b id="display_name"></b> Â· <span id="display_role"></span> Â· <span id="display_status"></span></div>
        <div class="muted small">Waktu: <span id="clock"></span></div>
      </div>
      <div class="text-end">
        <button class="btn btn-danger btn-sm" onclick="onLogout()">Logout</button>
      </div>
    </div>

    <div class="row g-3">
      <div class="col-lg-4">
        <!-- Kepala Dusun Info -->
        <div class="card p-3 mb-3">
          <h6>Informasi Kepala Dusun</h6>
          <div id="kepalaInfo" class="muted">Memuat...</div>
        </div>

        <!-- SOS card (jenis kejadian + lokasi + sos button) -->
        <div class="card p-3 mb-3">
          <h6>Darurat / Lapor Cepat</h6>
          <div id="kejadianGrid" class="mb-2"></div>
          <label class="form-label small">Lokasi Laporan</label>
          <select id="lap_loc_opt" class="form-control mb-2">
            <option value="rumah">Di Rumah (alamat terdaftar)</option>
            <option value="lainnya">Di Tempat Lain</option>
          </select>
          <textarea id="lap_lokasi" class="form-control mb-2 hidden" placeholder="Deskripsi alamat (jika di tempat lain)"></textarea>
          <div class="centered mt-2"><button id="sosButton" class="sos-btn" onclick="openSOS()">SOS</button></div>
        </div>

        <!-- Buat Dusun (hanya kepala) -->
        <div id="createDusunCard" class="card p-3 mb-3 hidden">
          <h6>Buat Dusun (Kepala)</h6>
          <input id="dusun_nama" class="form-control mb-2" placeholder="Nama Dusun">
          <div class="d-grid gap-2"><button class="btn btn-primary" onclick="createDusun()">Buat Dusun</button></div>
          <div class="muted small mt-2">Kode dusun hanya terlihat oleh Kepala Dusun yang membuatnya.</div>
          <div id="myDusunCode" class="muted small mt-2"></div>
        </div>

        <!-- Gabung Dusun -->
        <div id="joinDusunCard" class="card p-3 mb-3 hidden">
          <h6>Gabung Dusun</h6>
          <input id="join_kode" class="form-control upper mb-2" placeholder="Masukkan Kode Dusun">
          <div class="d-grid gap-2"><button class="btn btn-success" onclick="joinDusun()">Gabung</button></div>
        </div>
      </div>

      <div class="col-lg-8">
        <!-- Map -->
        <div class="card p-3 mb-3">
          <h6>Peta Pos & Dusun</h6>
          <div id="map">Memuat peta...</div>
          <div class="d-flex gap-2 mt-3">
            <button id="btnOpenPosForm" class="btn btn-outline-primary" onclick="openPosForm()">Tambah Pos</button>
            <button class="btn btn-outline-secondary" onclick="loadPosList()">Muat Ulang Pos</button>
          </div>
          <div id="posList" class="mt-3"></div>
        </div>

        <!-- History Laporan -->
        <div class="card p-3 mb-3">
          <h6>Riwayat Laporan Saya</h6>
          <div id="myReports">Memuat...</div>
        </div>
        <div class="card p-3 mb-3">
          <h6>Riwayat Laporan Warga Lain (Dusun)</h6>
          <div id="otherReports">Memuat...</div>
        </div>

        <!-- Statistik 30 hari -->
        <div class="card p-3 mb-3">
          <h6>Statistik Kejadian (30 hari)</h6>
          <canvas id="chartKejadian" style="height:180px"></canvas>
          <div id="statSummary" class="mt-2"></div>
        </div>

        <!-- Anggota Keluarga -->
        <div class="card p-3 mb-3">
          <h6>Anggota Keluarga (Alamat Sama)</h6>
          <div id="familyList">Memuat...</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Pos Form Modal (inline, tidak keluar halaman) -->
<div id="posModal" class="modal-overlay hidden">
  <div class="modal-box">
    <h5>Tambah Pos</h5>
    <div id="posFormArea">
      <input id="pos_name" class="form-control mb-2" placeholder="Nama Pos (mis. Pos RT01)">
      <div class="row g-2">
        <div class="col"><input id="pos_rt" class="form-control" placeholder="RT (001)"></div>
        <div class="col"><input id="pos_rw" class="form-control" placeholder="RW (001)"></div>
      </div>
      <div class="row g-2 mt-2">
        <div class="col">
          <select id="pos_status" class="form-control">
            <option value="active">Active</option>
            <option value="pasif">Pasif</option>
          </select>
        </div>
        <div class="col">
          <select id="pos_jenis" class="form-control">
            <option value="pos_dusun">Pos Dusun</option>
            <option value="pos_rt">Pos RT</option>
          </select>
        </div>
      </div>
      <div class="mt-2">
        <label class="file-label">Pilih Foto <input id="pos_photo" type="file" accept="image/*" style="display:none"></label>
        <div id="posPhotoPreview" class="mt-2"></div>
      </div>
      <div class="mt-2">
        <small class="muted">Tandai lokasi di map (tetap di halaman ini). Klik "Set Lokasi" setelah memilih titik.</small>
        <div id="posFormMap" class="mt-2"></div>
        <div class="d-flex gap-2 mt-2">
          <button class="btn btn-success" onclick="setPosLocationFromMap()">Set Lokasi</button>
          <button class="btn btn-primary" onclick="savePos()">Simpan Pos</button>
          <button class="btn btn-outline-secondary" onclick="closePosForm()">Batal</button>
        </div>
        <div id="chosenPosCoord" class="muted small mt-2">Lokasi belum ditetapkan.</div>
      </div>
    </div>
  </div>
</div>

<!-- Pos View Modal -->
<div id="posViewModal" class="modal-overlay hidden">
  <div class="modal-box">
    <h5>Detail Pos</h5>
    <div id="posViewContent"></div>
    <div id="posViewMap" class="mt-2"></div>
    <div class="d-flex gap-2 mt-3 justify-content-end">
      <button class="btn btn-secondary" onclick="closePosView()">Tutup</button>
    </div>
  </div>
</div>

<script>
/* ================== CONFIG FIREBASE ==================
   Ganti dengan config Firebase-mu jika perlu.
*/
const firebaseConfig = {
  apiKey: "AIzaSyA6GAeIc7ZesIed9MAelUf6x_sBFdp9E-Q",
  authDomain: "dusun-super.firebaseapp.com",
  projectId: "dusun-super",
  storageBucket: "dusun-super.appspot.com",
  messagingSenderId: "1083284057385",
  appId: "1:1083284057385:web:21cfe467b047bb5a241b38"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();
auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(e=>console.warn(e));

/* ================== GLOBAL STATE ================== */
let currentUser = null;
let currentWarga = null;   // profile doc
let currentDusun = null;   // dusun doc
let mainMap = null;
let mainMarkers = L ? L.layerGroup() : null;
let posFormMap = null, posFormMarker = null;
let posViewMap = null;
let chartKej = null;
let tempChosenPos = { lat:null, lng:null };

/* ================== HELPERS ================== */
const $ = id => document.getElementById(id);
const show = id => { const e=$(id); if(e) e.classList.remove('hidden'); };
const hide = id => { const e=$(id); if(e) e.classList.add('hidden'); };
const toast = (t) => Swal.fire({title:t,icon:'success',toast:true,position:'top-end',showConfirmButton:false,timer:1600});
const err = (m) => Swal.fire('Error', m, 'error');
function formatPhoneTyping(el){ el.value = el.value.replace(/[^\d\+]/g,''); }
function normalizePhoneForKey(v){ let s=(v||"").replace(/\D/g,""); if(s.startsWith("0")) s="62"+s.substring(1); if(!s.startsWith("62")) s="62"+s; return s; }
function padRT(el){ let v=(el.value||'').replace(/\D/g,''); v=v.padStart(3,'0'); el.value=v; }
function padRW(el){ let v=(el.value||'').replace(/\D/g,''); v=v.padStart(3,'0'); el.value=v; }
function nowTs(){ return firebase.firestore.FieldValue.serverTimestamp(); }

/* ================== CLOCK ================== */
function updateClock(){ if($('clock')) $('clock').innerText = new Date().toLocaleString(); setTimeout(updateClock,1000); }
updateClock();

/* ================== LOAD REGION DROPDOWNS (EMSIFA) ================== */
const API_REG = "https://www.emsifa.com/api-wilayah-indonesia/api/";
async function loadRegionDropdowns(){
  try{
    const res = await fetch(API_REG + 'provinces.json'); const provs = await res.json();
    const provSel = $('reg_prov');
    provs.forEach(p=>provSel.innerHTML += `<option value="${p.id}">${p.name}</option>`);
    $('reg_prov').addEventListener('change', async function(){
      $('reg_kab').innerHTML = '<option value="">Pilih Kabupaten/Kota</option>'; $('reg_kec').innerHTML = '<option value="">Pilih Kecamatan</option>'; $('reg_des').innerHTML = '<option value="">Pilih Desa</option>';
      if(!this.value) return;
      const r = await fetch(API_REG + 'regencies/' + this.value + '.json'); const data = await r.json();
      data.forEach(k => $('reg_kab').innerHTML += `<option value="${k.id}">${k.name}</option>`);
      autofillAlamat();
    });
    $('reg_kab').addEventListener('change', async function(){ $('reg_kec').innerHTML = '<option value="">Pilih Kecamatan</option>'; $('reg_des').innerHTML = '<option value="">Pilih Desa</option>'; if(!this.value) return; const r = await fetch(API_REG + 'districts/' + this.value + '.json'); const data = await r.json(); data.forEach(k => $('reg_kec').innerHTML += `<option value="${k.id}">${k.name}</option>`); autofillAlamat(); });
    $('reg_kec').addEventListener('change', async function(){ $('reg_des').innerHTML = '<option value="">Pilih Desa</option>'; if(!this.value) return; const r = await fetch(API_REG + 'villages/' + this.value + '.json'); const data = await r.json(); data.forEach(d => $('reg_des').innerHTML += `<option value="${d.id}">${d.name}</option>`); autofillAlamat(); });
    $('reg_des').addEventListener('change', ()=>{ autofillAlamat(); loadDusunDropdown(); });
    $('reg_dus').addEventListener('change', ()=>{ autofillAlamat(); });
    ['reg_blok','reg_no','reg_rt','reg_rw'].forEach(id=>{ const el=$(id); if(el) el.addEventListener('input', autofillAlamat); });
  }catch(e){ console.warn('Gagal load region', e); }
}

/* ================== DUSUN DROPDOWN from Firestore ================== */
async function loadDusunDropdown(){
  try{
    const desaText = $('reg_des').selectedOptions[0]?.text || '';
    // load all Dusun; but we can filter by desaText if available
    let snap = await db.collection('Dusun').orderBy('nama').limit(500).get();
    const sel = $('reg_dus'); sel.innerHTML = '<option value="">Pilih Dusun</option>';
    snap.forEach(doc => {
      const d = doc.data();
      const display = d.nama + (d.desa ? ' Â· ' + d.desa : '');
      sel.innerHTML += `<option value="${doc.id}" data-nama="${escapeHtml(d.nama)}" data-desa="${escapeHtml(d.desa||'')}">${display}</option>`;
    });
  }catch(e){ console.warn('gagal muat dusun', e); }
}

/* ================== AUTOFILL ALAMAT ================== */
function autofillAlamat(){
  const prov = $('reg_prov').selectedOptions[0]?.text || '';
  const kab = $('reg_kab').selectedOptions[0]?.text || '';
  const kec = $('reg_kec').selectedOptions[0]?.text || '';
  const des = $('reg_des').selectedOptions[0]?.text || '';
  const dusun = $('reg_dus').selectedOptions[0]?.text || '';
  const blok = $('reg_blok').value || '';
  const no = $('reg_no').value || '';
  const rt = $('reg_rt').value || '';
  const rw = $('reg_rw').value || '';
  const parts = [];
  if(dusun) parts.push(dusun);
  if(blok || no) parts.push((blok?('Blok '+blok):'') + (no?('-'+no):''));
  if(rt||rw) parts.push('RT '+(rt||'-')+' / RW '+(rw||'-'));
  if(des) parts.push('Desa '+des);
  if(kec) parts.push('Kec. '+kec);
  if(kab) parts.push('Kab/Kota '+kab);
  if(prov) parts.push(prov);
  $('reg_alamat').value = parts.join(', ');
}

/* ================== REGISTER (no password stored) ================== */
async function onRegister(){
  const nama = $('reg_nama').value.trim();
  const hp = $('reg_hp').value.trim();
  const password = $('reg_password').value;
  const role = $('reg_status').value || 'warga';
  const prov = $('reg_prov').selectedOptions[0]?.text || '';
  const kab = $('reg_kab').selectedOptions[0]?.text || '';
  const kec = $('reg_kec').selectedOptions[0]?.text || '';
  const des = $('reg_des').selectedOptions[0]?.text || '';
  const dusunSel = $('reg_dus').selectedOptions[0] || null;
  const dusunId = dusunSel ? dusunSel.value : null;
  const dusunNama = dusunSel ? dusunSel.dataset.nama || '' : '';
  const alamat = $('reg_alamat').value.trim();
  const blok = $('reg_blok').value.trim();
  const no = $('reg_no').value.trim();
  const rt = $('reg_rt').value.trim();
  const rw = $('reg_rw').value.trim();

  if(!nama || !hp || !password) return err("Lengkapi Nama, HP, Password");
  if(password.length < 6) return err("Password minimal 6 karakter");

  try{
    const norm = normalizePhoneForKey(hp);
    const dup = await db.collection('Warga').where('phone','==',norm).limit(1).get();
    if(!dup.empty) return err("Nomor HP sudah terdaftar");

    // create auth user (password stored only di Auth)
    const email = norm + "@dusun.fake";
    const uc = await auth.createUserWithEmailAndPassword(email, password);
    const uid = uc.user.uid;

    // determine status: kepala subroles auto aktif
    const kepalaRoles = ['kepala_desa','kepala_dusun','ketua_rt_rw','kepala_keluarga','istri_kepala_dusun'];
    const status = kepalaRoles.includes(role) ? 'aktif' : 'pending';

    // store profile WITHOUT password
    await db.collection('Warga').doc(uid).set({
      nama, phone: norm, role, status,
      provinsi: prov, kabupaten: kab, kecamatan: kec, desa: des, dusunId: dusunId, dusunNama: dusunNama,
      alamat, blok, no, rt, rw, kodeDusun: null,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    // clear password input immediately (no history)
    $('reg_password').value = '';
    // do not auto-login
    await auth.signOut();
    Swal.fire('Sukses','Pendaftaran berhasil. Silakan login menggunakan panel sebelah.','success');
    clearRegister();
  }catch(e){ console.error(e); err(e.message || String(e)); }
}

function clearRegister(){
  ['reg_nama','reg_hp','reg_password','reg_blok','reg_no','reg_rt','reg_rw','reg_alamat'].forEach(id=>{ if($(id)) $(id).value=''; });
  $('reg_status').selectedIndex = 0;
  $('reg_prov').selectedIndex = 0;
  $('reg_kab').innerHTML = '<option value="">Pilih Kabupaten/Kota</option>';
  $('reg_kec').innerHTML = '<option value="">Pilih Kecamatan</option>';
  $('reg_des').innerHTML = '<option value="">Pilih Desa</option>';
  $('reg_dus').innerHTML = '<option value="">Pilih Dusun</option>';
}

/* ================== LOGIN ================== */
async function onLogin(){
  const hp = $('login_hp').value.trim();
  const pass = $('login_pass').value;
  if(!hp || !pass) return err("Nomor HP & password wajib");
  try{
    const norm = normalizePhoneForKey(hp);
    const email = norm + "@dusun.fake";
    await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
    const cred = await auth.signInWithEmailAndPassword(email, pass);
    currentUser = cred.user;
    await loadProfileAndShow();
    $('login_pass').value = ''; // clear password
    toast("Login berhasil");
  }catch(e){ console.error(e); err(e.message || String(e)); }
}

/* ================== AUTH STATE LISTENER ================== */
auth.onAuthStateChanged(async u=>{
  if(u){
    currentUser = u;
    try{ await loadProfileAndShow(); } catch(e){ console.warn(e); showAuth(); }
  } else {
    currentUser = null; currentWarga = null; currentDusun = null;
    showAuth();
  }
});

function showAuth(){ show('authCard'); hide('dashboardCard'); }
function showDashboard(){ hide('authCard'); show('dashboardCard'); }

/* ================== LOAD PROFILE & INIT DASHBOARD ================== */
async function loadProfileAndShow(){
  if(!auth.currentUser) return;
  const uid = auth.currentUser.uid;
  const doc = await db.collection('Warga').doc(uid).get();
  if(!doc.exists){ // profile missing
    showAuth(); return;
  }
  currentWarga = { id: doc.id, data: doc.data() };
  // show dashboard with profile data
  $('display_name').innerText = currentWarga.data.nama || '';
  $('display_role').innerText = (currentWarga.data.role || '').toUpperCase();
  $('display_status').innerText = (currentWarga.data.status || '').toUpperCase();
  showDashboard();

  // show buttons based on role
  const kepalaRoles = ['kepala_desa','kepala_dusun','ketua_rt_rw','kepala_keluarga','istri_kepala_dusun'];
  if(kepalaRoles.includes(currentWarga.data.role)){
    show('createDusunCard'); show('btnOpenPosForm'); show('posList');
  } else {
    hide('createDusunCard');
  }

  // if user already has kodeDusun, load details
  if(currentWarga.data.kodeDusun){
    await loadDusunByCode(currentWarga.data.kodeDusun);
    loadPosList();
    loadMarkers();
    subscribeReports();
  } else {
    // show join panel
    show('joinDusunCard');
    $('kepalaInfo').innerHTML = '<div class="muted">Anda belum bergabung dengan dusun manapun.</div>';
    $('posList').innerHTML = '<div class="muted">Gabung dusun untuk melihat pos.</div>';
    renderEmptyReports();
  }

  refreshFamilyList();
  loadRegionDropdowns(); // ensure dropdowns present
  loadDusunDropdown();   // fill dusun dropdown for registration
  loadKejadianOptions();
  initMainMap();
}

/* ================== DUSUN BY CODE ================== */
async function loadDusunByCode(code){
  try{
    const snap = await db.collection('Dusun').where('kode','==',code).limit(1).get();
    if(snap.empty){ $('kepalaInfo').innerHTML = '<div class="muted">Dusun tidak ditemukan.</div>'; return; }
    const doc = snap.docs[0]; currentDusun = { id: doc.id, data: doc.data() };
    const d = currentDusun.data;
    const kepalaAlamat = d.kepalaAlamat || (currentWarga.data.alamat || '-');
    $('kepalaInfo').innerHTML = `<div><strong>${escapeHtml(d.kepalaNama||'-')}</strong></div><div class="muted small">HP: ${escapeHtml(d.kepalaHp||'-')}</div><div class="muted small">Alamat: ${escapeHtml(kepalaAlamat||'-')}</div>`;
    // if current user is kepala and is the kepalaId, show code
    if(currentWarga.data.role && currentWarga.data.role.includes('kepala') && currentWarga.id === d.kepalaId){
      show('myDusunCode'); $('myDusunCode').innerText = 'Kode dusun: ' + (d.kode||'');
    } else {
      hide('myDusunCode');
    }
    // hide join card if already in dusun
    hide('joinDusunCard');
  }catch(e){ console.error(e); }
}

/* ================== CREATE DUSUN (only kepala) ================== */
async function createDusun(){
  if(!currentWarga) return err("Login dulu");
  const kepalaRoles = ['kepala_desa','kepala_dusun','ketua_rt_rw','kepala_keluarga','istri_kepala_dusun'];
  if(!kepalaRoles.includes(currentWarga.data.role)) return err("Hanya subrole kepala boleh membuat dusun");
  const nama = $('dusun_nama').value.trim();
  if(!nama) return err("Nama dusun wajib");
  try{
    const kode = generateCode(6);
    const payload = {
      nama, kode,
      kepalaId: currentWarga.id,
      kepalaNama: currentWarga.data.nama,
      kepalaHp: currentWarga.data.phone || currentWarga.data.phone || '',
      kepalaAlamat: (currentWarga.data.blok||'') + (currentWarga.data.no?(' '+currentWarga.data.no):''),
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    await db.collection('Dusun').add(payload);
    // assign this kepala to the new dusun (update warga)
    await db.collection('Warga').doc(currentWarga.id).update({ kodeDusun: kode });
    currentWarga.data.kodeDusun = kode;
    toast("Dusun dibuat: " + kode);
    $('dusun_nama').value = '';
    await loadDusunByCode(kode);
    loadPosList();
    loadMarkers();
    subscribeReports();
    loadDusunDropdown();
  }catch(e){ console.error(e); err(e.message || String(e)); }
}

/* ================== JOIN DUSUN ================== */
async function joinDusun(){
  const kode = ($('join_kode').value || '').trim().toUpperCase();
  if(!kode) return err("Masukkan kode dusun");
  try{
    const snap = await db.collection('Dusun').where('kode','==',kode).limit(1).get();
    if(snap.empty) return err("Kode tidak ditemukan");
    await db.collection('Warga').doc(currentWarga.id).update({ kodeDusun: kode });
    currentWarga.data.kodeDusun = kode;
    toast("Berhasil gabung dusun " + kode);
    $('join_kode').value = '';
    await loadDusunByCode(kode);
    loadPosList();
    loadMarkers();
    subscribeReports();
  }catch(e){ console.error(e); err(e.message || String(e)); }
}

/* ================== MAIN MAP & MARKERS ================== */
function initMainMap(){
  if(mainMap) return;
  mainMap = L.map('map').setView([-6.2, 106.8166], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'Â© OpenStreetMap' }).addTo(mainMap);
  mainMarkers = L.layerGroup().addTo(mainMap);
}

async function loadMarkers(){
  if(!mainMap) initMainMap();
  mainMarkers.clearLayers();
  if(!currentWarga || !currentWarga.data.kodeDusun) return;
  try{
    const snap = await db.collection('PosDusun').where('dusunCode','==', currentWarga.data.kodeDusun).get();
    if(snap.empty) return;
    const bounds = [];
    snap.forEach(doc=>{
      const d = doc.data();
      if(d.lat && d.lng){
        const color = d.status === 'active' ? 'green' : 'red';
        const marker = L.circleMarker([d.lat, d.lng], { radius:8, color: color, fillColor: color, fillOpacity:0.9 }).addTo(mainMarkers);
        let popup = `<div><strong>${escapeHtml(d.nama||'-')}</strong></div><div class="muted small">RT/RW: ${escapeHtml(d.rt||'-')}/${escapeHtml(d.rw||'-')}</div><div class="muted small">Jenis: ${escapeHtml(d.jenis||'')}</div><div class="muted small">Status: ${escapeHtml(d.status||'')}</div><div class="muted small">Pembuat: ${escapeHtml(d.pembuatNama||'-')}</div>`;
        if(d.foto) popup += `<div style="margin-top:6px"><img src="${d.foto}" style="max-width:200px;border-radius:6px;"></div>`;
        marker.bindPopup(popup);
        bounds.push([d.lat,d.lng]);
      }
    });
    if(bounds.length) mainMap.fitBounds(bounds,{padding:[40,40],maxZoom:16});
  }catch(e){ console.error(e); }
}

/* ================== POS: FORM (inline modal) ================== */
function openPosForm(){
  if(!currentWarga) return err("Login dulu");
  const kepalaRoles = ['kepala_desa','kepala_dusun','ketua_rt_rw','kepala_keluarga','istri_kepala_dusun'];
  if(!kepalaRoles.includes(currentWarga.data.role)) return err("Hanya subrole kepala boleh menambah pos");
  // show modal
  show('posModal');
  // init map inside form (only once)
  setTimeout(()=>{ initPosFormMap(); }, 200);
}

function closePosForm(){
  hide('posModal');
  // clear form fields
  ['pos_name','pos_rt','pos_rw','pos_photo'].forEach(id=>{ if($(id)) $(id).value=''; });
  $('posPhotoPreview').innerHTML = '';
  tempChosenPos = { lat:null, lng:null };
  if(posFormMarker){ posFormMap.removeLayer(posFormMarker); posFormMarker=null; }
  if(posFormMap){ posFormMap.setView([-6.2,106.8166], 12); }
  $('chosenPosCoord').innerText = 'Lokasi belum ditetapkan.';
}

function initPosFormMap(){
  if(posFormMap) return;
  posFormMap = L.map('posFormMap').setView([-6.2,106.8166], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'Â© OpenStreetMap' }).addTo(posFormMap);
  posFormMap.on('click', function(e){
    tempChosenPos.lat = e.latlng.lat; tempChosenPos.lng = e.latlng.lng;
    if(posFormMarker) posFormMap.removeLayer(posFormMarker);
    posFormMarker = L.marker([tempChosenPos.lat, tempChosenPos.lng]).addTo(posFormMap);
    $('chosenPosCoord').innerText = `Terpilih: ${tempChosenPos.lat.toFixed(5)}, ${tempChosenPos.lng.toFixed(5)}`;
  });

  // preview photo handler
  $('pos_photo').addEventListener('change', function(){
    const f = this.files[0];
    if(!f) return;
    const url = URL.createObjectURL(f);
    $('posPhotoPreview').innerHTML = `<img src="${url}" class="pos-photo">`;
  });
}

function setPosLocationFromMap(){
  if(!tempChosenPos.lat || !tempChosenPos.lng) return err("Pilih titik di peta terlebih dahulu");
  $('chosenPosCoord').innerText = `Lokasi ditetapkan: ${tempChosenPos.lat.toFixed(6)}, ${tempChosenPos.lng.toFixed(6)}`;
  toast("Lokasi pos telah ditetapkan (jangan lupa Simpan Pos)");
}

/* ================== SAVE POS ================== */
async function savePos(){
  if(!currentWarga) return err("Login dulu");
  const name = $('pos_name').value.trim();
  const rt = $('pos_rt').value.trim();
  const rw = $('pos_rw').value.trim();
  const status = $('pos_status').value;
  const jenis = $('pos_jenis').value;
  const fotoFile = $('pos_photo').files[0];
  if(!name || !rt || !rw || !fotoFile) return err("Isi semua field dan upload foto pos (wajib)");
  if(!currentWarga.data.kodeDusun) return err("Anda belum tergabung dalam dusun");

  try{
    Swal.fire({ title:'Mengunggah foto...', didOpen: ()=> Swal.showLoading() });
    const path = `pos_photos/${Date.now()}_${fotoFile.name.replace(/\s+/g,'_')}`;
    const upTask = await storage.ref().child(path).put(fotoFile);
    const url = await upTask.ref.getDownloadURL();
    Swal.close();

    const payload = {
      nama: name,
      rt, rw,
      jenis,
      status,
      foto: url,
      fotoPath: path,
      pembuatId: currentWarga.id,
      pembuatNama: currentWarga.data.nama,
      pembuatRt: currentWarga.data.rt || rt,
      pembuatRw: currentWarga.data.rw || rw,
      pembuatDusun: currentWarga.data.kodeDusun || null,
      lat: tempChosenPos.lat || null,
      lng: tempChosenPos.lng || null,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      dusunCode: currentWarga.data.kodeDusun || null
    };
    await db.collection('PosDusun').add(payload);
    toast("Pos tersimpan");
    closePosForm();
    loadPosList();
    loadMarkers();
  }catch(e){ console.error(e); Swal.close(); err("Gagal simpan pos"); }
}

/* ================== LOAD POS LIST ================== */
async function loadPosList(){
  if(!currentWarga || !currentWarga.data.kodeDusun){ $('posList').innerHTML = '<div class="muted">Gabung dusun untuk melihat daftar pos.</div>'; return; }
  try{
    const snap = await db.collection('PosDusun').where('dusunCode','==', currentWarga.data.kodeDusun).orderBy('createdAt','desc').get();
    if(snap.empty){ $('posList').innerHTML = '<div class="muted">Belum ada pos.</div>'; return; }
    let html = '';
    snap.forEach(doc=>{
      const d = doc.data(); const id = doc.id;
      html += `<div class="p-2 border rounded mb-2"><div class="d-flex justify-content-between"><div><strong>${escapeHtml(d.nama)}</strong><div class="muted small">RT/RW: ${escapeHtml(d.rt||'-')}/${escapeHtml(d.rw||'-')}</div></div><div>`;
      html += `<button class="btn btn-sm btn-link" onclick="viewPos('${id}')">View</button>`;
      if(currentWarga.data.role === 'kepala_dusun') html += ` <button class="btn btn-sm btn-primary" onclick="editPos('${id}')">Edit</button> <button class="btn btn-sm btn-danger" onclick="deletePos('${id}')">Hapus</button>`;
      html += `</div></div>`;
      if(d.foto) html += `<div class="mt-2"><img src="${d.foto}" class="pos-photo"></div>`;
      html += `<div class="muted small mt-2">Pembuat: ${escapeHtml(d.pembuatNama||'-')}</div></div>`;
    });
    $('posList').innerHTML = html;
  }catch(e){ console.error(e); $('posList').innerHTML = '<div class="muted">Gagal muat pos</div>'; }
}

/* ================== VIEW / EDIT / DELETE POS ================== */
async function viewPos(id){
  try{
    const doc = await db.collection('PosDusun').doc(id).get();
    if(!doc.exists) return err("Pos tidak ditemukan");
    const d = doc.data();
    const html = `<div><strong>${escapeHtml(d.nama||'-')}</strong></div>
      <div class="muted small">RT/RW: ${escapeHtml(d.rt||'-')}/${escapeHtml(d.rw||'-')}</div>
      <div class="muted small">Jenis: ${escapeHtml(d.jenis||'')}</div>
      <div class="muted small">Status: ${(d.status||'').toUpperCase()}</div>
      <div class="muted small">Pembuat: ${escapeHtml(d.pembuatNama||'-')}</div>
      ${d.foto?`<div class="mt-2"><img src="${d.foto}" style="max-width:360px;border-radius:8px;"></div>`:''}`;
    $('posViewContent').innerHTML = html;
    show('posViewModal');
    setTimeout(()=>{ initPosViewMap(d.lat,d.lng); }, 200);
  }catch(e){ console.error(e); err("Gagal tampilkan pos"); }
}

function closePosView(){ hide('posViewModal'); if(posViewMap){ posViewMap.remove(); posViewMap=null; } }

function initPosViewMap(lat,lng){
  if(posViewMap) posViewMap.remove();
  posViewMap = L.map('posViewMap').setView([lat||-6.2, lng||106.8166], 15);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'Â© OpenStreetMap' }).addTo(posViewMap);
  if(lat && lng) L.marker([lat,lng]).addTo(posViewMap);
}

/* Edit pos (open as posForm with pre-filled) */
async function editPos(id){
  if(!currentWarga) return err("Login dulu");
  if(currentWarga.data.role !== 'kepala_dusun') return err("Hanya Kepala Dusun boleh edit pos");
  try{
    const doc = await db.collection('PosDusun').doc(id).get();
    if(!doc.exists) return err("Pos tidak ditemukan");
    const d = doc.data();
    // fill form
    $('pos_name').value = d.nama || '';
    $('pos_rt').value = d.rt || '';
    $('pos_rw').value = d.rw || '';
    $('pos_status').value = d.status || 'active';
    $('pos_jenis').value = d.jenis || 'pos_dusun';
    $('posPhotoPreview').innerHTML = d.foto ? `<img src="${d.foto}" class="pos-photo">` : '';
    tempChosenPos.lat = d.lat || null; tempChosenPos.lng = d.lng || null;
    $('chosenPosCoord').innerText = tempChosenPos.lat ? `Terpilih: ${tempChosenPos.lat.toFixed(6)}, ${tempChosenPos.lng.toFixed(6)}` : 'Lokasi belum ditetapkan.';
    // open modal
    show('posModal'); setTimeout(()=>{ initPosFormMap(); if(tempChosenPos.lat && tempChosenPos.lng){ if(posFormMarker) posFormMap.removeLayer(posFormMarker); posFormMarker = L.marker([tempChosenPos.lat,tempChosenPos.lng]).addTo(posFormMap); posFormMap.setView([tempChosenPos.lat,tempChosenPos.lng],15); } },200);
    // change savePos to update pos (simple approach: overwrite by storing id on modal element)
    $('posModal').dataset.editingId = id;
  }catch(e){ console.error(e); err("Gagal edit pos"); }
}

/* Delete pos */
async function deletePos(id){
  if(!currentWarga) return err("Login dulu");
  if(currentWarga.data.role !== 'kepala_dusun') return err("Hanya Kepala Dusun boleh hapus pos");
  const conf = await Swal.fire({ title:'Hapus pos?', text:'Data akan dihapus permanen', icon:'warning', showCancelButton:true });
  if(!conf.isConfirmed) return;
  try{
    const doc = await db.collection('PosDusun').doc(id).get();
    if(doc.exists){
      const d = doc.data();
      if(d.fotoPath){ try{ await storage.ref().child(d.fotoPath).delete(); }catch(e){ console.warn(e); } }
      await db.collection('PosDusun').doc(id).delete();
      toast("Pos dihapus");
      loadPosList(); loadMarkers();
    } else err("Pos tidak ditemukan");
  }catch(e){ console.error(e); err("Gagal hapus pos"); }
}

/* ================== SAVE POS (support update) ================== */
async function savePos(){
  // if editing id exists -> update; else add new
  const editingId = $('posModal').dataset.editingId || null;
  if(editingId){ await updatePos(editingId); return; }
  await savePosNew();
}

/* update existing pos */
async function updatePos(id){
  if(!currentWarga) return err("Login dulu");
  try{
    const docRef = db.collection('PosDusun').doc(id);
    const doc = await docRef.get();
    if(!doc.exists) return err("Pos tidak ditemukan");
    const d = doc.data();
    const name = $('pos_name').value.trim();
    const rt = $('pos_rt').value.trim();
    const rw = $('pos_rw').value.trim();
    const status = $('pos_status').value;
    const jenis = $('pos_jenis').value;
    const fotoFile = $('pos_photo').files[0];
    let fotoUrl = d.foto, fotoPath = d.fotoPath || null;
    if(fotoFile){
      // delete old
      try{ if(fotoPath) await storage.ref().child(fotoPath).delete(); }catch(e){ console.warn(e); }
      const path = `pos_photos/${Date.now()}_${fotoFile.name.replace(/\s+/g,'_')}`;
      const up = await storage.ref().child(path).put(fotoFile);
      fotoUrl = await up.ref.getDownloadURL();
      fotoPath = path;
    }
    await docRef.update({
      nama: name, rt, rw, status, jenis, foto: fotoUrl, fotoPath, lat: tempChosenPos.lat || null, lng: tempChosenPos.lng || null, updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    toast("Pos diperbarui");
    delete $('posModal').dataset.editingId;
    closePosForm();
    loadPosList();
    loadMarkers();
  }catch(e){ console.error(e); err("Gagal update pos"); }
}

async function savePosNew(){
  if(!currentWarga) return err("Login dulu");
  try{
    const name = $('pos_name').value.trim();
    const rt = $('pos_rt').value.trim();
    const rw = $('pos_rw').value.trim();
    const status = $('pos_status').value;
    const jenis = $('pos_jenis').value;
    const fotoFile = $('pos_photo').files[0];
    if(!name || !rt || !rw || !fotoFile) return err("Isi semua field dan upload foto pos (wajib)");
    if(!tempChosenPos.lat || !tempChosenPos.lng) return err("Tentukan lokasi pos pada peta");

    Swal.fire({ title:'Mengunggah foto...', didOpen: ()=> Swal.showLoading() });
    const path = `pos_photos/${Date.now()}_${fotoFile.name.replace(/\s+/g,'_')}`;
    const up = await storage.ref().child(path).put(fotoFile);
    const url = await up.ref.getDownloadURL();
    Swal.close();

    const payload = {
      nama: name, rt, rw, status, jenis, foto: url, fotoPath: path,
      pembuatId: currentWarga.id, pembuatNama: currentWarga.data.nama,
      pembuatRt: currentWarga.data.rt || rt, pembuatRw: currentWarga.data.rw || rw,
      pembuatDusun: currentWarga.data.kodeDusun || null,
      lat: tempChosenPos.lat, lng: tempChosenPos.lng,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      dusunCode: currentWarga.data.kodeDusun || null
    };
    await db.collection('PosDusun').add(payload);
    toast("Pos tersimpan");
    closePosForm(); loadPosList(); loadMarkers();
  }catch(e){ console.error(e); err("Gagal simpan pos"); }
}

/* ================== KEJADIAN OPTIONS (SOS card) ================== */
function loadKejadianOptions(){
  const types = [
    { key:'Kebakaran', icon:'ðŸ”¥' },
    { key:'Kemalingan', icon:'ðŸ›‘' },
    { key:'Medis', icon:'ðŸ¥' },
    { key:'Ambulance', icon:'ðŸš‘' },
    { key:'Mencurigakan', icon:'ðŸ‘€' }
  ];
  const container = $('kejadianGrid'); container.innerHTML = '';
  types.forEach(t=>{
    const el = document.createElement('div'); el.className='kejadian-option';
    el.innerHTML = `<div style="font-size:28px">${t.icon}</div><span>${t.key}</span>`;
    el.onclick = ()=> { selectKejadian(t.key, t.icon); };
    container.appendChild(el);
  });
  // store default selected
  window._selectedKejadian = null;
}
function selectKejadian(key, icon){
  window._selectedKejadian = key;
  // visually mark selected
  Array.from(document.querySelectorAll('.kejadian-option')).forEach(el=>el.style.borderColor='#eee');
  const found = Array.from(document.querySelectorAll('.kejadian-option')).find(el=>el.innerText.includes(key));
  if(found) found.style.borderColor = '#3b82f6';
}

/* ================== OPEN SOS (submit) ================== */
async function openSOS(){
  // pick selected type or ask
  const jenis = window._selectedKejadian || null;
  if(!jenis) return err("Pilih jenis kejadian terlebih dahulu");
  // lokasi option
  const locOpt = $('lap_loc_opt').value;
  let desc = null;
  if(locOpt === 'lainnya'){
    const { value: input } = await Swal.fire({ title:'Deskripsi lokasi', input: 'text', inputPlaceholder: 'Jelaskan alamat atau titik', showCancelButton:true });
    if(!input) return;
    desc = input;
  }
  // gps if needed
  let lat=null,lng=null;
  try{
    if(navigator.geolocation){
      const pos = await new Promise((res,rej)=> navigator.geolocation.getCurrentPosition(res,rej,{ timeout:10000 }));
      lat = pos.coords.latitude; lng = pos.coords.longitude;
    }
  }catch(e){ console.warn('gps denied'); }
  // send report
  if(!currentWarga || !currentWarga.data.kodeDusun) return err("Anda belum bergabung ke dusun");
  try{
    await db.collection('Laporan').add({
      jenis, lokasiDeskripsi: desc || null, tempat: locOpt, lat, lng,
      userId: currentWarga.id, userNama: currentWarga.data.nama, dusunCode: currentWarga.data.kodeDusun,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(), status:'open'
    });
    toast("Laporan terkirim!");
    // refresh lists
    fetchReports();
  }catch(e){ console.error(e); err("Gagal kirim laporan"); }
}

/* ================== REPORTS: fetch and render ================== */
let reportsCache = [];
async function subscribeReports(){
  if(!currentWarga || !currentWarga.data.kodeDusun) return renderEmptyReports();
  const since = new Date(Date.now() - 90*24*60*60*1000); // fetch recent 90d for good measure
  db.collection('Laporan').where('dusunCode','==', currentWarga.data.kodeDusun).where('createdAt','>=', firebase.firestore.Timestamp.fromDate(since)).orderBy('createdAt','desc')
    .onSnapshot(snap=>{
      reportsCache = [];
      snap.forEach(d => reportsCache.push({ id:d.id, data:d.data() }));
      renderReportsFromCache();
      renderStatsFromCache();
    }, e => console.error(e));
}

function fetchReports(){ if(currentWarga && currentWarga.data.kodeDusun) subscribeReports(); else renderEmptyReports(); }

function renderReportsFromCache(){
  // split my reports & others
  const my = reportsCache.filter(r => r.data.userId === currentWarga.id);
  const others = reportsCache.filter(r => r.data.userId !== currentWarga.id);
  // my
  const myEl = $('myReports'); const otherEl = $('otherReports');
  if(!my.length) myEl.innerHTML = '<div class="muted">Belum ada laporan Anda.</div>'; else {
    myEl.innerHTML = my.map(r => `<div class="p-2 border rounded mb-2"><strong>${escapeHtml(r.data.jenis||'-')}</strong> <div class="muted small">${r.data.lokasiDeskripsi||''} Â· ${r.data.createdAt ? new Date(r.data.createdAt.seconds*1000).toLocaleString() : '-'}</div></div>`).join('');
  }
  if(!others.length) otherEl.innerHTML = '<div class="muted">Belum ada laporan warga lain.</div>'; else {
    otherEl.innerHTML = others.map(r => `<div class="p-2 border rounded mb-2"><strong>${escapeHtml(r.data.jenis||'-')}</strong><div class="muted small">Oleh: ${escapeHtml(r.data.userNama||'')} Â· ${r.data.createdAt ? new Date(r.data.createdAt.seconds*1000).toLocaleString() : '-'}</div><div class="muted small">${r.data.lokasiDeskripsi||''}</div></div>`).join('');
  }
}

/* render empty reports */
function renderEmptyReports(){
  $('myReports').innerHTML = '<div class="muted">Tidak ada laporan</div>';
  $('otherReports').innerHTML = '<div class="muted">Tidak ada laporan</div>';
}

/* ================== STATISTICS (30 hari) ================== */
function renderStatsFromCache(){
  const since = new Date(Date.now() - 30*24*60*60*1000);
  const recent = reportsCache.filter(r => r.data.createdAt && new Date(r.data.createdAt.seconds*1000) >= since);
  const labels = ['Kebakaran','Kemalingan','Medis','Ambulance','Mencurigakan'];
  const counts = labels.map(l => recent.filter(x => x.data.jenis === l).length);
  const total = counts.reduce((s,v)=>s+v,0);
  // chart
  if(chartKej) chartKej.destroy();
  const ctx = $('chartKejadian').getContext('2d');
  chartKej = new Chart(ctx,{ type:'bar', data:{ labels, datasets:[{ label:'Jumlah', data:counts, backgroundColor:['#ef4444','#f59e0b','#16a34a','#3b82f6','#9b59b6'] }] }, options:{ responsive:true, maintainAspectRatio:false }});
  // category
  let cat='AMAN', cls='status-aman';
  if(total>=20){ cat='RAWAN'; cls='status-rawan'; } else if(total>=6){ cat='WASPADA'; cls='status-waspada'; }
  $('statSummary').innerHTML = `<div>Total 30 hari: <strong>${total}</strong> Â· <span class="${cls}">${cat}</span></div>`;
  // table with percentages
  let html = '<table class="table table-sm mt-2"><thead><tr><th>Jenis</th><th>Jumlah</th><th>Persen</th></tr></thead><tbody>';
  labels.forEach((l,i)=>{ const c = counts[i]; const pct = total ? Math.round(c/total*100) : 0; html += `<tr><td>${l}</td><td>${c}</td><td style="width:60%"><div class="progress"><div class="progress-bar" role="progressbar" style="width:${pct}%">${pct}%</div></div></td></tr>`; });
  html += '</tbody></table>';
  $('statSummary').innerHTML += html;
}

/* ================== FAMILY LIST (alamat sama) ================== */
async function refreshFamilyList(){
  if(!currentWarga) return;
  if(!currentWarga.data.kodeDusun){ $('familyList').innerHTML = '<div class="muted">Belum gabung dusun</div>'; return; }
  try{
    // fetch all warga in same dusun, filter by identical alamat, blok, no, rt, rw
    const snap = await db.collection('Warga').where('kodeDusun','==', currentWarga.data.kodeDusun).get();
    if(snap.empty){ $('familyList').innerHTML = '<div class="muted">Tidak ada anggota</div>'; return; }
    const list = [];
    snap.forEach(doc => { list.push({ id:doc.id, data:doc.data() }); });
    const keyComparator = (d) => `${d.alamat||''}|${d.blok||''}|${d.no||''}|${d.rt||''}|${d.rw||''}`;
    const myKey = keyComparator(currentWarga.data);
    const myMembers = list.filter(x => keyComparator(x.data) === myKey);
    if(!myMembers.length) { $('familyList').innerHTML = '<div class="muted">Belum ada anggota keluarga di alamat ini</div>'; return; }
    let html = '<table class="table table-sm"><thead><tr><th>Nama</th><th>Role</th><th>Status</th><th>Aksi</th></tr></thead><tbody>';
    myMembers.forEach(m => {
      const d = m.data;
      let aksi = '';
      // verifikasi by kepala roles
      const kepalaRoles = ['kepala_desa','kepala_dusun','ketua_rt_rw','kepala_keluarga','istri_kepala_dusun'];
      if(kepalaRoles.includes(currentWarga.data.role) && m.id !== currentWarga.id){
        aksi = d.status !== 'aktif' ? `<button class="btn btn-sm btn-success" onclick="approveUser('${m.id}')">Verifikasi</button>` : '<span class="muted small">Terverifikasi</span>';
      }
      html += `<tr><td>${escapeHtml(d.nama||'')}</td><td>${escapeHtml(d.role||'')}</td><td>${escapeHtml(d.status||'')}</td><td>${aksi}</td></tr>`;
    });
    html += '</tbody></table>';
    $('familyList').innerHTML = html;
  }catch(e){ console.error(e); $('familyList').innerHTML = '<div class="muted">Gagal muat keluarga</div>'; }
}

/* approve user (for kepala) */
async function approveUser(uid){
  try{ await db.collection('Warga').doc(uid).update({ status:'aktif', approvedBy: currentWarga.id, approvedAt: firebase.firestore.FieldValue.serverTimestamp() }); toast("Warga disetujui"); refreshFamilyList(); loadPendingList(); } catch(e){ console.error(e); err("Gagal approve"); }
}

/* pending list load */
async function loadPendingList(){
  // list pending in current dusun, only for kepala
  const kepalaRoles = ['kepala_desa','kepala_dusun','ketua_rt_rw','kepala_keluarga','istri_kepala_dusun'];
  if(!currentWarga || !kepalaRoles.includes(currentWarga.data.role) || !currentWarga.data.kodeDusun) { $('pendingList') && ($('pendingList').innerHTML=''); return; }
  try{
    const snap = await db.collection('Warga').where('kodeDusun','==', currentWarga.data.kodeDusun).where('status','==','pending').get();
    const container = $('pendingList');
    if(!container) return;
    if(snap.empty){ container.innerHTML = '<div class="muted">Tidak ada pendaftar pending</div>'; return; }
    let html=''; snap.forEach(doc => { const d = doc.data(); html += `<div class="d-flex justify-content-between align-items-center mb-2"><div><strong>${escapeHtml(d.nama||'')}</strong><div class="muted small">${escapeHtml(d.phone||'')}</div></div><div><button class="btn btn-sm btn-success" onclick="approveUser('${doc.id}')">Setujui</button></div></div>`; });
    container.innerHTML = html;
  }catch(e){ console.error(e); }
}

/* ================== UTILS ================== */
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function generateCode(len=6){ return Math.random().toString(36).substring(2,2+len).toUpperCase(); }

/* ================== INITIAL LOAD ================== */
(async function init(){
  try{
    loadRegionDropdowns();
    loadDusunDropdown();
    initMainMap();
    loadKejadianOptions();
    // Load some dummy data if collections are empty (for demo)
    const dSnap = await db.collection('Dusun').limit(1).get();
    if(dSnap.empty){
      const kode = 'DUSUN'+generateCode(3);
      await db.collection('Dusun').add({ nama:'Dusun Demo', kode, desa:'Desa Demo', createdAt: firebase.firestore.FieldValue.serverTimestamp() });
    }
  }catch(e){ console.warn(e); }
})();

</script>
</body>
</html>
