<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sistem Keamanan Dusun - FULL (All-in-one)</title>

<!-- Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- Firebase compat (easy namespaced API: firebase.firestore(), etc.) -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  body { background:#f4f7ff; font-family:Inter, 'Segoe UI', Arial, sans-serif; }
  .card { border-radius:12px; box-shadow:0 6px 18px rgba(20,30,60,0.06); }
  .form-control, .btn { border-radius:8px; }
  #map { width:100%; height:320px; border-radius:8px; background:#eef; }
  .small-muted { font-size:.9rem; color:#555; }
  .hidden { display:none !important; }
  .input-copy { display:flex; gap:8px; }
</style>
</head>
<body>
<div class="container py-4">
  <div class="mx-auto" style="max-width:1100px;">
    <h3 class="text-center mb-3">Sistem Keamanan Dusun — FULL</h3>

    <!-- TOP: Create Dusun / Register / Login -->
    <div id="authCard" class="card p-3 mb-4">
      <div class="row g-3">
        <!-- Create Dusun -->
        <div class="col-md-6">
          <h5>Buat Dusun (Kepala Dusun)</h5>
          <input id="dusun_nama" class="form-control mb-2" placeholder="Nama Dusun">
          <input id="dusun_desa" class="form-control mb-2" placeholder="Desa">
          <input id="dusun_kota" class="form-control mb-2" placeholder="Kota">
          <input id="dusun_kab" class="form-control mb-2" placeholder="Kabupaten">
          <input id="dusun_kec" class="form-control mb-2" placeholder="Kecamatan">

          <!-- KODE FIELD (muncul setelah Generate) -->
          <div id="kodeGroup" class="input-copy mb-2 hidden">
            <input id="dusun_code" class="form-control" placeholder="Kode Dusun" readonly>
            <button id="copyCodeBtn" class="btn btn-outline-secondary">Copy</button>
          </div>

          <div class="d-grid gap-2">
            <button id="btnGenerate" class="btn btn-primary" onclick="generateDusunCode()">Generate Kode</button>
            <button id="btnSaveDusun" class="btn btn-success hidden" onclick="saveDusun()">Simpan Dusun</button>
          </div>
          <div class="small-muted mt-2">Setelah generate: salin kode & bagikan ke warga. Kepala Dusun akan melihat kode ini di dashboard (hanya kepala dusun).</div>
        </div>

        <!-- Register + Login -->
        <div class="col-md-6">
          <h5>Daftar Warga</h5>
          <input id="reg_nama" class="form-control mb-2" placeholder="Nama lengkap">
          <input id="reg_hp" class="form-control mb-2" placeholder="No HP (dipakai sebagai username)">
          <input id="reg_alamat" class="form-control mb-2" placeholder="Alamat (jalan)">
          <input id="reg_blok" class="form-control mb-2" placeholder="Blok (opsional)">
          <input id="reg_no" class="form-control mb-2" placeholder="No Rumah (opsional)">
          <div class="row g-2 mb-2">
            <div class="col"><input id="reg_rt" class="form-control" placeholder="RT"></div>
            <div class="col"><input id="reg_rw" class="form-control" placeholder="RW"></div>
          </div>
          <select id="reg_role" class="form-control mb-2">
            <option value="kepala_desa">Kepala Desa</option>
            <option value="kepala_dusun">Kepala Dusun</option>
            <option value="ketua_rt">Ketua RT</option>
            <option value="ketua_rw">Ketua RW</option>
            <option value="kepala_keluarga">Kepala Keluarga</option>
            <option value="istri">Istri</option>
            <option value="anak">Anak</option>
            <option value="lainnya">Lainnya</option>
          </select>
          <input id="reg_kodeDusun" class="form-control mb-2" placeholder="Kode Dusun (dapat dari Kepala Dusun)">
          <input id="reg_password" type="password" class="form-control mb-2" placeholder="Password">
          <div class="d-grid gap-2 mb-2">
            <button class="btn btn-success" onclick="registerUser()">Daftar</button>
            <button class="btn btn-outline-secondary" onclick="clearRegisterForm()">Reset</button>
          </div>

          <hr>

          <h5>Login</h5>
          <input id="login_hp" class="form-control mb-2" placeholder="No HP">
          <input id="login_password" type="password" class="form-control mb-2" placeholder="Password">
          <div class="d-grid gap-2">
            <button class="btn btn-primary" onclick="login()">Login</button>
          </div>
        </div>
      </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboardCard" class="card p-3 hidden">
      <div class="d-flex justify-content-between align-items-start">
        <div>
          <h4>Dashboard Dusun</h4>
          <div class="small-muted">Selamat datang, <b id="displayName"></b> · <span id="realtimeClock"></span></div>
        </div>
        <div class="text-end">
          <button class="btn btn-danger btn-sm" onclick="logout()">Logout</button>
        </div>
      </div>

      <!-- Kode tampil hanya kepala_dusun -->
      <div id="kodeDashboard" class="card p-3 mt-3 d-none">
        <div class="d-flex justify-content-between align-items-center">
          <div><div class="small-muted">Kode Dusun</div><h5 id="displayCode"></h5></div>
          <div><div class="small-muted">Sisa waktu</div><div id="displayCountdown" style="font-weight:600"></div></div>
        </div>
      </div>

      <div class="row mt-3 g-3">
        <div class="col-lg-5">
          <!-- Laporan SOS -->
          <div class="card p-3 mb-3">
            <h6>Buat Laporan SOS</h6>
            <select id="lap_jenis" class="form-control mb-2">
              <option>Kemalingan</option>
              <option>Kebakaran</option>
              <option>Medis</option>
              <option>Ambulance</option>
              <option>Mencurigakan</option>
            </select>
            <select id="lap_lokasiOpt" class="form-control mb-2" onchange="toggleLokasiField()">
              <option value="saat_ini">Lokasi Saat Ini</option>
              <option value="lainnya">Lokasi Lain</option>
            </select>
            <textarea id="lap_lokasiDesc" class="form-control mb-2 hidden" placeholder="Deskripsi lokasi (opsional)"></textarea>
            <div class="d-grid">
              <button class="btn btn-danger" onclick="sendReport()">Kirim Laporan</button>
            </div>
          </div>

          <!-- Statistik -->
          <div class="card p-3 mb-3">
            <h6>Statistik Kejadian</h6>
            <canvas id="chartKejadian" style="width:100%;height:220px"></canvas>
          </div>

          <div class="card p-3">
            <h6>Daftar Laporan Terbaru</h6>
            <div id="listReports"></div>
          </div>
        </div>

        <div class="col-lg-7">
          <div class="card p-3 mb-3">
            <h6>Pos Jaga Dusun</h6>
            <div id="map">Memuat peta...</div>
            <div class="d-flex gap-2 mt-3">
              <button class="btn btn-primary" onclick="promptAddPos()">Tambah Pos RT</button>
              <button class="btn btn-outline-secondary" onclick="loadPos()">Muat Ulang Pos</button>
            </div>
            <div id="listPos" class="mt-3"></div>
          </div>
        </div>
      </div>

    </div>

  </div>
</div>

<!-- Google Maps API - GANTI KEY -->
<script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY"></script>

<script>
/* ================= Firebase init ================= */
const firebaseConfig = {
  apiKey: "AIzaSyA6GAeIc7ZesIed9MAelUf6x_sBFdp9E-Q",
  authDomain: "dusun-super.firebaseapp.com",
  projectId: "dusun-super",
  storageBucket: "dusun-super.firebasestorage.app",
  messagingSenderId: "1083284057385",
  appId: "1:1083284057385:web:21cfe467b047bb5a241b38",
  measurementId: "G-LJ6KP57Q9M"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ================= State ================= */
let currentUser = null;      // { id, nama, hp, role, dusunId, ... }
let currentDusunId = null;
let map = null;
let markers = [];
let laporanChart = null;
let kodeUnsubscribe = null;
let kodeInterval = null;

/* ================= Helpers ================= */
const $ = id => document.getElementById(id);
const show = id => $(id).classList.remove('hidden');
const hide = id => $(id).classList.add('hidden');
const toast = txt => alert(txt);

/* ================ Create Dusun ================ */
function generateDusunCode(){
  const code = "DSN" + Math.random().toString(36).substring(2,8).toUpperCase();
  $('dusun_code').value = code;
  show('kodeGroup');
  hide('btnGenerate');
  show('btnSaveDusun');
}
$('copyCodeBtn').addEventListener('click', ()=>{
  const v = $('dusun_code').value;
  if(!v) return toast("Belum ada kode.");
  navigator.clipboard?.writeText(v).then(()=> toast("Kode disalin ke clipboard."));
});

async function saveDusun(){
  const nama = $('dusun_nama').value.trim();
  const desa = $('dusun_desa').value.trim();
  const kota = $('dusun_kota').value.trim();
  const kab = $('dusun_kab').value.trim();
  const kec = $('dusun_kec').value.trim();
  const code = $('dusun_code').value.trim();
  if(!nama||!desa||!kota||!kab||!kec||!code) return toast("Lengkapi field & generate kode.");

  const codeExpiresAt = Date.now() + 3600000; // 1 jam
  try{
    const docRef = await db.collection('dusun').add({
      nama, desa, kota, kabupaten: kab, kecamatan: kec,
      code, codeExpiresAt, createdAt: Date.now()
    });
    toast("Dusun tersimpan. Kode: " + code);
    // keep code visible so Kepala Dusun bisa copy/share
    hide('btnSaveDusun');
    show('btnGenerate');
  }catch(e){
    console.error(e); toast("Gagal simpan dusun: " + e.message);
  }
}

/* ================ Register User (with duplicate check) ================ */
async function registerUser(){
  const nama = $('reg_nama').value.trim();
  const hp = $('reg_hp').value.trim();
  const alamat = $('reg_alamat').value.trim();
  const blok = $('reg_blok').value.trim();
  const no = $('reg_no').value.trim();
  const rt = $('reg_rt').value.trim();
  const rw = $('reg_rw').value.trim();
  const role = $('reg_role').value;
  const kodeDusun = $('reg_kodeDusun').value.trim();
  const pass = $('reg_password').value;

  if(!nama||!hp||!pass||!kodeDusun) return toast("Nama, No HP, Password, dan Kode Dusun wajib diisi.");

  // duplicate check: user doc id = hp (simple)
  const userDoc = await db.collection('users').doc(hp).get();
  if(userDoc.exists) return toast("Nomor HP sudah terdaftar — 1 nomor hanya bisa untuk 1 user/dusun.");

  // validate dusun code
  const q = await db.collection('dusun').where('code','==',kodeDusun).get();
  if(q.empty) return toast("Kode Dusun tidak valid. Pastikan kode dari Kepala Dusun.");

  const dusunDoc = q.docs[0];
  const dusunId = dusunDoc.id;

  try{
    await db.collection('users').doc(hp).set({
      nama, hp, alamat, blok, no, rt, rw,
      role, dusunId, password: pass, createdAt: Date.now()
    });
    toast("Pendaftaran berhasil — silakan login.");
    clearRegisterForm();
  }catch(e){
    console.error(e);
    toast("Gagal daftar: " + e.message);
  }
}

function clearRegisterForm(){
  $('reg_nama').value=''; $('reg_hp').value=''; $('reg_alamat').value='';
  $('reg_blok').value=''; $('reg_no').value=''; $('reg_rt').value=''; $('reg_rw').value='';
  $('reg_role').selectedIndex=0; $('reg_kodeDusun').value=''; $('reg_password').value='';
}

/* ================ Login ================ */
async function login(){
  const hp = $('login_hp').value.trim();
  const pw = $('login_password').value;
  if(!hp||!pw) return toast("Isi No HP & Password");

  const doc = await db.collection('users').doc(hp).get();
  if(!doc.exists) return toast("User tidak ditemukan");
  const user = doc.data();
  if(user.password !== pw) return toast("Password salah");

  // set current user
  currentUser = { id: doc.id, ...user };
  currentDusunId = user.dusunId || null;

  // show dashboard
  hide('authCard');
  show('dashboardCard');
  $('displayName').innerText = currentUser.nama || currentUser.hp;

  startRealtimeClock();

  // if kepala dusun: show code and listen for changes & rotate when expired
  if(currentUser.role === 'kepala_dusun'){
    // ensure currentDusunId exists (it should, since registration stored dusunId)
    if(currentDusunId){
      show('kodeDashboard');
      startDusunCodeWatcher(currentDusunId, true);
    } else {
      // try to find dusun where createdBy? (not implemented). Warn user:
      toast("Anda Kepala Dusun tetapi tidak terkait ke Dusun manapun. Pastikan daftar dengan Kode Dusun yang dibuat.");
    }
  } else {
    hide('kodeDashboard');
  }

  // load map, pos, laporan, chart
  initMapWhenReady();
  loadPos();
  loadReportsAndChart();

  // realtime updates to reports
  if(currentDusunId){
    db.collection('laporan').where('dusunId','==',currentDusunId)
      .onSnapshot(()=> loadReportsAndChart());
  }
}

/* ================ Logout ================ */
function logout(){
  currentUser = null; currentDusunId = null;
  // stop watchers
  if(kodeUnsubscribe){ kodeUnsubscribe(); kodeUnsubscribe = null; }
  if(kodeInterval){ clearInterval(kodeInterval); kodeInterval = null; }
  // UI
  show('authCard'); hide('dashboardCard');
}

/* ================ Realtime Clock ================ */
function startRealtimeClock(){
  setInterval(()=>{
    $('realtimeClock').innerText = new Date().toLocaleString('id-ID', { weekday:'long', year:'numeric', month:'long', day:'numeric', hour:'2-digit', minute:'2-digit', second:'2-digit' });
  },1000);
}

/* ================ Reports (SOS) ================ */
function toggleLokasiField(){
  const v = $('lap_lokasiOpt').value;
  if(v === 'lainnya') $('lap_lokasiDesc').classList.remove('hidden'); else $('lap_lokasiDesc').classList.add('hidden');
}

async function sendReport(){
  if(!currentUser) return toast("Login dulu untuk mengirim laporan.");
  const jenis = $('lap_jenis').value;
  const lokasiOpt = $('lap_lokasiOpt').value;
  const lokasi = lokasiOpt === 'lainnya' ? $('lap_lokasiDesc').value.trim() : 'Lokasi Saat Ini';
  if(!jenis) return toast("Pilih jenis kejadian");
  try{
    await db.collection('laporan').add({
      dusunId: currentDusunId,
      uid: currentUser.id,
      jenis, lokasi, createdAt: Date.now()
    });
    toast("Laporan tersimpan.");
    $('lap_lokasiDesc').value='';
    loadReportsAndChart();
  }catch(e){ console.error(e); toast("Gagal kirim laporan: " + e.message); }
}

/* ================ Load Reports & Chart ================ */
async function loadReportsAndChart(){
  if(!currentDusunId) return;
  const snap = await db.collection('laporan').where('dusunId','==',currentDusunId).orderBy('createdAt','desc').limit(200).get();
  const rows = snap.docs.map(d=>({ id:d.id, ...d.data() }));
  // list
  const list = $('listReports'); list.innerHTML = '';
  if(rows.length === 0) list.innerHTML = '<div class="small-muted">Belum ada laporan.</div>';
  rows.slice(0,30).forEach(r=>{
    const t = new Date(r.createdAt).toLocaleString();
    const el = document.createElement('div'); el.className='mb-2';
    el.innerHTML = `<div><b>${r.jenis}</b> — ${r.lokasi||''}</div><div class="small-muted">${t}</div>`;
    list.appendChild(el);
  });
  // chart
  const counts = {};
  rows.forEach(r => counts[r.jenis] = (counts[r.jenis]||0) + 1);
  const labels = Object.keys(counts).length ? Object.keys(counts) : ['Belum ada'];
  const data = labels.map(l => counts[l] || 0);
  if(laporanChart) laporanChart.destroy();
  const ctx = document.getElementById('chartKejadian').getContext('2d');
  laporanChart = new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets: [{ label:'Jumlah', data, backgroundColor: labels.map((_,i)=>['#36a2eb','#ff6384','#ffce56','#4caf50','#9c27b0'][i%5]) }] },
    options: { responsive:true, plugins:{ legend:{ display:false } } }
  });
}

/* ================ Google Maps & Pos Jaga ================ */
function initMapWhenReady(){
  if(window.google && window.google.maps && !map){
    map = new google.maps.Map(document.getElementById('map'), { center:{lat:-6.200, lng:106.816}, zoom:12 });
  } else if(!window.google || !window.google.maps){
    // wait until loaded
    setTimeout(initMapWhenReady, 500);
  }
}

async function loadPos(){
  initMapWhenReady();
  // clear markers
  markers.forEach(m=>m.setMap(null)); markers = [];
  $('listPos').innerHTML = '';
  if(!currentDusunId) return;
  const snap = await db.collection('dusun').doc(currentDusunId).collection('posJaga').get();
  if(snap.empty){ $('listPos').innerHTML = '<div class="small-muted">Belum ada pos jaga.</div>'; return; }
  const bounds = new google.maps.LatLngBounds();
  snap.forEach(doc=>{
    const p = doc.data();
    const el = document.createElement('div'); el.className='mb-2'; el.innerText = `${p.nama} — Lat:${p.lat}, Lng:${p.lng}`;
    $('listPos').appendChild(el);
    if(map && p.lat && p.lng){
      const marker = new google.maps.Marker({ position:{lat:p.lat, lng:p.lng}, map, title:p.nama });
      markers.push(marker);
      bounds.extend(marker.getPosition());
    }
  });
  if(markers.length) map.fitBounds(bounds);
}

async function promptAddPos(){
  if(!currentUser) return toast("Login dulu.");
  const nama = prompt("Nama pos (contoh: Pos RT 01)");
  if(!nama) return;
  const lat = parseFloat(prompt("Latitude (contoh -6.2)"));
  const lng = parseFloat(prompt("Longitude (contoh 106.816)"));
  if(Number.isNaN(lat) || Number.isNaN(lng)) return toast("Koordinat tidak valid.");
  try{
    await db.collection('dusun').doc(currentDusunId).collection('posJaga').add({ nama, lat, lng, createdAt: Date.now() });
    toast("Pos jaga tersimpan.");
    loadPos();
  }catch(e){ console.error(e); toast("Gagal simpan pos: " + e.message); }
}

/* ================ Dusun code watcher + rotate ================ */
function startDusunCodeWatcher(dusunId, autoRotateIfExpired){
  // unsubscribe previous
  if(kodeUnsubscribe){ kodeUnsubscribe(); kodeUnsubscribe = null; }
  const ref = db.collection('dusun').doc(dusunId);
  kodeUnsubscribe = ref.onSnapshot(async snap=>{
    if(!snap.exists) return;
    const data = snap.data();
    const code = data.code || '';
    const expires = data.codeExpiresAt || 0;
    $('displayCode').innerText = code;
    // also show in create UI for copy convenience
    if(code){
      $('dusun_code').value = code;
      show('kodeGroup');
    }
    // start countdown interval
    if(kodeInterval) clearInterval(kodeInterval);
    kodeInterval = setInterval(async ()=>{
      const now = Date.now();
      const remain = Math.max(0, Math.floor((expires - now)/1000));
      const hh = Math.floor(remain/3600);
      const mm = Math.floor((remain%3600)/60);
      const ss = remain%60;
      $('displayCountdown').innerText = `${hh}h ${mm}m ${ss}s`;
      // also show near generate if present
      const el = $('dusun_code');
      if(el) $('dusun_code').nextSibling; // noop but keep element present
      if(remain <= 0){
        // expired: if kepala_dusun and allowed: rotate
        if(autoRotateIfExpired && currentUser && currentUser.role === 'kepala_dusun'){
          const newCode = "DSN" + Math.random().toString(36).substring(2,8).toUpperCase();
          const newExpires = Date.now() + 3600000;
          try{
            await ref.update({ code: newCode, codeExpiresAt: newExpires });
            // changes reflected via onSnapshot
          }catch(e){ console.error("Gagal ganti kode:", e); }
        }
      }
    }, 1000);
  });
}

/* ================ On load ================ */
window.addEventListener('load', ()=>{
  // nothing required; UI waits for user actions
});
</script>
</body>
</html>
