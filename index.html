<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sistem Keamanan Dusun — FULL (All-in-one)</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
  :root{--card-radius:12px;}
  body{background:#f4f7ff;font-family:Inter,Segoe UI,Arial,sans-serif;padding:18px;}
  .card{border-radius:var(--card-radius);box-shadow:0 6px 18px rgba(20,30,60,0.06);}
  .form-control, .btn{border-radius:8px;}
  input.upper{ text-transform:uppercase; }
  #map{width:100%;height:320px;border-radius:8px;background:#eef;}
  .hidden{display:none!important;}
  .muted{color:#666;font-size:0.9rem;}
  .copy-btn{min-width:96px;}
</style>
</head>
<body>
<div class="container mx-auto" style="max-width:1100px;">
  <h3 class="text-center mb-4">Sistem Keamanan Dusun — FULL</h3>

  <!-- AUTH / CREATE -->
  <div id="authCard" class="card p-3 mb-4">
    <div class="row g-3">
      <!-- Left: Buat Dusun -->
      <div class="col-md-6">
        <h5>Buat Dusun (Kepala Dusun)</h5>
        <input id="dusun_nama" class="form-control mb-2 upper" placeholder="NAMA DUSUN">
        <input id="dusun_desa" class="form-control mb-2 upper" placeholder="DESA">
        <input id="dusun_kecamatan" class="form-control mb-2 upper" placeholder="KECAMATAN">
        <input id="dusun_kab" class="form-control mb-2 upper" placeholder="KABUPATEN">
        <input id="dusun_kota" class="form-control mb-2 upper" placeholder="KOTA">

        <!-- kode group -->
        <div id="kode_group" class="input-group mb-2 hidden">
          <input id="dusun_code" class="form-control" placeholder="KODE DUSUN (GENERATED)" readonly>
          <button id="copy_code_btn" class="btn btn-outline-secondary copy-btn" type="button">COPY</button>
        </div>

        <div class="d-grid gap-2 mb-2">
          <button id="generate_btn" class="btn btn-primary" onclick="onGenerateDusun()">Generate Kode</button>
          <button id="save_dusun_btn" class="btn btn-success hidden" onclick="onSaveDusun()">Simpan Dusun</button>
        </div>
        <div class="muted">Setelah generate: SALIN kode & bagikan ke warga. Kode berlaku 1 jam dan akan berganti otomatis saat kadaluarsa (jika Kepala Dusun login).</div>
      </div>

      <!-- Right: Daftar & Login -->
      <div class="col-md-6">
        <h5>Daftar Warga</h5>
        <input id="reg_nama" class="form-control mb-2 upper" placeholder="NAMA LENGKAP">
        <input id="reg_hp" class="form-control mb-2" placeholder="NOMOR HP (contoh: 0812... atau +62812...)" oninput="formatPhoneTyping(this)" >
        <input id="reg_password" type="password" class="form-control mb-2" placeholder="PASSWORD">
        <input id="reg_alamat" class="form-control mb-2 upper" placeholder="ALAMAT (JALAN)">
        <input id="reg_blok" class="form-control mb-2 upper" placeholder="BLOK (opsional)">
        <input id="reg_no" class="form-control mb-2 upper" placeholder="NO RUMAH (opsional)">
        <div class="row g-2 mb-2">
          <div class="col">
            <input id="reg_rt" class="form-control" placeholder="RT (mis. 001)" maxlength="3" onblur="padRT(this)">
          </div>
          <div class="col">
            <input id="reg_rw" class="form-control" placeholder="RW (mis. 001)" maxlength="3" onblur="padRW(this)">
          </div>
        </div>
        <select id="reg_role" class="form-control mb-2">
          <option value="">-- PILIH ROLE --</option>
          <option value="kepala_desa">KEPALA DESA</option>
          <option value="kepala_dusun">KEPALA DUSUN</option>
          <option value="ketua_rt">KETUA RT</option>
          <option value="ketua_rw">KETUA RW</option>
          <option value="kepala_keluarga">KEPALA KELUARGA</option>
          <option value="istri">ISTRI</option>
          <option value="anak">ANAK</option>
          <option value="lainnya">LAINNYA</option>
        </select>
        <input id="reg_kode" class="form-control mb-2 upper" placeholder="KODE DUSUN (dari Kepala Dusun)">
        <div class="d-grid gap-2">
          <button class="btn btn-success" onclick="onRegister()">Daftar</button>
          <button class="btn btn-outline-secondary" onclick="clearRegister()">Reset</button>
        </div>

        <hr>

        <h5>Login</h5>
        <input id="login_hp" class="form-control mb-2" placeholder="NOMOR HP (contoh: 0812... atau +62812...)" oninput="formatPhoneTyping(this)">
        <input id="login_pass" type="password" class="form-control mb-2" placeholder="PASSWORD">
        <div class="d-grid gap-2">
          <button class="btn btn-primary" onclick="onLogin()">Login</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dashboardCard" class="card p-3 hidden">
    <div class="d-flex justify-content-between align-items-start">
      <div>
        <h4>Dashboard Dusun</h4>
        <div class="muted">Selamat datang, <b id="display_name"></b> · <span id="display_role"></span></div>
        <div class="muted">Waktu: <span id="clock"></span></div>
      </div>
      <div class="text-end">
        <button class="btn btn-danger btn-sm" onclick="onLogout()">Logout</button>
      </div>
    </div>

    <!-- kode (kepala dusun only) -->
    <div id="kodeDashboard" class="card p-3 mt-3 d-none">
      <div class="d-flex justify-content-between">
        <div>
          <div class="muted">Kode Dusun</div>
          <h5 id="display_code"></h5>
        </div>
        <div>
          <div class="muted">Sisa waktu</div>
          <div id="display_countdown" style="font-weight:600"></div>
        </div>
      </div>
    </div>

    <div class="row mt-3 g-3">
      <div class="col-lg-5">
        <div class="card p-3 mb-3">
          <h6>Buat Laporan SOS</h6>
          <select id="lap_jenis" class="form-control mb-2">
            <option>Kemalingan</option>
            <option>Kebakaran</option>
            <option>Medis</option>
            <option>Ambulance</option>
            <option>Mencurigakan</option>
          </select>
          <select id="lap_loc_opt" class="form-control mb-2" onchange="toggleLokasiInput()">
            <option value="saat_ini">Lokasi Saat Ini</option>
            <option value="lainnya">Lokasi Lain</option>
          </select>
          <textarea id="lap_lokasi" class="form-control mb-2 hidden" placeholder="Deskripsi lokasi (opsional)"></textarea>
          <div class="d-grid">
            <button class="btn btn-danger" onclick="sendReport()">Kirim Laporan</button>
          </div>
        </div>

        <div class="card p-3 mb-3">
          <h6>Statistik Kejadian</h6>
          <canvas id="chartKejadian" style="width:100%;height:220px"></canvas>
        </div>

        <div class="card p-3 mb-3">
          <h6>Daftar Laporan Terbaru</h6>
          <div id="listReports"></div>
        </div>
      </div>

      <div class="col-lg-7">
        <div class="card p-3 mb-3">
          <h6>Pos Jaga Dusun</h6>
          <div id="map"></div>
          <div class="d-flex gap-2 mt-3">
            <button class="btn btn-primary" onclick="promptAddPos()">Tambah Pos RT</button>
            <button class="btn btn-outline-secondary" onclick="loadPos()">Muat Ulang Pos</button>
          </div>
          <div id="listPos" class="mt-3"></div>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Google Maps: ganti key ini -->
<script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY"></script>

<script>
/* ================= Firebase init (compat) ================= */
const firebaseConfig = {
  apiKey: "AIzaSyA6GAeIc7ZesIed9MAelUf6x_sBFdp9E-Q",
  authDomain: "dusun-super.firebaseapp.com",
  projectId: "dusun-super",
  storageBucket: "dusun-super.firebasestorage.app",
  messagingSenderId: "1083284057385",
  appId: "1:1083284057385:web:21cfe467b047bb5a241b38",
  measurementId: "G-LJ6KP57Q9M"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ================= State ================= */
let currentUser = null;     // object user after login
let currentDusunId = null;  // doc id of dusun
let map = null;
let markers = [];
let laporanChart = null;
let kodeUnsub = null;
let kodeInterval = null;

/* ================= Helpers ================= */
const $ = id => document.getElementById(id);
const show = id => $(id).classList.remove('hidden');
const hide = id => $(id).classList.add('hidden');
const SwalToast = (title, icon='success', timer=2200) => {
  return Swal.fire({ title, icon, toast:true, position:'top-end', showConfirmButton:false, timer });
};
const SwalAlert = (title, html, icon='info') => {
  return Swal.fire({ title, html, icon });
};

/* Auto-uppercase for inputs with class "upper" (user may paste lowercase) */
document.addEventListener('input', e=>{
  if(e.target && e.target.classList && e.target.classList.contains('upper')){
    e.target.value = e.target.value.toUpperCase();
  }
});

/* ================ Phone formatting & RT/RW padding ================ */
function normalizePhoneForKey(v){
  // Accept formats like 0812..., +62812..., 62812... -> store key without '+', as '62812...'
  let s = (v||"").replace(/\s+/g,"").replace(/\D/g,"");
  if(s.startsWith("0")) s = "62"+s.substring(1);
  if(!s.startsWith("62")) s = "62"+s;
  return s; // e.g. "62812..."
}
function formatPhoneTyping(el){
  let raw = el.value.replace(/[^\d\+]/g,"");
  if(raw.startsWith("+")) {
    let digits = raw.replace(/\D/g,"");
    el.value = "+" + digits;
  } else {
    el.value = raw;
  }
}
function formatPhoneOnBlur(el){
  const key = normalizePhoneForKey(el.value);
  if(!key) { el.value=""; return; }
  el.value = "+" + key;
}
function padRT(el){
  let v = (el.value||"").replace(/\D/g,"");
  v = v.padStart(3,"0");
  el.value = v;
}
function padRW(el){
  let v = (el.value||"").replace(/\D/g,"");
  v = v.padStart(3,"0");
  el.value = v;
}
/* bind blur events for phone inputs */
['reg_hp','login_hp'].forEach(id=>{
  const el = $(id);
  if(el) { el.addEventListener('blur', ()=>formatPhoneOnBlur(el)); }
});

/* ================ Create Dusun: generate & save ================ */
function onGenerateDusun(){
  const code = "DSN" + Math.random().toString(36).substring(2,8).toUpperCase();
  $('dusun_code').value = code;
  show('kode_group');
  hide('generate_btn');
  show('save_dusun_btn');
}
$('copy_code_btn')?.addEventListener('click', ()=>{
  const v = $('dusun_code').value;
  if(!v){ SwalToast("Belum ada kode untuk disalin","error"); return; }
  navigator.clipboard?.writeText(v).then(()=> SwalToast("Kode disalin ke clipboard"));
});

async function onSaveDusun(){
  const nama = $('dusun_nama').value.trim().toUpperCase();
  const desa = $('dusun_desa').value.trim().toUpperCase();
  const kec = $('dusun_kecamatan').value.trim().toUpperCase();
  const kab = $('dusun_kab').value.trim().toUpperCase();
  const kota = $('dusun_kota').value.trim().toUpperCase();
  const code = $('dusun_code').value.trim().toUpperCase();
  if(!nama||!desa||!kec||!kab||!kota||!code) {
    SwalAlert("Error","Lengkapi data dusun dan generate kode terlebih dahulu","error");
    return;
  }

  // set expiry 1 hour from now
  const expires = Date.now() + 3600*1000;
  try{
    // store dusun doc (doc id auto)
    const docRef = await db.collection('dusun').add({
      nama, desa, kecamatan: kec, kabupaten: kab, kota, code, codeExpiresAt: expires, createdAt: Date.now()
    });
    // show success modal
    await SwalAlert("Berhasil", `Dusun tersimpan.<br><b>Kode:</b> ${code}<br><small>ID Dusun: ${docRef.id}</small>`, "success");
    SwalToast("Dusun tersimpan");
    // reset create form (keep code visible for copy if needed)
    hide('save_dusun_btn'); show('generate_btn');
    // optionally we can store kepala_dusun mapping later when kepala dusun registers
  }catch(e){
    console.error(e);
    SwalAlert("Gagal", "Gagal menyimpan dusun: " + (e.message||e), "error");
  }
}

/* ================ Register: duplicate phone check ================ */
async function onRegister(){
  const nama = $('reg_nama').value.trim().toUpperCase();
  const hpDisplay = $('reg_hp').value.trim();
  const password = $('reg_password').value;
  const alamat = $('reg_alamat').value.trim().toUpperCase();
  const blok = $('reg_blok').value.trim().toUpperCase();
  const no = $('reg_no').value.trim().toUpperCase();
  const rt = ($('reg_rt').value||"").trim().padStart(3,'0');
  const rw = ($('reg_rw').value||"").trim().padStart(3,'0');
  const role = $('reg_role').value;
  const kodeDusun = $('reg_kode').value.trim().toUpperCase();

  if(!nama || !hpDisplay || !password || !alamat || !rt || !rw || !role || !kodeDusun){
    SwalAlert("Error","Nama, No HP, Password, Alamat, RT, RW, Role, dan Kode Dusun wajib diisi.","error");
    return;
  }

  const phoneKey = normalizePhoneForKey(hpDisplay); // e.g. 62812...
  // check duplicate user (doc id users/{phoneKey})
  const userDoc = await db.collection('users').doc(phoneKey).get();
  if(userDoc.exists){
    SwalAlert("Error","Nomor HP ini sudah terdaftar — 1 nomor hanya bisa untuk 1 user/dusun.","error");
    return;
  }

  // validate dusun code exists
  const q = await db.collection('dusun').where('code','==',kodeDusun).get();
  if(q.empty){
    SwalAlert("Error","Kode Dusun tidak valid. Minta kode terbaru dari Kepala Dusun.","error");
    return;
  }

  const dusunId = q.docs[0].id;

  // save user as doc id = phoneKey
  try{
    await db.collection('users').doc(phoneKey).set({
      nama, phoneDisplay: "+"+phoneKey, password, alamat, blok, no, rt, rw, role, dusunId, createdAt: Date.now()
    });
    SwalAlert("Sukses","Pendaftaran berhasil. Silakan login.","success");
    clearRegister();
  }catch(e){ console.error(e); SwalAlert("Gagal","Gagal daftar: "+(e.message||e),"error"); }
}
function clearRegister(){
  ['reg_nama','reg_hp','reg_password','reg_alamat','reg_blok','reg_no','reg_rt','reg_rw','reg_kode'].forEach(id=>{
    const el = $(id); if(el) el.value='';
  });
  $('reg_role').selectedIndex=0;
}

/* ================ Login ================ */
async function onLogin(){
  const hp = $('login_hp').value.trim();
  const pass = $('login_pass').value;
  if(!hp || !pass) { SwalToast("Masukkan No HP dan Password","error"); return; }
  const key = normalizePhoneForKey(hp);
  const doc = await db.collection('users').doc(key).get();
  if(!doc.exists){ SwalAlert("Error","User tidak ditemukan.","error"); return; }
  const user = doc.data();
  if(user.password !== pass){ SwalAlert("Error","Password salah.","error"); return; }
  // set current
  currentUser = { id: key, ...user };
  currentDusunId = user.dusunId || null;
  // show dashboard
  hide('authCard'); show('dashboardCard');
  $('display_name').innerText = currentUser.nama || currentUser.phoneDisplay || key;
  $('display_role').innerText = (currentUser.role||'').toUpperCase();
  startClock();
  // if kepala dusun: show kode and watcher
  if(currentUser.role === 'kepala_dusun'){
    if(currentDusunId){
      show('kodeDashboard');
      startDusunWatcher(currentDusunId, true);
    } else {
      SwalAlert("Peringatan","Anda kepala dusun tapi belum terkait Dusun. Pastikan mendaftar menggunakan kode dusun yang dibuat.","warning");
    }
  } else {
    hide('kodeDashboard');
  }
  // load map, pos, reports
  initMapWhenReady();
  loadPos();
  loadReportsAndChart();
  if(currentDusunId){
    db.collection('laporan').where('dusunId','==',currentDusunId).onSnapshot(()=> loadReportsAndChart());
  }
}

/* ================ Logout ================ */
function onLogout(){
  currentUser = null; currentDusunId = null;
  if(kodeUnsub){ kodeUnsub(); kodeUnsub=null; }
  if(kodeInterval){ clearInterval(kodeInterval); kodeInterval=null; }
  show('authCard'); hide('dashboardCard');
  SwalToast("Logged out","info");
}

/* ================ Clock ================ */
let clockInterval = null;
function startClock(){
  if(clockInterval) clearInterval(clockInterval);
  function tick(){ $('clock').innerText = new Date().toLocaleString('id-ID',{ weekday:'long', year:'numeric', month:'long', day:'numeric', hour:'2-digit', minute:'2-digit', second:'2-digit' }); }
  tick();
  clockInterval = setInterval(tick,1000);
}

/* ================ Reports ================ */
function toggleLokasiInput(){
  const v = $('lap_loc_opt').value;
  if(v === 'lainnya') show('lap_lokasi'); else hide('lap_lokasi');
}
async function sendReport(){
  if(!currentUser) return SwalAlert("Error","Login dulu untuk mengirim laporan.","error");
  if(!currentDusunId) return SwalAlert("Error","User belum terikat Dusun.","error");
  const jenis = $('lap_jenis').value;
  const lokasiOpt = $('lap_loc_opt').value;
  const lokasi = lokasiOpt === 'lainnya' ? $('lap_lokasi').value.trim() : 'Lokasi Saat Ini';
  if(!jenis) return SwalAlert("Error","Pilih jenis laporan.","error");
  try{
    await db.collection('laporan').add({
      dusunId: currentDusunId, uid: currentUser.id, jenis, lokasi, createdAt: Date.now()
    });
    SwalToast("Laporan terkirim");
    $('lap_lokasi').value = '';
    loadReportsAndChart();
  }catch(e){ console.error(e); SwalAlert("Gagal","Gagal kirim laporan: "+(e.message||e),"error"); }
}

/* ================ Reports list & Chart ================ */
async function loadReportsAndChart(){
  if(!currentDusunId) return;
  const snap = await db.collection('laporan').where('dusunId','==',currentDusunId).orderBy('createdAt','desc').limit(200).get();
  const rows = snap.docs.map(d=>({id:d.id,...d.data()}));
  // list
  const list = $('listReports'); if(list) list.innerHTML = '';
  if(rows.length === 0 && list) list.innerHTML = '<div class="muted">Belum ada laporan.</div>';
  rows.slice(0,30).forEach(r=>{
    const t = new Date(r.createdAt).toLocaleString();
    const el = document.createElement('div'); el.className='mb-2';
    el.innerHTML = `<div><b>${r.jenis}</b> — ${r.lokasi||''}</div><div class="muted">${t}</div>`;
    list.appendChild(el);
  });
  // chart
  const counts = {};
  rows.forEach(r => counts[r.jenis] = (counts[r.jenis]||0)+1);
  const labels = Object.keys(counts).length ? Object.keys(counts) : ['Tidak ada'];
  const data = labels.map(l => counts[l] || 0);
  if(laporanChart) laporanChart.destroy();
  const canvas = document.getElementById('chartKejadian');
  if(canvas){
    const ctx = canvas.getContext('2d');
    laporanChart = new Chart(ctx, {
      type:'bar', data:{ labels, datasets:[{label:'Jumlah', data, backgroundColor: labels.map((_,i)=>['#36a2eb','#ff6384','#ffce56','#4caf50','#9c27b0'][i%5]) }] },
      options:{ responsive:true, plugins:{ legend:{ display:false } } }
    });
  }
}

/* ================ Google Maps & Pos Jaga ================ */
function initMapWhenReady(){
  if(window.google && window.google.maps && !map){
    map = new google.maps.Map(document.getElementById('map'), { center:{lat:-6.200000, lng:106.816666}, zoom:12 });
  } else if(!window.google || !window.google.maps){
    setTimeout(initMapWhenReady, 500);
  }
}
async function loadPos(){
  initMapWhenReady();
  // clear markers
  markers.forEach(m=>m.setMap(null)); markers=[];
  const listPosEl = $('listPos'); if(listPosEl) listPosEl.innerHTML = '';
  if(!currentDusunId) return;
  const snap = await db.collection('dusun').doc(currentDusunId).collection('posJaga').get();
  if(snap.empty){ if(listPosEl) listPosEl.innerHTML = '<div class="muted">Belum ada pos jaga.</div>'; return; }
  const bounds = new google.maps.LatLngBounds();
  snap.forEach(doc=>{
    const p = doc.data();
    const el = document.createElement('div'); el.className='mb-2'; el.innerText = `${p.nama} — Lat:${p.lat}, Lng:${p.lng}`;
    listPosEl.appendChild(el);
    if(map && p.lat && p.lng){
      const marker = new google.maps.Marker({ position:{lat:p.lat, lng:p.lng}, map, title:p.nama });
      markers.push(marker);
      bounds.extend(marker.getPosition());
    }
  });
  if(markers.length) map.fitBounds(bounds);
}
async function promptAddPos(){
  if(!currentUser) return SwalAlert("Error","Login dulu.","error");
  if(!currentDusunId) return SwalAlert("Error","User belum terikat Dusun.","error");

  // SweetAlert2 modal to get name, lat, lng
  const { value: formValues } = await Swal.fire({
    title: 'Tambah Pos Jaga',
    html:
      '<input id="swal-pos-name" class="swal2-input" placeholder="Nama pos (contoh: Pos RT 01)">' +
      '<input id="swal-pos-lat" class="swal2-input" placeholder="Latitude (contoh -6.200)">' +
      '<input id="swal-pos-lng" class="swal2-input" placeholder="Longitude (contoh 106.816)">',
    focusConfirm: false,
    preConfirm: () => {
      const name = document.getElementById('swal-pos-name').value;
      const lat = parseFloat(document.getElementById('swal-pos-lat').value);
      const lng = parseFloat(document.getElementById('swal-pos-lng').value);
      if(!name) Swal.showValidationMessage('Nama pos wajib diisi');
      if(Number.isNaN(lat) || Number.isNaN(lng)) Swal.showValidationMessage('Koordinat tidak valid');
      return { name, lat, lng };
    },
    showCancelButton: true
  });

  if(formValues){
    try{
      await db.collection('dusun').doc(currentDusunId).collection('posJaga').add({
        nama: formValues.name, lat: formValues.lat, lng: formValues.lng, createdAt: Date.now()
      });
      SwalToast('Pos tersimpan');
      loadPos();
    }catch(e){ console.error(e); SwalAlert('Gagal','Gagal simpan pos: '+(e.message||e),'error'); }
  }
}

/* ================ Dusun code watcher & auto-rotate ================ */
function startDusunWatcher(dusunId, autoRotate){
  if(kodeUnsub){ kodeUnsub(); kodeUnsub = null; }
  const ref = db.collection('dusun').doc(dusunId);
  kodeUnsub = ref.onSnapshot(async snap=>{
    if(!snap.exists) return;
    const data = snap.data();
    const code = data.code || '';
    const expires = data.codeExpiresAt || 0;
    $('display_code').innerText = code;
    // show in create area too
    if(code){ $('dusun_code').value = code; show('kode_group'); }
    // countdown
    if(kodeInterval) clearInterval(kodeInterval);
    kodeInterval = setInterval(async ()=>{
      const now = Date.now();
      const remain = Math.max(0, Math.floor((expires - now)/1000));
      const hh = Math.floor(remain/3600);
      const mm = Math.floor((remain%3600)/60);
      const ss = remain%60;
      $('display_countdown').innerText = `${hh}h ${mm}m ${ss}s`;
      if(remain <= 0){
        if(autoRotate && currentUser && currentUser.role === 'kepala_dusun'){
          // generate new code and update
          const newCode = "DSN" + Math.random().toString(36).substring(2,8).toUpperCase();
          const newExpires = Date.now() + 3600*1000;
          try{
            await ref.update({ code: newCode, codeExpiresAt: newExpires });
            SwalToast('Kode dusun diperbarui');
          }catch(e){ console.error("Gagal update code:", e); }
        }
      }
    }, 1000);
  });
}

/* ================ On load init handlers ================ */
window.addEventListener('load', ()=>{
  // attach blur handlers
  ['reg_hp','login_hp'].forEach(id=>{
    const el = $(id);
    if(el) el.addEventListener('blur', ()=>{ const key = normalizePhoneForKey(el.value); if(key) el.value = "+"+key; });
  });
  // ensure elements exist for lists etc (create placeholders if missing)
  if(!$('listReports')) { const div = document.createElement('div'); div.id='listReports'; document.body.appendChild(div); }
  if(!$('chartKejadian')) { /* canvas absent? it's in markup */ }
  // initial nothing else
});
</script>
</body>
</html>
