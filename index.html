<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistem Keamanan Dusun</title>
<script type="module" src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body { background: #f0f4ff; font-family: 'Segoe UI', sans-serif; }
.card { border-radius: 16px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
.btn { border-radius: 12px; font-weight: 600; }
.form-control { border-radius: 12px; }
#map { width: 100%; height: 300px; border-radius: 16px; }
.hidden { display:none; }
#listPos div { margin-bottom: 5px; }
</style>
</head>
<body>
<div class="container py-5">

<!-- LOGIN / REGISTER -->
<div id="login-container" class="card p-4 mx-auto" style="max-width:420px;">
<h3 class="text-center mb-4">Login / Daftar Warga</h3>
<input id="phone" class="form-control mb-3" placeholder="Nomor HP" type="text">
<input id="name" class="form-control mb-3" placeholder="Nama Lengkap" type="text">
<select id="role" class="form-control mb-3">
  <option value="kepala_desa">Kepala Desa</option>
  <option value="kepala_dusun">Kepala Dusun</option>
  <option value="ketua_rt">Ketua RT</option>
  <option value="ketua_rw">Ketua RW</option>
  <option value="kepala_keluarga">Kepala Keluarga</option>
  <option value="istri">Istri</option>
  <option value="anak">Anak</option>
</select>
<button class="btn btn-primary w-100 mb-2" onclick="registerLogin()">Login / Daftar</button>
<button class="btn btn-outline-success w-100" onclick="showAddJoinDusun()">Tambah / Gabung Dusun</button>
</div>

<!-- TAMBAH / GABUNG DUSUN -->
<div id="dusun-container" class="card p-4 mx-auto hidden" style="max-width:420px;">
<h4 class="mb-3">Dusun</h4>
<input type="text" id="dusunName" placeholder="Nama Dusun" class="form-control mb-2">
<input type="text" id="dusunKota" placeholder="Kota" class="form-control mb-2">
<input type="text" id="dusunKabupaten" placeholder="Kabupaten" class="form-control mb-2">
<input type="text" id="dusunKecamatan" placeholder="Kecamatan" class="form-control mb-2">
<input type="text" id="dusunCode" placeholder="Kode Dusun" readonly class="form-control mb-2">
<button class="btn btn-success w-100 mb-2" onclick="createDusun()">Buat Dusun</button>
<input id="dusunCodeJoin" class="form-control mb-2" placeholder="Masukkan Kode Dusun">
<button class="btn btn-primary w-100 mb-2" onclick="joinDusun()">Gabung Dusun</button>
<button class="btn btn-secondary w-100" onclick="backToLogin()">Kembali</button>
</div>

<!-- DASHBOARD -->
<div id="dashboard-container" class="hidden">
<div class="d-flex justify-content-between mb-3">
<h3>Dashboard Dusun</h3>
<button class="btn btn-danger btn-sm" onclick="logout()">Logout</button>
</div>

<div class="card p-3 mb-3">
<h5>Kode Dusun:</h5>
<p id="dusunCodeDisplay" class="fw-bold text-primary"></p>
</div>

<div class="card p-3 mb-3">
<h5>Buat Laporan SOS</h5>
<select id="kejadian" class="form-control mb-2">
  <option>Kemalingan</option>
  <option>Kebakaran</option>
  <option>Medis</option>
  <option>Ambulance</option>
  <option>Mencurigakan</option>
</select>
<select id="lokasiOption" class="form-control mb-2" onchange="toggleLokasi()">
  <option value="saat_ini">Lokasi Saat Ini</option>
  <option value="lainnya">Lokasi Lain</option>
</select>
<textarea id="lokasiDeskripsi" class="form-control mb-2 hidden" placeholder="Rumah siapa / sekitar siapa / RT RW (opsional)"></textarea>
<button class="btn btn-danger w-100" onclick="lapor()">Kirim Laporan</button>
</div>

<div class="card p-3 mb-3">
<h5>Statistik Kejadian</h5>
<canvas id="chartKejadian"></canvas>
</div>

<div class="card p-3 mb-3">
<h5>Pos Jaga Dusun</h5>
<div id="map"></div>
<button class="btn btn-primary w-100 mt-3" onclick="tambahPos()">Tambah Pos RT</button>
<div id="listPos" class="mt-3"></div>
</div>
</div>
</div>

<!-- Google Maps API -->
<script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, addDoc, doc, setDoc, getDocs, query, where, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
apiKey: "AIzaSyA6GAeIc7ZesIed9MAelUf6x_sBFdp9E-Q",
authDomain: "dusun-super.firebaseapp.com",
projectId: "dusun-super",
storageBucket: "dusun-super.firebasestorage.app",
messagingSenderId: "1083284057385",
appId: "1:1083284057385:web:21cfe467b047bb5a241b38",
measurementId: "G-LJ6KP57Q9M"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let map;
let markers = [];
let currentDusunId = null;

function show(id){
  document.getElementById("login-container").classList.add("hidden");
  document.getElementById("dusun-container").classList.add("hidden");
  document.getElementById("dashboard-container").classList.add("hidden");
  document.getElementById(id).classList.remove("hidden");
}
function showAddJoinDusun(){ show("dusun-container"); }
function backToLogin(){ show("login-container"); }
function toggleLokasi(){
  const opt=document.getElementById("lokasiOption").value;
  document.getElementById("lokasiDeskripsi").classList.toggle("hidden", opt!=="lainnya");
}

// LOGIN / REGISTER
async function registerLogin(){
  const phone=document.getElementById("phone").value;
  const name=document.getElementById("name").value;
  const role=document.getElementById("role").value;
  if(!phone || !name) return alert("Nama dan Nomor HP wajib diisi");

  const usersRef = collection(db, "users");
  const q = query(usersRef, where("phone", "==", phone));
  const snap = await getDocs(q);

  let uid;
  if(snap.empty){
    const docRef = await addDoc(usersRef, {phone, name, role, createdAt: Date.now()});
    uid = docRef.id;
  } else {
    uid = snap.docs[0].id;
  }

  sessionStorage.setItem("uid", uid);
  loadDashboard();
}

// BUAT DUSUN
async function createDusun(){
  const uid=sessionStorage.getItem("uid");
  const name=document.getElementById("dusunName").value;
  const kota=document.getElementById("dusunKota").value;
  const kab=document.getElementById("dusunKabupaten").value;
  const kec=document.getElementById("dusunKecamatan").value;
  if(!name || !kota || !kab || !kec) return alert("Semua field harus diisi");

  const code=Math.random().toString(36).substring(2,8).toUpperCase();
  document.getElementById("dusunCode").value=code;

  const dusunRef = await addDoc(collection(db,"dusun"), {name,kota,kabupaten:kab,kecamatan:kec,code,createdBy:uid,createdAt:Date.now()});
  const userDoc = doc(db,"users",uid);
  await updateDoc(userDoc,{role:"kepala_dusun",dusunId:dusunRef.id});

  alert("Dusun berhasil dibuat!");
  loadDashboard();
}

// GABUNG DUSUN
async function joinDusun(){
  const uid=sessionStorage.getItem("uid");
  const code=document.getElementById("dusunCodeJoin").value;
  const q=query(collection(db,"dusun"), where("code","==",code));
  const snap=await getDocs(q);
  if(snap.empty) return alert("Kode dusun salah");

  const dusunDoc=snap.docs[0];
  currentDusunId = dusunDoc.id;
  await setDoc(doc(db,"dusun",dusunDoc.id,"warga",uid), {joinedAt:Date.now()});
  await updateDoc(doc(db,"users",uid), {dusunId:dusunDoc.id});
  alert("Gabung dusun berhasil!");
  loadDashboard();
}

// DASHBOARD
async function loadDashboard(){
  show("dashboard-container");
  const uid = sessionStorage.getItem("uid");
  if(!uid) { backToLogin(); return; }

  // Ambil data user
  const userDoc = doc(db,"users",uid);
  const userSnap = await getDocs(query(collection(db,"users"), where("phone","!=", "")));
  const userData = (await getDocs(query(collection(db,"users"), where("phone","!=", "")))).docs.find(d=>d.id===uid)?.data() || {};
  const dusunId = userData.dusunId || null;
  currentDusunId = dusunId;

  // Tampilkan kode dusun
  let dusunCode="(Data Dusun belum tersedia)";
  if(dusunId){
    const dusunSnap = await getDocs(query(collection(db,"dusun"), where("__name__","==",dusunId)));
    if(!dusunSnap.empty) dusunCode = dusunSnap.docs[0].data().code;
  }
  document.getElementById("dusunCodeDisplay").innerText = dusunCode;

  // Load chart kejadian
  const laporanSnap = await getDocs(collection(db,"laporan"));
  const counts = {};
  laporanSnap.forEach(doc=> { const kej = doc.data().kejadian; counts[kej] = (counts[kej] || 0)+1; });
  const ctx = document.getElementById("chartKejadian").getContext("2d");
  new Chart(ctx,{type:"bar",data:{labels:Object.keys(counts),datasets:[{label:"Jumlah Kejadian",data:Object.values(counts),backgroundColor:"rgba(255,99,132,0.5)"}]},options:{responsive:true,plugins:{legend:{display:false}}}});

  // Init peta
  if(!map){
    map = new google.maps.Map(document.getElementById("map"), {center:{lat:-6.200000,lng:106.816666},zoom:13});
    map.addListener("click", async (e)=> {
      const posName = prompt("Nama Pos / RT:");
      if(!posName) return;
      const posRef = await addDoc(collection(db,"dusun",currentDusunId,"pos"),{name:posName,lat:e.latLng.lat(),lng:e.latLng.lng(),createdAt:Date.now()});
      addMarker(posRef.id,e.latLng,posName);
    });
  }

  // Load pos dari Firestore
  markers.forEach(m=>m.setMap(null)); markers=[]; document.getElementById("listPos").innerHTML="";
  if(dusunId){
    const posSnap = await getDocs(collection(db,"dusun",dusunId,"pos"));
    posSnap.forEach(doc=>{
      const data = doc.data();
      const latlng = {lat:data.lat,lng:data.lng};
      addMarker(doc.id,latlng,data.name);
    });
  }
}

// Tambah marker & daftar
function addMarker(id,latlng,name){
  const marker = new google.maps.Marker({position:latlng,map:map,title:name});
  markers.push(marker);
  const div = document.createElement("div");
  div.innerText = name;
  document.getElementById("listPos").appendChild(div);
}

async function lapor(){
  const uid=sessionStorage.getItem("uid");
  const kejadian=document.getElementById("kejadian").value;
  const lokasiOpt=document.getElementById("lokasiOption").value;
  const lokasiDes=lokasiOpt==="lainnya"?document.getElementById("lokasiDeskripsi").value:"Lokasi Saat Ini";
  await addDoc(collection(db,"laporan"),{uid,kejadian,lokasi:lokasiDes,createdAt:Date.now()});
  alert("Laporan terkirim!");
  loadDashboard();
}

function tambahPos(){
  alert("Klik peta untuk menambahkan pos RT.");
}

function logout(){
  sessionStorage.removeItem("uid");
  backToLogin();
}
</script>
</body>
</html>
