<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Keamanan Dusun</title>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body{font-family:Arial,sans-serif;background:#f0f2f5;margin:0;padding:0}
.container{max-width:480px;margin:20px auto;padding:20px;background:#fff;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1)}
h2,h3{text-align:center}
input, button, select{width:100%;padding:10px;margin:5px 0;border-radius:6px;border:1px solid #ccc}
button{background:#007bff;color:white;border:none;cursor:pointer}
button:hover{background:#0056b3}
.hidden{display:none}
#dashboard{display:none;padding:10px}
#charts{display:flex;gap:20px;flex-wrap:wrap;justify-content:center;margin-top:20px}
canvas{background:#fff;padding:10px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,0.1);width:200px !important;height:200px !important}
#map{width:100%;height:350px;margin-top:20px;border-radius:10px}
#profileInfo{text-align:center;margin-top:10px;font-weight:bold}
</style>
</head>
<body>

<div class="container" id="mainContainer">
  <h2>Aplikasi Keamanan Dusun</h2>

  <!-- Buat Dusun / Desa -->
  <div id="buatDusunDiv">
    <h3>Buat Dusun (Kepala Dusun)</h3>
    <input id="namaDusun" placeholder="Nama Dusun">
    <input id="desa" placeholder="Desa">
    <input id="kota" placeholder="Kota">
    <input id="kabupaten" placeholder="Kabupaten">
    <input id="kecamatan" placeholder="Kecamatan">
    <button id="generateBtn" onclick="generateKode()">Generate Kode</button>
    <div id="kodeContainer" class="hidden">
      <p>Kode Dusun: <b id="kodeDusunText"></b></p>
      <p>Sisa waktu pergantian kode: <span id="countdownTimer"></span></p>
    </div>
  </div>

  <hr>

  <!-- Daftar Warga -->
  <div id="daftarDiv">
    <h3>Daftar Warga</h3>
    <input id="namaWarga" placeholder="Nama">
    <input id="noHpDaftar" placeholder="No HP">
    <input id="alamat" placeholder="Alamat">
    <input id="blok" placeholder="Blok (opsional)">
    <input id="nomor" placeholder="Nomor (opsional)">
    <input id="rt" placeholder="RT">
    <input id="rw" placeholder="RW">
    <input id="passwordDaftar" type="password" placeholder="Password">
    <select id="roleWarga">
      <option value="kepala_desa">Kepala Desa</option>
      <option value="kepala_dusun">Kepala Dusun</option>
      <option value="ketua_rt">Ketua RT</option>
      <option value="ketua_rw">Ketua RW</option>
      <option value="kepala_keluarga">Kepala Keluarga</option>
      <option value="istri">Istri</option>
      <option value="anak">Anak</option>
      <option value="lainnya">Lainnya</option>
    </select>
    <button onclick="daftar()">Daftar</button>
  </div>

  <hr>

  <!-- Login -->
  <div id="loginDiv">
    <h3>Login</h3>
    <input id="noHpLogin" placeholder="No HP">
    <input id="passwordLogin" type="password" placeholder="Password">
    <button onclick="login()">Login</button>
  </div>
</div>

<!-- Dashboard -->
<div id="dashboard">
  <h2>Dashboard Dusun</h2>
  <p>Selamat datang, <span id="userName"></span>!</p>
  <div id="profileInfo">
    <span id="currentDateTime"></span>
  </div>
  <div id="charts">
    <canvas id="kejadianChart"></canvas>
    <canvas id="keamananChart"></canvas>
  </div>
  <div id="map"></div>
  <button onclick="logout()" style="margin-top:20px;">Logout</button>
</div>

<script>
const firebaseConfig = {
apiKey:"AIzaSyA6GAeIc7ZesIed9MAelUf6x_sBFdp9E-Q",
authDomain:"dusun-super.firebaseapp.com",
projectId:"dusun-super",
storageBucket:"dusun-super.firebasestorage.app",
messagingSenderId:"1083284057385",
appId:"1:1083284057385:web:21cfe467b047bb5a241b38",
measurementId:"G-LJ6KP57Q9M"
};
const app=firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();

let currentUser=null;
let generatedCode="";
let countdownInterval=null;

// ===== Buat Dusun =====
function generateKode(){
  generatedCode="DSN"+Math.random().toString(36).substr(2,6).toUpperCase();
  document.getElementById("kodeDusunText").innerText=generatedCode;
  document.getElementById("kodeContainer").classList.remove("hidden");
  const btn=document.getElementById("generateBtn");
  btn.innerText="Simpan";
  btn.onclick=simpanDusun;
}

// Simpan data dusun + auto refresh kode tiap 1 jam
async function simpanDusun(){
  const nama=document.getElementById("namaDusun").value;
  const desa=document.getElementById("desa").value;
  const kota=document.getElementById("kota").value;
  const kabupaten=document.getElementById("kabupaten").value;
  const kecamatan=document.getElementById("kecamatan").value;
  if(!nama||!desa||!kota||!kabupaten||!kecamatan||!generatedCode) return alert("Isi semua data!");

  const docRef=await db.collection("dusun").add({
    nama, desa, kota, kabupaten, kecamatan,
    code:generatedCode,
    createdAt:Date.now()
  });

  alert("Dusun berhasil dibuat! Kode: "+generatedCode);
  sessionStorage.setItem("kodeDusun",generatedCode);
  sessionStorage.setItem("dusunId",docRef.id);
  document.getElementById("buatDusunDiv").classList.add("hidden");

  startKodeTimer(docRef.id);
}

// ===== Timer & Auto Refresh Kode =====
function startKodeTimer(dusunId){
  let duration=3600; 
  if(countdownInterval) clearInterval(countdownInterval);
  countdownInterval=setInterval(async ()=>{
    duration--;
    const jam=Math.floor(duration/3600);
    const menit=Math.floor((duration%3600)/60);
    const detik=duration%60;
    document.getElementById("countdownTimer").innerText=`${jam}h ${menit}m ${detik}s`;
    if(duration<=0){
      const newCode="DSN"+Math.random().toString(36).substr(2,6).toUpperCase();
      await db.collection("dusun").doc(dusunId).update({code:newCode});
      generatedCode=newCode;
      sessionStorage.setItem("kodeDusun",newCode);
      document.getElementById("kodeDusunText").innerText=newCode;
      duration=3600;
    }
  },1000);
}

// ===== Daftar Warga =====
async function daftar(){
  const data={
    nama:document.getElementById("namaWarga").value,
    noHp:document.getElementById("noHpDaftar").value,
    alamat:document.getElementById("alamat").value,
    blok:document.getElementById("blok").value,
    nomor:document.getElementById("nomor").value,
    rt:document.getElementById("rt").value,
    rw:document.getElementById("rw").value,
    password:document.getElementById("passwordDaftar").value,
    role:document.getElementById("roleWarga").value,
    createdAt:Date.now()
  };
  if(!data.noHp||!data.password) return alert("Isi data wajib");

  const kodeDusun=sessionStorage.getItem("kodeDusun");
  if(!kodeDusun) return alert("Minta kode dari Kepala Dusun");

  const q=await db.collection("dusun").where("code","==",kodeDusun).get();
  if(q.empty) return alert("Kode dusun tidak valid!");
  data.dusunId=q.docs[0].id;

  await db.collection("users").doc(data.noHp).set(data);
  alert("Daftar berhasil! Silakan login.");
}

// ===== Login =====
async function login(){
  const noHp=document.getElementById("noHpLogin").value;
  const password=document.getElementById("passwordLogin").value;

  const docSnap=await db.collection("users").doc(noHp).get();
  if(!docSnap.exists) return alert("User tidak ditemukan!");
  const user=docSnap.data();
  if(user.password!==password) return alert("Password salah!");

  currentUser=user;
  document.getElementById("mainContainer").classList.add("hidden");
  document.getElementById("dashboard").style.display="block";
  document.getElementById("userName").innerText=user.nama;

  setInterval(()=> {
    const now=new Date();
    document.getElementById("currentDateTime").innerText=now.toLocaleString('id-ID',{weekday:'long',year:'numeric',month:'long',day:'numeric',hour:'2-digit',minute:'2-digit',second:'2-digit'});
  },1000);

  loadDashboard(user.dusunId);
}

// ===== Logout =====
function logout(){
  sessionStorage.clear();
  currentUser=null;
  document.getElementById("dashboard").style.display="none";
  document.getElementById("mainContainer").classList.remove("hidden");
}

// ===== Dashboard =====
async function loadDashboard(dusunId){
  const laporanData={"Pencurian":5,"Kebakaran":2,"Keributan":3};
  const ctx1=document.getElementById('kejadianChart').getContext('2d');
  new Chart(ctx1,{type:'bar',data:{
    labels:Object.keys(laporanData),
    datasets:[{label:'Jumlah Kejadian',data:Object.values(laporanData),backgroundColor:['#ff6384','#36a2eb','#ffce56']}]
  }});

  const total=Object.values(laporanData).reduce((a,b)=>a+b,0);
  const aman=Math.max(0,100-total*5);
  const ctx2=document.getElementById('keamananChart').getContext('2d');
  new Chart(ctx2,{type:'doughnut',data:{
    labels:['Aman','Bahaya'],
    datasets:[{data:[aman,100-aman],backgroundColor:['#36a2eb','#ff6384'] }]
  }});
}
</script>
</body>
</html>
