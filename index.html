<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistem Keamanan Dusun</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-messaging.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f0f4ff; font-family: 'Segoe UI', sans-serif; }
    .card { border-radius: 16px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    .btn { border-radius: 12px; font-weight: 600; }
    .form-control { border-radius: 12px; }
    #map { width: 100%; height: 300px; border-radius: 16px; }
  </style>
</head>
<body>
<div class="container py-5">

  <!-- LOGIN / REGISTER -->
  <div id="login-container" class="card p-4 mx-auto" style="max-width:420px;">
    <h3 class="text-center mb-4">Login Warga Dusun</h3>
    <input id="email" class="form-control mb-3" type="email" placeholder="Email">
    <input id="password" class="form-control mb-3" type="password" placeholder="Password">
    <button class="btn btn-primary w-100 mb-3" onclick="login()">Login</button>
    <button class="btn btn-outline-primary w-100 mb-2" onclick="register()">Daftar</button>
    <button class="btn btn-outline-success w-100" onclick="showAddJoinDusun()">Tambah / Gabung Dusun</button>
  </div>

  <!-- TAMBAH / GABUNG DUSUN -->
  <div id="dusun-container" class="card p-4 mx-auto d-none" style="max-width:420px;">
    <h4 class="mb-3">Dusun</h4>
    <button class="btn btn-success w-100 mb-3" onclick="createDusun()">Tambah Dusun (Kepala Dusun)</button>
    <input id="dusunCodeJoin" class="form-control mb-2" placeholder="Masukkan Kode Dusun">
    <button class="btn btn-primary w-100" onclick="joinDusun()">Gabung Dusun</button>
    <button class="btn btn-secondary w-100 mt-3" onclick="backToLogin()">Kembali</button>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboard-container" class="d-none">
    <div class="d-flex justify-content-between mb-3">
      <h3>Dashboard Dusun</h3>
      <button class="btn btn-danger btn-sm" onclick="logout()">Logout</button>
    </div>

    <div class="card p-3 mb-3">
      <h5>Kode Dusun:</h5>
      <p id="dusunCodeDisplay" class="fw-bold text-primary"></p>
    </div>

    <!-- LAPORAN -->
    <div class="card p-3 mb-3">
      <h5>Buat Laporan SOS</h5>
      <select id="kejadian" class="form-control mb-2">
        <option>Kemalingan</option>
        <option>Kebakaran</option>
        <option>Medis</option>
        <option>Ambulance</option>
        <option>Mencurigakan</option>
      </select>
      <select id="lokasiOption" class="form-control mb-2" onchange="toggleLokasi()">
        <option value="saat_ini">Lokasi Saat Ini</option>
        <option value="lainnya">Lokasi Lain</option>
      </select>
      <textarea id="lokasiDeskripsi" class="form-control mb-2 d-none" placeholder="Rumah siapa / sekitar siapa / RT RW (opsional)"></textarea>
      <button class="btn btn-danger w-100" onclick="lapor()">Kirim Laporan</button>
    </div>

    <!-- GRAFIK -->
    <div class="card p-3 mb-3">
      <h5>Statistik Kejadian</h5>
      <canvas id="chartKejadian"></canvas>
    </div>

    <!-- POS JAGA -->
    <div class="card p-3 mb-3">
      <h5>Pos Jaga Dusun</h5>
      <div id="map"></div>
      <button class="btn btn-primary w-100 mt-3" onclick="tambahPos()">Tambah Pos RT</button>
      <div id="listPos" class="mt-3"></div>
    </div>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyA6GAeIc7ZesIed9MAelUf6x_sBFdp9E-Q",
  authDomain: "dusun-super.firebaseapp.com",
  projectId: "dusun-super",
  storageBucket: "dusun-super.firebasestorage.app",
  messagingSenderId: "1083284057385",
  appId: "1:1083284057385:web:21cfe467b047bb5a241b38",
  measurementId: "G-LJ6KP57Q9M"
};
const app = firebase.initializeApp(firebaseConfig);
const auth = firebase.getAuth(app);
const db = firebase.getFirestore(app);

// === AUTO LOGIN ===
auth.onAuthStateChanged(async (user) => {
  if (user) {
    loadDashboard();
  } else {
    show("login-container");
  }
});

// === UI ===
function show(id){
  document.getElementById("login-container").classList.add("d-none");
  document.getElementById("dusun-container").classList.add("d-none");
  document.getElementById("dashboard-container").classList.add("d-none");
  document.getElementById(id).classList.remove("d-none");
}
function showAddJoinDusun(){ show("dusun-container"); }
function backToLogin(){ show("login-container"); }
function toggleLokasi(){
  const opt=document.getElementById("lokasiOption").value;
  document.getElementById("lokasiDeskripsi").classList.toggle("d-none", opt!=="lainnya");
}

// === AUTH ===
async function login(){
  const email=document.getElementById("email").value;
  const pass=document.getElementById("password").value;
  await firebase.signInWithEmailAndPassword(auth,email,pass);
}
async function register(){
  const email=document.getElementById("email").value;
  const pass=document.getElementById("password").value;
  await firebase.createUserWithEmailAndPassword(auth,email,pass);
}
async function logout(){ await firebase.signOut(auth); }

// === DUSUN ===
async function createDusun(){
  const user=auth.currentUser;
  const kode="DUSUN-"+Math.random().toString(36).substring(2,8).toUpperCase();
  await firebase.setDoc(firebase.doc(db,"dusun",kode),{
    kode:kode, kepalaDusun:user.uid, createdAt:Date.now()
  });
  document.getElementById("dusunCodeDisplay").innerText=kode;
  alert("Dusun berhasil dibuat!");
  loadDashboard();
}
async function joinDusun(){
  const kode=document.getElementById("dusunCodeJoin").value;
  const user=auth.currentUser;
  const ref=firebase.doc(db,"dusun",kode);
  const snap=await firebase.getDoc(ref);
  if(snap.exists()){
    await firebase.setDoc(firebase.doc(db,"dusun",kode,"warga",user.uid),{
      email:user.email, joinedAt:Date.now()
    });
    alert("Gabung Dusun sukses!");
    loadDashboard();
  } else {
    alert("Kode dusun salah");
  }
}

// === DASHBOARD ===
async function loadDashboard(){
  show("dashboard-container");
  // TODO: load grafik, pos, laporan
}
async function lapor(){
  const user=auth.currentUser;
  const kejadian=document.getElementById("kejadian").value;
  const lokasiOpt=document.getElementById("lokasiOption").value;
  const lokasiDes=lokasiOpt==="lainnya"?document.getElementById("lokasiDeskripsi").value:"Lokasi Saat Ini";
  await firebase.addDoc(firebase.collection(db,"laporan"),{
    uid:user.uid, kejadian, lokasi:lokasiDes, createdAt:Date.now()
  });
  alert("Laporan terkirim!");
}
function tambahPos(){
  alert("Fitur tambah pos dengan map akan dihubungkan ke Google Maps API");
}
</script>
</body>
</html>
