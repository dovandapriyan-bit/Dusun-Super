<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sistem Keamanan Dusun - FULL</title>

<!-- Bootstrap for quick clean UI -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- Firebase (Web v10 compatibility usage via simple namespace calls) -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  body { background:#f4f7ff; font-family:Inter,Segoe UI,Arial,sans-serif; }
  .card { border-radius:12px; box-shadow:0 6px 18px rgba(20,30,60,0.06); }
  .form-control, .btn { border-radius:10px; }
  #map { width:100%; height:350px; border-radius:10px; }
  .small-muted { font-size:0.9rem; color:#555; }
</style>
</head>
<body>
<div class="container py-4">

  <!-- SINGLE-PAGE LAYOUT: Create / Register / Login -->
  <div id="mainCard" class="card p-4 mx-auto" style="max-width:920px;">
    <h3 class="text-center mb-3">Sistem Keamanan Dusun — FULL</h3>
    <div class="row g-3">
      <!-- left column: Buat Dusun -->
      <div class="col-md-6">
        <div class="card p-3 mb-3">
          <h5>Buat Dusun (Kepala Dusun)</h5>
          <input id="namaDusun" class="form-control mb-2" placeholder="Nama Dusun">
          <input id="desa" class="form-control mb-2" placeholder="Desa">
          <input id="kota" class="form-control mb-2" placeholder="Kota">
          <input id="kabupaten" class="form-control mb-2" placeholder="Kabupaten">
          <input id="kecamatan" class="form-control mb-2" placeholder="Kecamatan">

          <!-- Kode Dusun tampil sebagai input field setelah Generate -->
          <input id="kodeDusunField" class="form-control mb-2 d-none" placeholder="Kode Dusun (generated)" readonly>

          <div class="d-grid gap-2">
            <button id="generateBtn" class="btn btn-primary" onclick="generateKode()">Generate Kode</button>
            <button id="saveDusunBtn" class="btn btn-success d-none" onclick="simpanDusun()">Simpan Dusun</button>
          </div>

          <div class="mt-2 small-muted">Keterangan: Setelah generate, kode akan muncul di field. Kepala Dusun harus menyimpan dan memberikan kode ini kepada warga untuk mendaftar.</div>
        </div>

        <!-- register -->
        <div class="card p-3 mb-3">
          <h5>Daftar Warga</h5>
          <input id="namaWarga" class="form-control mb-2" placeholder="Nama lengkap">
          <input id="noHpDaftar" class="form-control mb-2" placeholder="No HP (digunakan sebagai username)">
          <input id="alamat" class="form-control mb-2" placeholder="Alamat (jalan)">
          <input id="blok" class="form-control mb-2" placeholder="Blok (opsional)">
          <input id="nomor" class="form-control mb-2" placeholder="No (opsional)">
          <div class="row g-2 mb-2">
            <div class="col"><input id="rt" class="form-control" placeholder="RT"></div>
            <div class="col"><input id="rw" class="form-control" placeholder="RW"></div>
          </div>

          <input id="passwordDaftar" type="password" class="form-control mb-2" placeholder="Password">
          <select id="roleWarga" class="form-control mb-2">
            <option value="kepala_desa">Kepala Desa</option>
            <option value="kepala_dusun">Kepala Dusun</option>
            <option value="ketua_rt">Ketua RT</option>
            <option value="ketua_rw">Ketua RW</option>
            <option value="kepala_keluarga">Kepala Keluarga</option>
            <option value="istri">Istri</option>
            <option value="anak">Anak</option>
            <option value="lainnya">Lainnya</option>
          </select>
          <!-- important: warga must input kode -->
          <input id="kodeDusunInput" class="form-control mb-2" placeholder="Kode Dusun (dapat dari Kepala Dusun)">

          <div class="d-grid">
            <button class="btn btn-success" onclick="daftar()">Daftar</button>
          </div>
        </div>
      </div>

      <!-- right column: Login & info -->
      <div class="col-md-6">
        <div class="card p-3 mb-3">
          <h5>Login</h5>
          <input id="noHpLogin" class="form-control mb-2" placeholder="No HP">
          <input id="passwordLogin" type="password" class="form-control mb-2" placeholder="Password">
          <div class="d-grid">
            <button class="btn btn-primary" onclick="login()">Login</button>
          </div>
        </div>

        <div class="card p-3 mb-3">
          <h6>Petunjuk singkat</h6>
          <ul>
            <li>Kepala Dusun: buat dusun → generate kode → simpan → bagikan kode ke warga.</li>
            <li>Warga: daftar pakai <b>Kode Dusun</b> yang diberikan kepala dusun.</li>
            <li>Login pakai No HP + Password.</li>
            <li>Dashboard menampilkan fitur laporan SOS, pos jaga, statistik, dan realtime clock.</li>
          </ul>
        </div>

        <div class="card p-3">
          <small class="text-muted">Catatan: ganti <code>YOUR_GOOGLE_MAPS_API_KEY</code> di akhir file dengan kunci Google Maps-mu.</small>
        </div>
      </div>
    </div>
  </div>

  <!-- DASHBOARD PAGE -->
  <div id="dashboardCard" class="card p-4 mx-auto mt-4 d-none" style="max-width:1100px;">
    <div class="d-flex justify-content-between align-items-start">
      <div>
        <h4 id="dashTitle">Dashboard Dusun</h4>
        <div class="small-muted">Selamat datang, <b id="userName"></b> · <span id="realtimeClock"></span></div>
      </div>
      <div class="text-end">
        <button class="btn btn-outline-danger btn-sm" onclick="logout()">Logout</button>
      </div>
    </div>

    <!-- kode dusun (only kepala dusun) -->
    <div id="kodeDashboardDiv" class="card p-3 mt-3 d-none">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <div class="small-muted">Kode Dusun (untuk bagikan ke warga)</div>
          <h5 id="profileKodeDusun"></h5>
        </div>
        <div>
          <div class="small-muted">Sisa waktu pergantian</div>
          <div id="profileCountdown" style="font-weight:600"></div>
        </div>
      </div>
    </div>

    <div class="row mt-3 g-3">
      <!-- left: laporan + statistik -->
      <div class="col-lg-5">
        <div class="card p-3 mb-3">
          <h6>Buat Laporan SOS</h6>
          <select id="kejadian" class="form-control mb-2">
            <option value="Kemalingan">Kemalingan</option>
            <option value="Kebakaran">Kebakaran</option>
            <option value="Medis">Medis</option>
            <option value="Ambulance">Ambulance</option>
            <option value="Mencurigakan">Mencurigakan</option>
          </select>
          <select id="lokasiOption" class="form-control mb-2" onchange="toggleLokasi()">
            <option value="saat_ini">Lokasi Saat Ini</option>
            <option value="lainnya">Lokasi Lain</option>
          </select>
          <textarea id="lokasiDeskripsi" class="form-control mb-2 d-none" placeholder="Deskripsi lokasi (opsional)"></textarea>
          <div class="d-grid">
            <button class="btn btn-danger" onclick="laporSOS()">Kirim Laporan</button>
          </div>
          <div class="small-muted mt-2">Laporan akan disimpan ke Firestore dan dipakai untuk statistik.</div>
        </div>

        <div class="card p-3 mb-3">
          <h6>Statistik Kejadian</h6>
          <canvas id="chartKejadian"></canvas>
        </div>

        <div class="card p-3">
          <h6>Daftar Laporan Terbaru</h6>
          <div id="listLaporan"></div>
        </div>
      </div>

      <!-- right: map, pos jaga -->
      <div class="col-lg-7">
        <div class="card p-3 mb-3">
          <h6>Pos Jaga Dusun</h6>
          <div id="map"></div>
          <div class="d-flex gap-2 mt-3">
            <button class="btn btn-primary" onclick="promptTambahPos()">Tambah Pos RT</button>
            <button class="btn btn-outline-secondary" onclick="loadPosJaga()">Muat Ulang Pos</button>
          </div>
          <div id="listPos" class="mt-3"></div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Google Maps API (replace YOUR_GOOGLE_MAPS_API_KEY) -->
<script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY"></script>

<script>
/* ============================
   Firebase init (update config if needed)
   ============================ */
const firebaseConfig = {
  apiKey: "AIzaSyA6GAeIc7ZesIed9MAelUf6x_sBFdp9E-Q",
  authDomain: "dusun-super.firebaseapp.com",
  projectId: "dusun-super",
  storageBucket: "dusun-super.firebasestorage.app",
  messagingSenderId: "1083284057385",
  appId: "1:1083284057385:web:21cfe467b047bb5a241b38",
  measurementId: "G-LJ6KP57Q9M"
};
const app = firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ============================
   State
   ============================ */
let currentUser = null;
let generatedCode = "";
let currentDusunDocId = null;
let map;
let markers = [];
let laporanChart = null;
let countdownInterval = null;

/* ============================
   Helpers
   ============================ */
function uidNow(){ return Date.now(); }

function showToast(msg){ alert(msg); } // simple for now

/* ============================
   CREATE DUSUN: generate -> show in input -> save
   ============================ */
function generateKode(){
  generatedCode = "DSN" + Math.random().toString(36).substring(2,8).toUpperCase();
  // show in input field in create form
  const kodeField = document.getElementById("kodeDusunField");
  kodeField.value = generatedCode;
  kodeField.classList.remove("d-none");
  // toggle buttons
  document.getElementById("generateBtn").classList.add("d-none");
  document.getElementById("saveDusunBtn").classList.remove("d-none");
}

async function simpanDusun(){
  const nama = document.getElementById("namaDusun").value.trim();
  const desa = document.getElementById("desa").value.trim();
  const kota = document.getElementById("kota").value.trim();
  const kab = document.getElementById("kabupaten").value.trim();
  const kec = document.getElementById("kecamatan").value.trim();
  const code = document.getElementById("kodeDusunField").value.trim();

  if(!nama||!desa||!kota||!kab||!kec||!code) {
    return showToast("Isi semua field dan generate kode sebelum menyimpan.");
  }

  // set codeExpiresAt = now + 1 jam
  const codeExpiresAt = Date.now() + 3600000;

  const docRef = await db.collection("dusun").add({
    nama, desa, kota, kabupaten: kab, kecamatan: kec,
    code, codeExpiresAt,
    createdAt: Date.now()
  });

  // store locally (so kepala dusun session bisa show code)
  currentDusunDocId = docRef.id;
  // show code in create UI (already visible)
  showToast("Dusun tersimpan. Kode: " + code);

  // start countdown updater for this dusun (kecuali jika page reload)
  startKodeWatcher(docRef.id, true);
}

/* ============================
   WATCH / UPDATE KODE: show to Kepala Dusun & auto-rotate when expired
   - startKodeWatcher(dusunId, amIKepalaDusunBoolean)
   - Listens to the dusun document for changes to code and codeExpiresAt
   - If current user is kepala_dusun AND code is expired, generates new code and updates Firestore
   ============================ */
function startKodeWatcher(dusunId, willAutoRotateIfExpired=false){
  // clear previous
  if(countdownInterval) { clearInterval(countdownInterval); countdownInterval=null; }

  // realtime listener
  db.collection("dusun").doc(dusunId).onSnapshot(async snap => {
    if(!snap.exists) return;
    const data = snap.data();
    const code = data.code;
    const expires = data.codeExpiresAt || 0;
    // update displayed code if dashboard open
    document.getElementById("profileKodeDusun").innerText = code || "";
    // update create form field too
    const kodeField = document.getElementById("kodeDusunField");
    if(kodeField) {
      kodeField.value = code || kodeField.value;
      if(code) kodeField.classList.remove("d-none");
    }
    // set timer to update countdown every second using expires
    if(countdownInterval) clearInterval(countdownInterval);
    countdownInterval = setInterval(async () => {
      const now = Date.now();
      let remaining = Math.max(0, Math.floor((expires - now)/1000)); // seconds
      const hh = Math.floor(remaining/3600);
      const mm = Math.floor((remaining%3600)/60);
      const ss = remaining%60;
      const txt = `${hh}h ${mm}m ${ss}s`;
      // show in create and profile countdown places
      const cdElm = document.getElementById("countdownTimer");
      if(cdElm) cdElm.innerText = txt;
      const cdProfile = document.getElementById("profileCountdown");
      if(cdProfile) cdProfile.innerText = txt;

      // if expired and this client is kepala dusun (and allowed to rotate)
      if(remaining <= 0 && willAutoRotateIfExpired && currentUser && currentUser.role === "kepala_dusun") {
        // generate new code and update Firestore atomically
        const newCode = "DSN" + Math.random().toString(36).substring(2,8).toUpperCase();
        const newExpires = Date.now() + 3600000;
        try {
          await db.collection("dusun").doc(dusunId).update({ code: newCode, codeExpiresAt: newExpires });
          // Firestore onSnapshot will update UI automatically
        } catch(e) {
          console.error("Gagal update kode:", e);
        }
      }
    }, 1000);
  });
}

/* ============================
   REGISTRATION
   ============================ */
async function daftar(){
  const nama = document.getElementById("namaWarga").value.trim();
  const noHp = document.getElementById("noHpDaftar").value.trim();
  const alamat = document.getElementById("alamat").value.trim();
  const blok = document.getElementById("blok").value.trim();
  const nomor = document.getElementById("nomor").value.trim();
  const rt = document.getElementById("rt").value.trim();
  const rw = document.getElementById("rw").value.trim();
  const password = document.getElementById("passwordDaftar").value;
  const role = document.getElementById("roleWarga").value;
  const kodeDusun = document.getElementById("kodeDusunInput").value.trim();

  if(!nama || !noHp || !password || !kodeDusun) return showToast("Nama, No HP, Password dan Kode Dusun wajib diisi.");

  // verify kode dusun maps to a dusun doc
  const q = await db.collection("dusun").where("code", "==", kodeDusun).get();
  if(q.empty) return showToast("Kode Dusun tidak valid. Pastikan kode terbaru dari Kepala Dusun.");
  const dusunDoc = q.docs[0];
  const dusunId = dusunDoc.id;

  // save user doc (id = noHp)
  await db.collection("users").doc(noHp).set({
    nama, noHp, alamat, blok, nomor, rt, rw, password, role, dusunId, createdAt: Date.now()
  });

  showToast("Pendaftaran berhasil — silakan login.");
  // optional: clear register form
}

/* ============================
   LOGIN
   ============================ */
async function login(){
  const noHp = document.getElementById("noHpLogin").value.trim();
  const password = document.getElementById("passwordLogin").value;
  if(!noHp || !password) return showToast("Isi No HP dan Password.");

  const doc = await db.collection("users").doc(noHp).get();
  if(!doc.exists) return showToast("User tidak ditemukan.");
  const user = doc.data();
  if(user.password !== password) return showToast("Password salah.");

  currentUser = user;
  // show dashboard
  document.getElementById("mainCard")?.classList?.add("d-none");
  document.getElementById("mainContainer")?.classList?.add("d-none");
  document.getElementById("dashboardCard").classList.remove("d-none");
  document.getElementById("userName").innerText = user.nama || user.noHp;

  // realtime clock
  startClock();

  // load dashboard data for user's dusun
  const dusunId = user.dusunId;
  if(!dusunId) {
    showToast("User belum terikat dengan Dusun (dusunId kosong).");
    return;
  }
  currentDusunDocId = dusunId;

  // start kode watcher but auto-rotate only if current user is kepala_dusun
  startKodeWatcher(dusunId, user.role === "kepala_dusun");

  // show kode section only for kepala_dusun
  if(user.role === "kepala_dusun") {
    document.getElementById("kodeDashboardDiv").classList.remove("d-none");
  } else {
    document.getElementById("kodeDashboardDiv").classList.add("d-none");
  }

  // load pos jaga & laporan & chart
  await loadPosJaga();
  await loadLaporanAndRenderChart();
  // listen to laporan changes (real-time)
  db.collection("laporan").where("dusunId", "==", dusunId)
    .onSnapshot(() => loadLaporanAndRenderChart());
}

/* ============================
   Clock
   ============================ */
function startClock(){
  setInterval(() => {
    const now = new Date();
    document.getElementById("realtimeClock").innerText = now.toLocaleString('id-ID', {
      weekday: 'long', year:'numeric', month:'long', day:'numeric', hour:'2-digit', minute:'2-digit', second:'2-digit'
    });
  }, 1000);
}

/* ============================
   LAPOR SOS
   ============================ */
async function laporSOS(){
  if(!currentUser) return showToast("Login dulu.");
  const kejadian = document.getElementById("kejadian").value;
  const lokasiOpt = document.getElementById("lokasiOption").value;
  const lokasiDes = lokasiOpt === "lainnya" ? document.getElementById("lokasiDeskripsi").value.trim() : "Lokasi Saat Ini";
  const dusunId = currentUser.dusunId;

  await db.collection("laporan").add({
    dusunId, uid: currentUser.noHp, kejadian, lokasi: lokasiDes, createdAt: Date.now()
  });
  showToast("Laporan SOS terkirim.");
}

/* ============================
   LOAD & RENDER LAPORAN + CHART
   ============================ */
async function loadLaporanAndRenderChart(){
  if(!currentDusunDocId) return;
  const snap = await db.collection("laporan").where("dusunId", "==", currentDusunDocId).orderBy("createdAt", "desc").limit(50).get();
  const reports = snap.docs.map(d => ({ id: d.id, ...d.data() }));

  // show list
  const listDiv = document.getElementById("listLaporan");
  listDiv.innerHTML = "";
  if(reports.length === 0) listDiv.innerHTML = "<div class='small-muted'>Belum ada laporan.</div>";
  reports.slice(0,10).forEach(r => {
    const el = document.createElement("div");
    el.className = "mb-2";
    const dt = new Date(r.createdAt).toLocaleString();
    el.innerHTML = `<div><b>${r.kejadian}</b> — ${r.lokasi || ''}</div><div class="small-muted">${dt}</div>`;
    listDiv.appendChild(el);
  });

  // aggregate counts by kejadian for chart
  const counts = {};
  reports.forEach(r => counts[r.kejadian] = (counts[r.kejadian]||0) + 1);
  const labels = Object.keys(counts).length ? Object.keys(counts) : ["Tidak ada"];
  const data = labels.map(l => counts[l] || 0);

  // render chart (destroy previous)
  if(laporanChart) laporanChart.destroy();
  const ctx = document.getElementById("chartKejadian").getContext("2d");
  laporanChart = new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets: [{ label:'Jumlah', data, backgroundColor: labels.map((_,i)=>['#36a2eb','#ff6384','#ffce56','#4caf50','#9c27b0'][i%5]) }] },
    options: { responsive:true, plugins:{ legend:{ display:false } } }
  });
}

/* ============================
   POS JAGA (MAP)
   - loadPosJaga() : loads subcollection posJaga from current dusun and puts markers
   - promptTambahPos() : simple prompts for name + lat + lng, then save
   ============================ */
function initMapIfNeeded(){
  if(window.google && !map){
    // default center (fallback). Later we'll recenter based on first pos or user geolocation
    map = new google.maps.Map(document.getElementById("map"), { center:{lat:-6.200, lng:106.816}, zoom:13 });
  }
}

async function loadPosJaga(){
  initMapIfNeeded();
  // clear markers
  markers.forEach(m => m.setMap(null));
  markers = [];
  document.getElementById("listPos").innerHTML = "";

  if(!currentDusunDocId) return;
  const snap = await db.collection("dusun").doc(currentDusunDocId).collection("posJaga").get();
  if(snap.empty) {
    document.getElementById("listPos").innerHTML = "<div class='small-muted'>Belum ada pos jaga.</div>";
    return;
  }
  const bounds = new google.maps.LatLngBounds();
  snap.forEach(doc => {
    const p = doc.data();
    const li = document.createElement("div");
    li.innerHTML = `<b>${p.nama}</b> — Lat:${p.lat}, Lng:${p.lng}`;
    document.getElementById("listPos").appendChild(li);
    // add marker
    if(map && p.lat && p.lng){
      const marker = new google.maps.Marker({ position:{lat:p.lat, lng:p.lng}, map, title:p.nama });
      markers.push(marker);
      bounds.extend(marker.getPosition());
    }
  });
  if(markers.length) map.fitBounds(bounds);
}

async function promptTambahPos(){
  if(!currentUser) return showToast("Login dulu.");
  const nama = prompt("Nama pos (contoh: Pos RT 01)");
  if(!nama) return;
  const lat = parseFloat(prompt("Latitude (contoh -6.200):"));
  const lng = parseFloat(prompt("Longitude (contoh 106.816):"));
  if(Number.isNaN(lat) || Number.isNaN(lng)) return showToast("Koordinat tidak valid.");

  // save to subcollection
  await db.collection("dusun").doc(currentDusunDocId).collection("posJaga").add({
    nama, lat, lng, createdAt: Date.now()
  });
  showToast("Pos jaga tersimpan.");
  loadPosJaga();
}

/* ============================
   Utility: toggle lokasi deskripsi
   ============================ */
function toggleLokasi(){
  const opt = document.getElementById("lokasiOption").value;
  document.getElementById("lokasiDeskripsi").classList.toggle("d-none", opt !== "lainnya");
}

/* ============================
   Logout
   ============================ */
function logout(){
  currentUser = null;
  // hide dashboard, show main
  document.getElementById("dashboardCard").classList.add("d-none");
  document.getElementById("mainContainer").classList.remove("d-none");
  // stop listeners/intervals where appropriate (we leave firestore listeners; they are lightweight)
  if(countdownInterval){ clearInterval(countdownInterval); countdownInterval = null; }
}

/* ============================
   Entry: init map when google maps loaded
   ============================ */
function waitForGoogleMapsThenInit(){
  if(window.google && window.google.maps){
    initMapIfNeeded();
  } else {
    setTimeout(waitForGoogleMapsThenInit, 500);
  }
}
waitForGoogleMapsThenInit();

/* ============================
   Auto-run: if user created dusun this session, start watcher?
   (We already start watcher when saving.)
   ============================ */
</script>
</body>
</html>
