<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <title>Sistem Keamanan Dusun — FULL (All-in-one)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- CSS (Bootstrap) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    :root { --card-radius:12px; }
    body { background:#f4f7ff; font-family:Inter,Segoe UI,Arial,sans-serif; padding:18px; }
    .card { border-radius:var(--card-radius); box-shadow:0 6px 18px rgba(20,30,60,0.06); }
    .form-control, .btn { border-radius:8px; }
    input.upper{ text-transform:uppercase; }
    .hidden{ display:none!important; }
    .muted{ color:#666; font-size:0.9rem; }
    .copy-btn{ min-width:96px; }
    #map{ width:100%; height:320px; border-radius:8px; background:#eef; }
    .small{ font-size:0.85rem; color:#555; }
    .topbar { display:flex; justify-content:space-between; align-items:center; gap:12px; }
    .role-badge { font-weight:600; color:#fff; padding:4px 8px; border-radius:8px; background:#6c63ff; }
  </style>
</head>
<body>
<div class="container mx-auto" style="max-width:1100px;">
  <h3 class="text-center mb-4">Sistem Keamanan Dusun — FULL</h3>

  <!-- AUTH / CREATE -->
  <div id="authCard" class="card p-3 mb-4">
    <div class="row g-3">
      <!-- Left: Buat Dusun (Kepala Dusun) -->
      <div class="col-md-6">
        <h5>Buat Dusun (Kepala Dusun)</h5>
        <input id="dusun_nama" class="form-control mb-2 upper" placeholder="NAMA DUSUN">
        <input id="dusun_desa" class="form-control mb-2 upper" placeholder="DESA">
        <input id="dusun_kecamatan" class="form-control mb-2 upper" placeholder="KECAMATAN">
        <input id="dusun_kab" class="form-control mb-2 upper" placeholder="KABUPATEN / KOTA">
        <input id="dusun_prov" class="form-control mb-2 upper" placeholder="PROVINSI">

        <!-- kode group -->
        <div id="kode_group" class="input-group mb-2 hidden">
          <input id="dusun_code" class="form-control" placeholder="KODE DUSUN (GENERATED)" readonly>
          <button id="copy_code_btn" class="btn btn-outline-secondary copy-btn" type="button">COPY</button>
        </div>

        <div class="d-grid gap-2 mb-2">
          <button id="generate_btn" class="btn btn-primary">Generate Kode</button>
          <button id="save_dusun_btn" class="btn btn-success hidden">Simpan Dusun</button>
        </div>
        <div class="muted">Setelah generate: SALIN kode & bagikan ke warga. Kode berlaku sesuai pengaturan (default 24 jam) dan dapat diganti kapan saja oleh Kepala Dusun.</div>
      </div>

      <!-- Right: Daftar & Login -->
      <div class="col-md-6">
        <h5>Daftar Warga</h5>
        <input id="reg_nama" class="form-control mb-2" placeholder="NAMA LENGKAP">
        <input id="reg_hp" class="form-control mb-2" placeholder="NOMOR HP (contoh: 0812... atau +62812...)" oninput="formatPhoneTyping(this)">
        <input id="reg_password" type="password" class="form-control mb-2" placeholder="PASSWORD (min 6)">
        <div class="row g-2">
          <div class="col-8">
            <input id="reg_provinsi" class="form-control mb-2" placeholder="PROVINSI (pilih dropdown nanti)">
          </div>
          <div class="col-4">
            <input id="reg_kode" class="form-control mb-2 upper" placeholder="KODE DUSUN (dari Kepala Dusun)">
          </div>
        </div>
        <div class="row g-2 mb-2">
          <div class="col">
            <input id="reg_kab" class="form-control" placeholder="KABUPATEN/KOTA">
          </div>
          <div class="col">
            <input id="reg_kec" class="form-control" placeholder="KECAMATAN">
          </div>
        </div>
        <div class="row g-2 mb-2">
          <div class="col">
            <input id="reg_desa" class="form-control" placeholder="DESA/KELURAHAN">
          </div>
          <div class="col">
            <input id="reg_blok" class="form-control" placeholder="BLOK (opsional)">
          </div>
        </div>
        <div class="d-grid gap-2">
          <button class="btn btn-success" onclick="onRegister()">Daftar</button>
          <button class="btn btn-outline-secondary" onclick="clearRegister()">Reset</button>
        </div>

        <hr>

        <h5>Login</h5>
        <input id="login_hp" class="form-control mb-2" placeholder="NOMOR HP (contoh: 0812... atau +62812...)" oninput="formatPhoneTyping(this)">
        <input id="login_pass" type="password" class="form-control mb-2" placeholder="PASSWORD">
        <div class="d-grid gap-2">
          <button class="btn btn-primary" onclick="onLogin()">Login</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dashboardCard" class="card p-3 hidden">
    <div class="topbar">
      <div>
        <h4>Dashboard Dusun</h4>
        <div class="muted">Selamat datang, <b id="display_name"></b> · <span id="display_role"></span></div>
        <div class="muted small">Waktu: <span id="clock"></span></div>
      </div>
      <div class="text-end">
        <button id="btnLogout" class="btn btn-danger btn-sm">Logout</button>
      </div>
    </div>

    <!-- kode (kepala dusun only) -->
    <div id="kodeDashboard" class="card p-3 mt-3 d-none">
      <div class="d-flex justify-content-between">
        <div>
          <div class="muted">Kode Dusun</div>
          <h5 id="display_code"></h5>
        </div>
        <div>
          <div class="muted">Sisa waktu</div>
          <div id="display_countdown" style="font-weight:600"></div>
        </div>
      </div>
    </div>

    <div class="row mt-3 g-3">
      <div class="col-lg-5">
        <div class="card p-3 mb-3">
          <h6>Buat Laporan SOS</h6>
          <select id="lap_jenis" class="form-control mb-2">
            <option>Kemalingan</option>
            <option>Kebakaran</option>
            <option>Medis</option>
            <option>Ambulance</option>
            <option>Mencurigakan</option>
          </select>
          <select id="lap_loc_opt" class="form-control mb-2" onchange="toggleLokasiInput()">
            <option value="saat_ini">Lokasi Saat Ini (jika diizinkan)</option>
            <option value="lainnya">Lokasi Lain</option>
          </select>
          <textarea id="lap_lokasi" class="form-control mb-2 hidden" placeholder="Deskripsi lokasi (opsional)"></textarea>
          <div class="d-grid">
            <button class="btn btn-danger" onclick="sendReport()">Kirim Laporan</button>
          </div>
        </div>

        <div class="card p-3 mb-3">
          <h6>Statistik Kejadian</h6>
          <canvas id="chartKejadian" style="width:100%;height:220px"></canvas>
        </div>

        <div class="card p-3 mb-3">
          <h6>Daftar Laporan Terbaru</h6>
          <div id="listReports"></div>
        </div>
      </div>

      <div class="col-lg-7">
        <div class="card p-3 mb-3">
          <h6>Pos Jaga Dusun</h6>
          <div id="map">Peta (Google Maps) - tambahkan API key untuk aktivasi</div>
          <div class="d-flex gap-2 mt-3">
            <button class="btn btn-primary" onclick="promptAddPos()">Tambah Pos RT</button>
            <button class="btn btn-outline-secondary" onclick="loadPos()">Muat Ulang Pos</button>
          </div>
          <div id="listPos" class="mt-3"></div>
        </div>

        <div id="kkPanel" class="card p-3 mb-3 hidden">
          <h6>Verifikasi Warga (KK)</h6>
          <div id="pendingList"></div>
        </div>

        <div id="adminPanel" class="card p-3 mb-3 hidden">
          <h6>Manajemen Dusun (Kepala Dusun)</h6>
          <div class="d-flex gap-2 mb-2">
            <button class="btn btn-outline-primary" onclick="regenerateCode()">Regenerate Kode</button>
            <button class="btn btn-outline-danger" onclick="expireCodeNow()">Expire Kode Sekarang</button>
          </div>
          <div id="dusunInfo"></div>
        </div>

      </div>
    </div>
  </div>

</div>

<!-- Google Maps: ganti key ini jika ingin aktif (opsional) -->
<script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY"></script>

<script>
/* ===================================================== */
/* ============ CONFIG: GANTI SESUAI KEBUTUHAN ========== */
/* ===================================================== */

/* Firebase config - GANTI DENGAN PROYEK FIREBASE ANDA */
const firebaseConfig = {
  apiKey: "YOUR_FIREBASE_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
  appId: "YOUR_APP_ID"
};

/* Masa berlaku kode dusun (ms) - default 24 jam */
const KODE_EXPIRE_MS = 24 * 60 * 60 * 1000;

/* ===================================================== */
/* ================ END CONFIG ========================= */
/* ===================================================== */

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* ================= State ================= */
let currentUser = null;
let currentWargaDoc = null;
let currentDusunDoc = null;
let kodeInterval = null;
let laporanChart = null;
let mapObj = null;
let posMarkers = [];

/* ================= Helpers ================= */
const $ = id => document.getElementById(id);
const show = id => { const el=$(id); if(el) el.classList.remove('hidden'); };
const hide = id => { const el=$(id); if(el) el.classList.add('hidden'); };
const SwalToast = (title, icon='success', timer=2000) => { return Swal.fire({ title, icon, toast:true, position:'top-end', showConfirmButton:false, timer }); };
const SwalAlert = (title, html, icon='info') => { return Swal.fire({ title, html, icon }); };

/* Auto-uppercase for inputs with class "upper" */
document.addEventListener('input', e=>{
  if(e.target && e.target.classList && e.target.classList.contains('upper')){
    e.target.value = e.target.value.toUpperCase();
  }
});

/* ================ Phone formatting & RT/RW padding ================ */
function normalizePhoneForKey(v){
  let s = (v||"").replace(/\s+/g,"").replace(/\D/g,"");
  if(s.startsWith("0")) s = "62"+s.substring(1);
  if(!s.startsWith("62")) s = "62"+s;
  return s; // e.g. "62812..."
}
function formatPhoneTyping(el){
  let raw = el.value.replace(/[^\d\+]/g,"");
  if(raw.startsWith("+")) {
    let digits = raw.replace(/\D/g,"");
    el.value = "+" + digits;
  } else {
    el.value = raw;
  }
}

/* ================ Clock ================== */
function updateClock(){ 
  const now = new Date(); 
  $('clock').innerText = now.toLocaleString();
  setTimeout(updateClock,1000);
}

/* ================ Initialize Chart ================ */
function initChart() {
  const ctx = document.getElementById('chartKejadian').getContext('2d');
  laporanChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['Kebakaran','Kemalingan','Medis','Ambulance','Mencurigakan'],
      datasets: [{ label: 'Jumlah', data: [0,0,0,0,0], backgroundColor: ['#e74c3c','#f39c12','#3498db','#2ecc71','#9b59b6'] }]
    },
    options: { responsive:true, maintainAspectRatio:false }
  });
}

/* ================ Generate Kode Dusun ================ */
function generateCode(){
  return Math.random().toString(36).substring(2,9).toUpperCase();
}

/* ================ UI: Generate & Save Dusun ================ */
$('generate_btn').addEventListener('click', ()=>{
  const code = generateCode();
  $('dusun_code').value = code;
  show('kode_group');
  show('save_dusun_btn');
});

$('copy_code_btn').addEventListener('click', ()=>{
  navigator.clipboard.writeText($('dusun_code').value);
  SwalToast("Kode Dusun disalin!");
});

$('save_dusun_btn').addEventListener('click', onSaveDusun);

async function onSaveDusun(){
  const nama=$('dusun_nama').value.trim();
  const desa=$('dusun_desa').value.trim();
  const kec=$('dusun_kecamatan').value.trim();
  const kab=$('dusun_kab').value.trim();
  const prov=$('dusun_prov').value.trim();
  const code=$('dusun_code').value.trim();
  if(!nama||!code){ SwalAlert("Gagal","Nama & Kode Dusun wajib","error"); return; }
  if(!currentUser){ SwalAlert("Gagal","Anda harus login sebagai Kepala Dusun terlebih dahulu","error"); return; }

  try{
    // pastikan kode unik
    const q = await db.collection('Dusun').where('kode','==',code).get();
    if(!q.empty){ SwalAlert("Gagal","Kode sudah terpakai. Silakan generate ulang.","error"); return; }

    const now = firebase.firestore.FieldValue.serverTimestamp();
    const expiresAt = Date.now() + KODE_EXPIRE_MS;
    const docRef = await db.collection('Dusun').add({
      nama, desa, kecamatan:kec, kabupaten:kab, provinsi:prov,
      kode: code,
      kepalaId: currentUser.uid,
      createdAt: now,
      kodeExpiresAt: firebase.firestore.Timestamp.fromMillis(expiresAt),
      active:true
    });
    currentDusunDoc = { id: docRef.id, data: { nama, kode:code, kodeExpiresAt: expiresAt } };
    SwalToast("Dusun tersimpan!");
    hide('save_dusun_btn');
    showDusunOnDashboard();
  }catch(err){
    SwalAlert("Error", err.message,'error');
  }
}

/* ================ Registration ================ */
async function onRegister(){
  const nama=$('reg_nama').value.trim();
  const hp=$('reg_hp').value.trim();
  const password=$('reg_password').value;
  const kodeDusun = $('reg_kode').value.trim().toUpperCase();
  const prov = $('reg_provinsi').value.trim();
  const kab = $('reg_kab').value.trim();
  const kec = $('reg_kec').value.trim();
  const desa = $('reg_desa').value.trim();
  const blok = $('reg_blok').value.trim();

  if(!nama||!hp||!password||!kodeDusun){ SwalAlert("Error","Lengkapi: Nama, HP, Password, Kode Dusun","error"); return; }
  if(password.length < 6){ SwalAlert("Error","Password minimal 6 karakter","error"); return; }

  try{
    // Validasi kode dusun
    const snap = await db.collection('Dusun').where('kode','==',kodeDusun).limit(1).get();
    if(snap.empty) { SwalAlert("Error","Kode Dusun tidak valid","error"); return; }
    const dusunDoc = snap.docs[0];
    const dusunData = dusunDoc.data();
    // Cek expiry jika ada
    if(dusunData.kodeExpiresAt && dusunData.kodeExpiresAt.toMillis && dusunData.kodeExpiresAt.toMillis() < Date.now()){
      SwalAlert("Error","Kode Dusun sudah kadaluarsa. Minta kode baru dari Kepala Dusun","error"); return;
    }

    // Cek duplikat nomor HP
    const norm = normalizePhoneForKey(hp);
    const dup = await db.collection('Warga').where('phone','==',norm).limit(1).get();
    if(!dup.empty){ SwalAlert("Error","Nomor HP ini sudah terdaftar","error"); return; }

    // Buat akun di Firebase Auth (email panggilan)
    const fakeEmail = norm + "@dusun.fake";
    const userCred = await auth.createUserWithEmailAndPassword(fakeEmail, password);
    const uid = userCred.user.uid;

    await db.collection('Warga').doc(uid).set({
      nama, phone: norm, role: 'warga', status: 'pending',
      kodeDusun: kodeDusun,
      provinsi: prov, kabupaten: kab, kecamatan: kec, desa: desa, blok: blok,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    SwalToast("Pendaftaran berhasil! Menunggu verifikasi Kepala Keluarga.");
    clearRegister();
  }catch(err){
    SwalAlert("Error", err.message,'error');
  }
}

function clearRegister(){
  ['reg_nama','reg_hp','reg_password','reg_provinsi','reg_kab','reg_kec','reg_desa','reg_blok','reg_kode'].forEach(id=>{
    const el=$(id); if(el) el.value='';
  });
}

/* ================ Login ================== */
async function onLogin(){
  const hp = $('login_hp').value.trim();
  const password = $('login_pass').value;
  if(!hp||!password){ SwalAlert("Error","Nomor HP & password wajib","error"); return; }

  try{
    const norm = normalizePhoneForKey(hp);
    const fakeEmail = norm + "@dusun.fake";

    // set persistence local agar tetap login
    await firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL);
    const userCred = await auth.signInWithEmailAndPassword(fakeEmail, password);
    currentUser = userCred.user;
    // Simpan UID di localStorage untuk auto-login fallback
    localStorage.setItem('userUID', currentUser.uid);
    SwalToast("Login berhasil!");
    await loadUserProfile();
    showDashboard();
  }catch(err){
    SwalAlert("Error", err.message,'error');
  }
}

/* ================ Load User Profile ================== */
async function loadUserProfile(){
  if(!auth.currentUser) return;
  const uid = auth.currentUser.uid;
  const doc = await db.collection('Warga').doc(uid).get();
  if(!doc.exists){
    // kalau tidak ada di Warga, mungkin kepala dusun belum terdaftar sebagai Warga - buat default
    SwalToast("Profile belum lengkap. Silakan lengkapi data.");
    return;
  }
  currentWargaDoc = { id: doc.id, data: doc.data() };
  currentUser = auth.currentUser;
  // jika user adalah kepala dusun, load dusun yang dipimpin
  if(currentWargaDoc.data.role === 'kepala_dusun' || currentWargaDoc.data.role === 'kk'){
    // find dusun where kepalaId == uid
    const dusQuery = await db.collection('Dusun').where('kepalaId','==',uid).limit(1).get();
    if(!dusQuery.empty){
      const ddoc = dusQuery.docs[0];
      currentDusunDoc = { id: ddoc.id, data: ddoc.data() };
    } else {
      // or if user has kodeDusun assigned
      if(currentWargaDoc.data.kodeDusun){
        const q = await db.collection('Dusun').where('kode','==', currentWargaDoc.data.kodeDusun).limit(1).get();
        if(!q.empty) currentDusunDoc = { id: q.docs[0].id, data: q.docs[0].data() };
      }
    }
  } else {
    // regular warga -> get its dusun doc
    if(currentWargaDoc.data.kodeDusun){
      const q = await db.collection('Dusun').where('kode','==', currentWargaDoc.data.kodeDusun).limit(1).get();
      if(!q.empty) currentDusunDoc = { id: q.docs[0].id, data: q.docs[0].data() };
    }
  }
}

/* ================ Auth state listener & Auto login ================ */
auth.onAuthStateChanged(async (u) => {
  if(u){
    currentUser = u;
    await loadUserProfile();
    showDashboard();
  } else {
    currentUser = null;
    currentWargaDoc = null;
    currentDusunDoc = null;
    showAuth();
  }
});

window.addEventListener('load', async ()=>{
  updateClock();
  initChart();
  // Auto-login fallback by checking localStorage UID
  const savedUID = localStorage.getItem('userUID');
  if(savedUID && !auth.currentUser){
    // If Firebase has persisted auth, onAuthStateChanged will handle; otherwise we can attempt to load the profile doc to show UI in limited mode.
    try {
      const doc = await db.collection('Warga').doc(savedUID).get();
      if(doc.exists){
        // Show limited dashboard while auth may be re-established by firebase
        currentWargaDoc = { id: doc.id, data: doc.data() };
        // Note: not a substitute for auth, but supports "remember me" UI until auth state resolves
      }
    } catch(e){ console.warn(e); }
  }
});

/* ================ Show/Hide UI ================== */
function showAuth(){
  show('authCard'); hide('dashboardCard');
}
function showDashboard(){
  hide('authCard'); show('dashboardCard');
  $('display_name').innerText = currentWargaDoc?.data?.nama || (currentUser && currentUser.email) || 'Pengguna';
  $('display_role').innerText = (currentWargaDoc?.data?.role || 'warga').toUpperCase();
  $('btnLogout').onclick = onLogout;
  // role based UI
  const role = currentWargaDoc?.data?.role || 'warga';
  if(role === 'kepala_dusun'){
    show('kodeDashboard'); show('adminPanel'); show('kkPanel');
    renderDusunAdmin();
  } else {
    hide('kodeDashboard'); hide('adminPanel');
  }
  if(role === 'kk' || role === 'kepala_dusun'){
    show('kkPanel');
    loadPending();
  } else {
    hide('kkPanel');
  }
  if(role === 'warga'){
    // if pending
    if(currentWargaDoc.data.status === 'pending'){
      SwalAlert("Menunggu Verifikasi","Akun Anda menunggu persetujuan Kepala Keluarga. Anda belum dapat menggunakan fitur penuh.","info");
    }
  }
  // load reports & pos & chart for dusun
  if(currentDusunDoc && currentDusunDoc.data){
    showDusunDetails();
    subscribeReportsForDusun(currentDusunDoc.data.kode);
    loadPos();
  } else {
    // no dusun assigned -> empty
    $('listReports').innerHTML = '<div class="muted">Belum terhubung dengan dusun manapun.</div>';
    updateChartCounts({});
  }
}

/* ================ Logout ================== */
async function onLogout(){
  await auth.signOut();
  localStorage.removeItem('userUID');
  currentUser = null;
  currentWargaDoc = null;
  currentDusunDoc = null;
  SwalToast("Logout berhasil");
  showAuth();
}

/* ================ Dusun admin render ================== */
function showDusunOnDashboard(){
  if(currentDusunDoc && currentDusunDoc.data){
    $('display_code').innerText = currentDusunDoc.data.kode || '';
    // countdown
    const expires = currentDusunDoc.data.kodeExpiresAt && currentDusunDoc.data.kodeExpiresAt.toMillis ? currentDusunDoc.data.kodeExpiresAt.toMillis() : (currentDusunDoc.data.kodeExpiresAt || (Date.now() + KODE_EXPIRE_MS));
    startKodeCountdown(expires);
  }
}

function renderDusunAdmin(){
  if(!currentDusunDoc || !currentDusunDoc.data) {
    $('dusunInfo').innerHTML = '<div class="muted">Belum ada data dusun yang Anda pimpin.</div>';
    return;
  }
  const d = currentDusunDoc.data;
  $('dusunInfo').innerHTML = `
    <div><strong>${d.nama}</strong> (${d.provinsi || ''} / ${d.kabupaten || ''})</div>
    <div class="muted small">Kode: ${d.kode} · Dibuat: ${d.createdAt ? new Date(d.createdAt.seconds*1000).toLocaleString() : '-'}</div>
  `;
  $('display_code').innerText = d.kode || '';
  showDusunOnDashboard();
}

/* ================ Kode Countdown ================ */
function startKodeCountdown(expiresAtMs){
  if(kodeInterval) clearInterval(kodeInterval);
  function update(){
    const diff = expiresAtMs - Date.now();
    if(diff <= 0){
      $('display_countdown').innerText = 'KADALUARSA';
      clearInterval(kodeInterval);
    } else {
      const h = Math.floor(diff/3600000);
      const m = Math.floor((diff%3600000)/60000);
      const s = Math.floor((diff%60000)/1000);
      $('display_countdown').innerText = `${h}h ${m}m ${s}s`;
    }
  }
  update();
  kodeInterval = setInterval(update,1000);
}

/* ================ Regenerate & expire kode (admin) ================ */
async function regenerateCode(){
  if(!currentDusunDoc || !currentDusunDoc.id) return;
  const newCode = generateCode();
  const expires = Date.now() + KODE_EXPIRE_MS;
  await db.collection('Dusun').doc(currentDusunDoc.id).update({
    kode: newCode, kodeExpiresAt: firebase.firestore.Timestamp.fromMillis(expires)
  });
  // refresh doc
  const d = await db.collection('Dusun').doc(currentDusunDoc.id).get();
  currentDusunDoc.data = d.data();
  SwalToast("Kode di-regenerate");
  renderDusunAdmin();
}

async function expireCodeNow(){
  if(!currentDusunDoc || !currentDusunDoc.id) return;
  await db.collection('Dusun').doc(currentDusunDoc.id).update({
    kodeExpiresAt: firebase.firestore.Timestamp.fromMillis(Date.now()-1000)
  });
  currentDusunDoc.data.kodeExpiresAt = Date.now()-1000;
  SwalToast("Kode di-expire sekarang");
  renderDusunAdmin();
}

/* ================ Pending: KK Approve/Reject ================== */
async function loadPending(){
  if(!currentDusunDoc || !currentDusunDoc.data) { $('pendingList').innerHTML = '<div class="muted">Tidak ada dusun</div>'; return; }
  const kode = currentDusunDoc.data.kode;
  const snap = await db.collection('Warga').where('kodeDusun','==',kode).where('status','==','pending').get();
  const container = $('pendingList');
  container.innerHTML = '';
  if(snap.empty) { container.innerHTML = '<div class="muted">Tidak ada pendaftar pending.</div>'; return; }
  snap.forEach(doc=>{
    const d = doc.data();
    const div = document.createElement('div');
    div.className = 'd-flex justify-content-between align-items-center mb-2';
    div.innerHTML = `
      <div><strong>${d.nama}</strong><div class="muted small">${d.phone} · ${d.desa || ''}</div></div>
      <div>
        <button class="btn btn-success btn-sm me-2" onclick="approveUser('${doc.id}')">Setujui</button>
        <button class="btn btn-danger btn-sm" onclick="rejectUser('${doc.id}')">Tolak</button>
      </div>
    `;
    container.appendChild(div);
  });
}

async function approveUser(uid){
  if(!currentWargaDoc || !currentDusunDoc) return;
  await db.collection('Warga').doc(uid).update({
    status: 'aktif',
    approvedBy: currentWargaDoc.id,
    approvedAt: firebase.firestore.FieldValue.serverTimestamp()
  });
  SwalToast("Warga disetujui");
  loadPending();
}

async function rejectUser(uid){
  await db.collection('Warga').doc(uid).update({
    status: 'rejected',
    rejectedBy: currentWargaDoc.id,
    rejectedAt: firebase.firestore.FieldValue.serverTimestamp()
  });
  SwalToast("Pendaftar ditolak");
  loadPending();
}

/* ================ Reports (Laporan SOS) ================== */
async function sendReport(){
  if(!currentWargaDoc) { SwalAlert("Error","Anda harus login","error"); return; }
  if(currentWargaDoc.data.status !== 'aktif'){ SwalAlert("Error","Akun Anda belum aktif (menunggu verifikasi KK)","error"); return; }

  const jenis = $('lap_jenis').value;
  const lokasiOpt = $('lap_loc_opt').value;
  const lokasiDesc = $('lap_lokasi').value.trim();
  const dusunCode = currentWargaDoc.data.kodeDusun || (currentDusunDoc && currentDusunDoc.data && currentDusunDoc.data.kode);

  let lat = null, lng = null;
  if(lokasiOpt === 'saat_ini' && navigator.geolocation){
    try {
      const pos = await new Promise((res,rej)=> navigator.geolocation.getCurrentPosition(res,rej,{ timeout: 8000 }));
      lat = pos.coords.latitude; lng = pos.coords.longitude;
    } catch(e) {
      console.warn("GPS denied or failed", e);
    }
  }

  try{
    await db.collection('Laporan').add({
      jenis, lokasiDeskripsi: lokasiDesc || null, lat, lng,
      dusunCode: dusunCode || null,
      userId: currentWargaDoc.id,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      status: 'open'
    });
    SwalToast("Laporan terkirim!");
  }catch(err){
    SwalAlert("Error", err.message,'error');
  }
}

/* ================ Subscribe Reports for Dusun (realtime) ================== */
let laporanUnsub = null;
function subscribeReportsForDusun(kodeDusun){
  if(laporanUnsub) laporanUnsub();
  if(!kodeDusun) { updateChartCounts({}); return; }
  laporanUnsub = db.collection('Laporan').where('dusunCode','==',kodeDusun).orderBy('createdAt','desc').onSnapshot(snapshot=>{
    const arr = [];
    snapshot.forEach(doc=>{
      arr.push({ id:doc.id, data: doc.data() });
    });
    renderReports(arr);
    // update chart counts
    const counts = {};
    arr.forEach(r => counts[r.data.jenis] = (counts[r.data.jenis]||0) + 1);
    updateChartCounts(counts);
  });
}

function renderReports(arr){
  const container = $('listReports');
  container.innerHTML = '';
  if(!arr.length) { container.innerHTML = '<div class="muted">Belum ada laporan.</div>'; return; }
  arr.forEach(r=>{
    const d = r.data;
    const el = document.createElement('div');
    el.className = 'mb-2 p-2 border rounded';
    const time = d.createdAt ? new Date(d.createdAt.seconds*1000).toLocaleString() : '-';
    el.innerHTML = `<div><strong>${d.jenis}</strong> <span class="muted small">· ${time}</span></div>
      <div class="muted small">${d.lokasiDeskripsi||''} ${d.lat ? `<br>Lat:${d.lat.toFixed(5)} Lng:${d.lng.toFixed(5)}` : ''}</div>`;
    container.appendChild(el);
  });
}

/* ================ Chart update ================== */
function updateChartCounts(counts){
  const labels = ['Kebakaran','Kemalingan','Medis','Ambulance','Mencurigakan'];
  const data = labels.map(l => counts[l] || 0);
  if(laporanChart){
    laporanChart.data.datasets[0].data = data;
    laporanChart.update();
  }
}

/* ================ Pos Jaga (Map) - simple handlers ================ */
async function promptAddPos(){
  if(!currentWargaDoc) { SwalAlert("Error","Anda harus login terlebih dahulu","error"); return; }
  // hanya kepala dusun atau admin boleh menambahkan pos
  const role = currentWargaDoc.data.role;
  if(role !== 'kepala_dusun' && role !== 'kk'){
    SwalAlert("Akses Ditolak","Hanya Kepala Dusun/KK yang boleh menambah pos","error"); return;
  }
  const { value: formValues } = await Swal.fire({
    title: 'Tambah Pos Jaga',
    html:
      '<input id="swal-nama" class="swal2-input" placeholder="Nama Pos">' +
      '<input id="swal-lat" class="swal2-input" placeholder="Latitude (opsional)">' +
      '<input id="swal-lng" class="swal2-input" placeholder="Longitude (opsional)">',
    focusConfirm: false,
    preConfirm: () => {
      return {
        nama: document.getElementById('swal-nama').value,
        lat: document.getElementById('swal-lat').value,
        lng: document.getElementById('swal-lng').value
      }
    }
  });
  if(!formValues || !formValues.nama) return;
  try{
    await db.collection('PosDusun').add({
      nama: formValues.nama,
      lat: formValues.lat ? parseFloat(formValues.lat) : null,
      lng: formValues.lng ? parseFloat(formValues.lng) : null,
      dusunCode: currentDusunDoc.data.kode,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    SwalToast("Pos ditambahkan");
    loadPos();
  }catch(e){ SwalAlert("Error", e.message,'error'); }
}

async function loadPos(){
  if(!currentDusunDoc || !currentDusunDoc.data) { $('listPos').innerHTML = '<div class="muted">Belum ada pos.</div>'; return; }
  const snap = await db.collection('PosDusun').where('dusunCode','==', currentDusunDoc.data.kode).get();
  const list = $('listPos'); list.innerHTML = '';
  snap.forEach(doc=>{
    const d = doc.data();
    const el = document.createElement('div');
    el.className = 'p-2 border rounded mb-2';
    el.innerHTML = `<div><strong>${d.nama}</strong></div><div class="muted small">${d.lat||'-'}, ${d.lng||'-'}</div>`;
    list.appendChild(el);
  });

  // Google Maps markers (if maps loaded)
  if(window.google && mapObj === null){
    try {
      mapObj = new google.maps.Map(document.getElementById('map'), { center: {lat:-2.0, lng:117.0}, zoom: 5 });
    } catch(e){ console.warn(e); }
  }
  // clear markers
  posMarkers.forEach(m=>m.setMap(null)); posMarkers = [];
  if(window.google && mapObj){
    snap.forEach(doc=>{
      const d = doc.data();
      if(d.lat && d.lng){
        const mk = new google.maps.Marker({ position: { lat: d.lat, lng: d.lng }, map: mapObj, title: d.nama });
        posMarkers.push(mk);
      }
    });
    if(posMarkers[0]) mapObj.setCenter(posMarkers[0].getPosition());
  }
}

/* ================ Utility: show Dusun details (for warga & admin) ================ */
function showDusunDetails(){
  if(!currentDusunDoc || !currentDusunDoc.data) return;
  $('listReports').innerHTML = '<div class="muted">Memuat laporan...</div>';
  $('dusunInfo') && ( $('dusunInfo').innerHTML = `<div><strong>${currentDusunDoc.data.nama}</strong> · Kode: ${currentDusunDoc.data.kode}</div>` );
  // load pending if kk
  if((currentWargaDoc.data.role === 'kk' || currentWargaDoc.data.role === 'kepala_dusun')){
    loadPending();
  }
}

/* ================ Toggle lokasi input ================ */
function toggleLokasiInput(){
  const val = $('lap_loc_opt').value;
  if(val === 'lainnya') $('lap_lokasi').classList.remove('hidden'); else $('lap_lokasi').classList.add('hidden');
}

/* ================================================== */
/* ================ REGION DROPDOWN ================= */
/* Uses EMSIFA API for full Indonesia (online)        */
/* ================================================== */
const API_REG = "https://www.emsifa.com/api-wilayah-indonesia/api/";
async function loadProvinsiDropdown(){
  try{
    const res = await fetch(API_REG + 'provinces.json'); const data = await res.json();
    const provInput = document.getElementById('reg_provinsi');
    provInput.setAttribute('list','listProvinsi');
    const datalist = document.createElement('datalist'); datalist.id = 'listProvinsi';
    data.forEach(p => {
      const opt = document.createElement('option'); opt.value = p.name; datalist.appendChild(opt);
    });
    document.body.appendChild(datalist);
  }catch(e){ console.warn('Gagal muat provinsi', e); }
}
loadProvinsiDropdown();

/* ================================================== */
/* ================ Misc helpers ===================== */
/* ================================================== */

/* Safe console for older browsers */
if(!window.console) window.console = { log:function(){}, warn:function(){}, error:function(){} };

/* ================================================== */
/* ================ End of script ==================== */
/* ================================================== */
</script>
</body>
</html>
