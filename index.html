<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sistem Keamanan Dusun — FULL (All-in-one)</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
  :root{--card-radius:12px;}
  body{background:#f4f7ff;font-family:Inter,Segoe UI,Arial,sans-serif;padding:18px;}
  .card{border-radius:var(--card-radius);box-shadow:0 6px 18px rgba(20,30,60,0.06);}
  .form-control, .btn{border-radius:8px;}
  input.upper{ text-transform:uppercase; }
  #map{width:100%;height:320px;border-radius:8px;background:#eef;}
  .hidden{display:none!important;}
  .muted{color:#666;font-size:0.9rem;}
  .copy-btn{min-width:96px;}
</style>
</head>
<body>
<div class="container mx-auto" style="max-width:1100px;">
  <h3 class="text-center mb-4">Sistem Keamanan Dusun — FULL</h3>

  <!-- AUTH / CREATE -->
  <div id="authCard" class="card p-3 mb-4">
    <div class="row g-3">
      <!-- Left: Buat Dusun -->
      <div class="col-md-6">
        <h5>Buat Dusun (Kepala Dusun)</h5>
        <input id="dusun_nama" class="form-control mb-2 upper" placeholder="NAMA DUSUN">
        <input id="dusun_desa" class="form-control mb-2 upper" placeholder="DESA">
        <input id="dusun_kecamatan" class="form-control mb-2 upper" placeholder="KECAMATAN">
        <input id="dusun_kab" class="form-control mb-2 upper" placeholder="KABUPATEN">
        <input id="dusun_kota" class="form-control mb-2 upper" placeholder="KOTA">

        <!-- kode group -->
        <div id="kode_group" class="input-group mb-2 hidden">
          <input id="dusun_code" class="form-control" placeholder="KODE DUSUN (GENERATED)" readonly>
          <button id="copy_code_btn" class="btn btn-outline-secondary copy-btn" type="button">COPY</button>
        </div>

        <div class="d-grid gap-2 mb-2">
          <button id="generate_btn" class="btn btn-primary" onclick="onGenerateDusun()">Generate Kode</button>
          <button id="save_dusun_btn" class="btn btn-success hidden" onclick="onSaveDusun()">Simpan Dusun</button>
        </div>
        <div class="muted">Setelah generate: SALIN kode & bagikan ke warga. Kode berlaku 1 jam dan akan berganti otomatis saat kadaluarsa (jika Kepala Dusun login).</div>
      </div>

      <!-- Right: Daftar & Login -->
      <div class="col-md-6">
        <h5>Daftar Warga</h5>
        <input id="reg_nama" class="form-control mb-2 upper" placeholder="NAMA LENGKAP">
        <input id="reg_hp" class="form-control mb-2" placeholder="NOMOR HP (contoh: 0812... atau +62812...)" oninput="formatPhoneTyping(this)">
        <input id="reg_password" type="password" class="form-control mb-2" placeholder="PASSWORD">
        <input id="reg_alamat" class="form-control mb-2 upper" placeholder="ALAMAT (JALAN)">
        <input id="reg_blok" class="form-control mb-2 upper" placeholder="BLOK (opsional)">
        <input id="reg_no" class="form-control mb-2 upper" placeholder="NO RUMAH (opsional)">
        <div class="row g-2 mb-2">
          <div class="col">
            <input id="reg_rt" class="form-control" placeholder="RT (mis. 001)" maxlength="3" onblur="padRT(this)">
          </div>
          <div class="col">
            <input id="reg_rw" class="form-control" placeholder="RW (mis. 001)" maxlength="3" onblur="padRW(this)">
          </div>
        </div>
        <select id="reg_role" class="form-control mb-2">
          <option value="">-- PILIH ROLE --</option>
          <option value="kepala_desa">KEPALA DESA</option>
          <option value="kepala_dusun">KEPALA DUSUN</option>
          <option value="ketua_rt">KETUA RT</option>
          <option value="ketua_rw">KETUA RW</option>
          <option value="kepala_keluarga">KEPALA KELUARGA</option>
          <option value="istri">ISTRI</option>
          <option value="anak">ANAK</option>
          <option value="lainnya">LAINNYA</option>
        </select>
        <input id="reg_kode" class="form-control mb-2 upper" placeholder="KODE DUSUN (dari Kepala Dusun)">
        <div class="d-grid gap-2">
          <button class="btn btn-success" onclick="onRegister()">Daftar</button>
          <button class="btn btn-outline-secondary" onclick="clearRegister()">Reset</button>
        </div>

        <hr>

        <h5>Login</h5>
        <input id="login_hp" class="form-control mb-2" placeholder="NOMOR HP (contoh: 0812... atau +62812...)" oninput="formatPhoneTyping(this)">
        <input id="login_pass" type="password" class="form-control mb-2" placeholder="PASSWORD">
        <div class="d-grid gap-2">
          <button class="btn btn-primary" onclick="onLogin()">Login</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dashboardCard" class="card p-3 hidden">
    <div class="d-flex justify-content-between align-items-start">
      <div>
        <h4>Dashboard Dusun</h4>
        <div class="muted">Selamat datang, <b id="display_name"></b> · <span id="display_role"></span></div>
        <div class="muted">Waktu: <span id="clock"></span></div>
      </div>
      <div class="text-end">
        <button class="btn btn-danger btn-sm" onclick="onLogout()">Logout</button>
      </div>
    </div>

    <!-- kode (kepala dusun only) -->
    <div id="kodeDashboard" class="card p-3 mt-3 d-none">
      <div class="d-flex justify-content-between">
        <div>
          <div class="muted">Kode Dusun</div>
          <h5 id="display_code"></h5>
        </div>
        <div>
          <div class="muted">Sisa waktu</div>
          <div id="display_countdown" style="font-weight:600"></div>
        </div>
      </div>
    </div>

    <div class="row mt-3 g-3">
      <div class="col-lg-5">
        <div class="card p-3 mb-3">
          <h6>Buat Laporan SOS</h6>
          <select id="lap_jenis" class="form-control mb-2">
            <option>Kemalingan</option>
            <option>Kebakaran</option>
            <option>Medis</option>
            <option>Ambulance</option>
            <option>Mencurigakan</option>
          </select>
          <select id="lap_loc_opt" class="form-control mb-2" onchange="toggleLokasiInput()">
            <option value="saat_ini">Lokasi Saat Ini</option>
            <option value="lainnya">Lokasi Lain</option>
          </select>
          <textarea id="lap_lokasi" class="form-control mb-2 hidden" placeholder="Deskripsi lokasi (opsional)"></textarea>
          <div class="d-grid">
            <button class="btn btn-danger" onclick="sendReport()">Kirim Laporan</button>
          </div>
        </div>

        <div class="card p-3 mb-3">
          <h6>Statistik Kejadian</h6>
          <canvas id="chartKejadian" style="width:100%;height:220px"></canvas>
        </div>

        <div class="card p-3 mb-3">
          <h6>Daftar Laporan Terbaru</h6>
          <div id="listReports"></div>
        </div>
      </div>

      <div class="col-lg-7">
        <div class="card p-3 mb-3">
          <h6>Pos Jaga Dusun</h6>
          <div id="map"></div>
          <div class="d-flex gap-2 mt-3">
            <button class="btn btn-primary" onclick="promptAddPos()">Tambah Pos RT</button>
            <button class="btn btn-outline-secondary" onclick="loadPos()">Muat Ulang Pos</button>
          </div>
          <div id="listPos" class="mt-3"></div>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Google Maps -->
<script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY"></script>

<script>
/* ================= Firebase init (compat) ================= */
const firebaseConfig = {
  apiKey: "AIzaSyA6GAeIc7ZesIed9MAelUf6x_sBFdp9E-Q",
  authDomain: "dusun-super.firebaseapp.com",
  projectId: "dusun-super",
  storageBucket: "dusun-super.firebasestorage.app",
  messagingSenderId: "1083284057385",
  appId: "1:1083284057385:web:21cfe467b047bb5a241b38",
  measurementId: "G-LJ6KP57Q9M"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* ================= State ================= */
let currentUser = null;
let currentDusunId = null;
let map = null;
let markers = [];
let laporanChart = null;
let kodeUnsub = null;
let kodeInterval = null;

/* ================= Helpers ================= */
const $ = id => document.getElementById(id);
const show = id => { const el=$(id); if(el) el.classList.remove('hidden'); };
const hide = id => { const el=$(id); if(el) el.classList.add('hidden'); };
const SwalToast = (title, icon='success', timer=2000) => { return Swal.fire({ title, icon, toast:true, position:'top-end', showConfirmButton:false, timer }); };
const SwalAlert = (title, html, icon='info') => { return Swal.fire({ title, html, icon }); };

/* Auto-uppercase */
document.addEventListener('input', e=>{
  if(e.target && e.target.classList && e.target.classList.contains('upper')){
    e.target.value = e.target.value.toUpperCase();
  }
});

/* ================= Phone formatting & RT/RW ================= */
function normalizePhoneForKey(v){
  let s = (v||"").trim();
  if(s.startsWith('0')) s = '+62'+s.substr(1);
  return s.replace(/\s+/g,'');
}
function formatPhoneTyping(el){
  el.value = el.value.replace(/\D/g,'');
}
function padRT(el){ if(el.value.length<3) el.value=('000'+el.value).slice(-3); }
function padRW(el){ if(el.value.length<3) el.value=('000'+el.value).slice(-3); }

/* ================= Generate Dusun ================= */
function generateRandomCode(len=6){
  const chars='ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
  let code='';
  for(let i=0;i<len;i++) code+=chars.charAt(Math.floor(Math.random()*chars.length));
  return code;
}
function onGenerateDusun(){
  const code = generateRandomCode();
  $('dusun_code').value = code;
  show('kode_group');
  show('save_dusun_btn');
  SwalToast('Kode Dusun berhasil digenerate');
}
function onSaveDusun(){
  const data={
    nama:$('dusun_nama').value.trim(),
    desa:$('dusun_desa').value.trim(),
    kecamatan:$('dusun_kecamatan').value.trim(),
    kabupaten:$('dusun_kab').value.trim(),
    kota:$('dusun_kota').value.trim(),
    code:$('dusun_code').value.trim(),
    createdAt:firebase.firestore.FieldValue.serverTimestamp()
  };
  db.collection('dusun').add(data).then(doc=>{
    currentDusunId = doc.id;
    SwalToast('Dusun berhasil disimpan!');
  }).catch(e=>SwalAlert('Error', e.message,'error'));
}

/* ================= COPY kode ================= */
$('copy_code_btn').addEventListener('click',()=>{
  const val=$('dusun_code').value;
  if(!val)return;
  navigator.clipboard.writeText(val).then(()=>SwalToast('Kode disalin ke clipboard'));
});

/* ================= REGISTER ================= */
function onRegister(){
  const hp = normalizePhoneForKey($('reg_hp').value);
  const pw = $('reg_password').value;
  const nama = $('reg_nama').value.trim();
  const kodeDusun = $('reg_kode').value.trim().toUpperCase();
  if(!hp||!pw||!nama||!kodeDusun) { SwalToast('Lengkapi data!', 'error'); return; }

  // cek kode dusun
  db.collection('dusun').where('code','==',kodeDusun).get().then(snap=>{
    if(snap.empty){ SwalToast('Kode Dusun salah!', 'error'); return; }
    const dusunId = snap.docs[0].id;

    // cek nomor HP
    db.collection('users').where('hp','==',hp).get().then(snap2=>{
      if(!snap2.empty){ SwalToast('Nomor HP sudah terdaftar', 'error'); return; }
      db.collection('users').add({
        nama, hp, password:pw,
        alamat:$('reg_alamat').value.trim(),
        blok:$('reg_blok').value.trim(),
        no:$('reg_no').value.trim(),
        rt:$('reg_rt').value.trim(),
        rw:$('reg_rw').value.trim(),
        role:$('reg_role').value,
        dusunId,
        createdAt:firebase.firestore.FieldValue.serverTimestamp()
      }).then(()=>SwalToast('Registrasi berhasil! Silakan login'))
      .catch(e=>SwalAlert('Error',e.message,'error'));
    });
  });
}
function clearRegister(){
  ['reg_nama','reg_hp','reg_password','reg_alamat','reg_blok','reg_no','reg_rt','reg_rw','reg_kode'].forEach(id=>$(id).value='');
  $('reg_role').value='';
}

/* ================= LOGIN ================= */
function onLogin(){
  const hp = normalizePhoneForKey($('login_hp').value);
  const pw = $('login_pass').value;
  if(!hp||!pw){ SwalToast('Lengkapi data login!', 'error'); return; }
  db.collection('users').where('hp','==',hp).where('password','==',pw).get().then(snap=>{
    if(snap.empty){ SwalToast('HP atau Password salah!', 'error'); return; }
    const u = snap.docs[0].data();
    currentUser = {...u, id:snap.docs[0].id};
    currentDusunId = u.dusunId;
    setupDashboard();
  });
}

/* ================= LOGOUT ================= */
function onLogout(){
  currentUser = null;
  currentDusunId = null;
  hide('dashboardCard');
  show('authCard');
}

/* ================= Dashboard ================= */
function setupDashboard(){
  hide('authCard');
  show('dashboardCard');
  $('display_name').innerText = currentUser.nama;
  $('display_role').innerText = currentUser.role;

  if(currentUser.role==='kepala_dusun'){
    $('kodeDashboard').classList.remove('d-none');
    db.collection('dusun').doc(currentDusunId).get().then(d=>{
      $('display_code').innerText = d.data().code;
      startKodeCountdown(3600); // 1 jam
    });
  }

  startClock();
  initMap();
  loadPos();
  loadReports();
}

/* ================= Clock ================= */
function startClock(){
  setInterval(()=>{$('clock').innerText=new Date().toLocaleString()},1000);
}

/* ================= Kode Dusun countdown ================= */
function startKodeCountdown(seconds){
  clearInterval(kodeInterval);
  let s=seconds;
  kodeInterval=setInterval(()=>{
    let m=Math.floor(s/60); let sec=s%60;
    $('display_countdown').innerText=m+':'+(sec<10?'0'+sec:sec);
    if(s--<=0){ clearInterval(kodeInterval); $('display_countdown').innerText='Kadaluarsa'; }
  },1000);
}

/* ================= Laporan ================= */
function toggleLokasiInput(){
  const val=$('lap_loc_opt').value;
  if(val==='lainnya') $('lap_lokasi').classList.remove('hidden');
  else $('lap_lokasi').classList.add('hidden');
}
function sendReport(){
  const jenis=$('lap_jenis').value;
  let lokasi='Saat Ini';
  if($('lap_loc_opt').value==='lainnya') lokasi=$('lap_lokasi').value.trim()||'Lokasi lain';
  db.collection('reports').add({
    jenis, lokasi, uid:currentUser.id,
    timestamp:firebase.firestore.FieldValue.serverTimestamp(),
    dusunId:currentDusunId
  }).then(()=>SwalToast('Laporan terkirim')).catch(e=>SwalAlert('Error',e.message,'error'));
}
function loadReports(){
  db.collection('reports').where('dusunId','==',currentDusunId).orderBy('timestamp','desc').limit(10).get().then(snap=>{
    const container=$('listReports');
    container.innerHTML='';
    snap.forEach(doc=>{
      const d=doc.data();
      const t = d.timestamp?.toDate().toLocaleString()||'';
      container.innerHTML+=`<div class="mb-1">${d.jenis} — ${d.lokasi} <span class="muted">${t}</span></div>`;
    });
    updateChart(snap.docs.map(d=>d.data()));
  });
}
function updateChart(data){
  const ctx=$('chartKejadian').getContext('2d');
  const counts={Kemalingan:0,Kebakaran:0,Medis:0,Ambulance:0,Mencurigakan:0};
  data.forEach(d=>{ if(counts[d.jenis]!==undefined) counts[d.jenis]++; });
  if(laporanChart) laporanChart.destroy();
  laporanChart = new Chart(ctx,{
    type:'bar',
    data:{
      labels:Object.keys(counts),
      datasets:[{label:'Jumlah Kejadian',data:Object.values(counts),backgroundColor:'#4e73df'}]
    },
    options:{responsive:true,plugins:{legend:{display:false}}}
  });
}

/* ================= Map & Pos ================= */
function initMap(){
  map=new google.maps.Map($('map'),{center:{lat:-6.2,lng:106.816},zoom:15});
}
function loadPos(){
  if(!map) return;
  markers.forEach(m=>m.setMap(null));
  markers=[];
  db.collection('pos').where('dusunId','==',currentDusunId).get().then(snap=>{
    snap.forEach(doc=>{
      const d=doc.data();
      const marker=new google.maps.Marker({position:{lat:d.lat,lng:d.lng},map,title:d.nama});
      markers.push(marker);
    });
  });
}
function promptAddPos(){
  Swal.fire({
    title:'Tambah Pos',
    html:'<input id="swal_pos_name" class="swal2-input" placeholder="Nama Pos (RT)">'+
         '<input id="swal_pos_lat" class="swal2-input" placeholder="Latitude">'+
         '<input id="swal_pos_lng" class="swal2-input" placeholder="Longitude">',
    confirmButtonText:'Simpan', preConfirm:()=>{
      const n=$('#swal_pos_name').value.trim();
      const lat=parseFloat($('#swal_pos_lat').value);
      const lng=parseFloat($('#swal_pos_lng').value);
      if(!n||isNaN(lat)||isNaN(lng)){ SwalAlert('Error','Isi semua data dengan benar','error'); return false; }
      db.collection('pos').add({nama:n,lat,lng,dusunId:currentDusunId}).then(()=>{ SwalToast('Pos tersimpan'); loadPos(); });
    }
  });
}
</script>
</body>
</html>
