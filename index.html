<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sistem Keamanan Dusun — FULL (All-in-one)</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
  :root{--card-radius:12px;}
  body{background:#f4f7ff;font-family:Inter,Segoe UI,Arial,sans-serif;padding:18px;}
  .card{border-radius:var(--card-radius);box-shadow:0 6px 18px rgba(20,30,60,0.06);}
  .form-control, .btn{border-radius:8px;}
  input.upper{ text-transform:uppercase; }
  #map{width:100%;height:320px;border-radius:8px;background:#eef;}
  .hidden{display:none!important;}
  .muted{color:#666;font-size:0.9rem;}
  .copy-btn{min-width:96px;}
</style>
</head>
<body>
<div class="container mx-auto" style="max-width:1100px;">
  <h3 class="text-center mb-4">Sistem Keamanan Dusun — FULL</h3>

  <!-- AUTH / CREATE -->
  <div id="authCard" class="card p-3 mb-4">
    <div class="row g-3">
      <!-- Left: Buat Dusun -->
      <div class="col-md-6">
        <h5>Buat Dusun (Kepala Dusun)</h5>
        <input id="dusun_nama" class="form-control mb-2 upper" placeholder="NAMA DUSUN">
        <input id="dusun_desa" class="form-control mb-2 upper" placeholder="DESA">
        <input id="dusun_kecamatan" class="form-control mb-2 upper" placeholder="KECAMATAN">
        <input id="dusun_kab" class="form-control mb-2 upper" placeholder="KABUPATEN">
        <input id="dusun_kota" class="form-control mb-2 upper" placeholder="KOTA">

        <!-- kode group -->
        <div id="kode_group" class="input-group mb-2 hidden">
          <input id="dusun_code" class="form-control" placeholder="KODE DUSUN (GENERATED)" readonly>
          <button id="copy_code_btn" class="btn btn-outline-secondary copy-btn" type="button">COPY</button>
        </div>

        <div class="d-grid gap-2 mb-2">
          <button id="generate_btn" class="btn btn-primary" onclick="onGenerateDusun()">Generate Kode</button>
          <button id="save_dusun_btn" class="btn btn-success hidden" onclick="onSaveDusun()">Simpan Dusun</button>
        </div>
        <div class="muted">Setelah generate: SALIN kode & bagikan ke warga. Kode berlaku 1 jam dan akan berganti otomatis saat kadaluarsa (jika Kepala Dusun login).</div>
      </div>

      <!-- Right: Daftar & Login -->
      <div class="col-md-6">
        <h5>Daftar Warga</h5>
        <input id="reg_nama" class="form-control mb-2 upper" placeholder="NAMA LENGKAP">
        <input id="reg_hp" class="form-control mb-2" placeholder="NOMOR HP (contoh: 0812... atau +62812...)" oninput="formatPhoneTyping(this)">
        <input id="reg_password" type="password" class="form-control mb-2" placeholder="PASSWORD">
        <input id="reg_alamat" class="form-control mb-2 upper" placeholder="ALAMAT (JALAN)">
        <input id="reg_blok" class="form-control mb-2 upper" placeholder="BLOK (opsional)">
        <input id="reg_no" class="form-control mb-2 upper" placeholder="NO RUMAH (opsional)">
        <div class="row g-2 mb-2">
          <div class="col">
            <input id="reg_rt" class="form-control" placeholder="RT (mis. 001)" maxlength="3" onblur="padRT(this)">
          </div>
          <div class="col">
            <input id="reg_rw" class="form-control" placeholder="RW (mis. 001)" maxlength="3" onblur="padRW(this)">
          </div>
        </div>
        <select id="reg_role" class="form-control mb-2">
          <option value="">-- PILIH ROLE --</option>
          <option value="kepala_desa">KEPALA DESA</option>
          <option value="kepala_dusun">KEPALA DUSUN</option>
          <option value="ketua_rt">KETUA RT</option>
          <option value="ketua_rw">KETUA RW</option>
          <option value="kepala_keluarga">KEPALA KELUARGA</option>
          <option value="istri">ISTRI</option>
          <option value="anak">ANAK</option>
          <option value="lainnya">LAINNYA</option>
        </select>
        <input id="reg_kode" class="form-control mb-2 upper" placeholder="KODE DUSUN (dari Kepala Dusun)">
        <div class="d-grid gap-2">
          <button class="btn btn-success" onclick="onRegister()">Daftar</button>
          <button class="btn btn-outline-secondary" onclick="clearRegister()">Reset</button>
        </div>

        <hr>

        <h5>Login</h5>
        <input id="login_hp" class="form-control mb-2" placeholder="NOMOR HP (contoh: 0812... atau +62812...)" oninput="formatPhoneTyping(this)">
        <input id="login_pass" type="password" class="form-control mb-2" placeholder="PASSWORD">
        <div class="d-grid gap-2">
          <button class="btn btn-primary" onclick="onLogin()">Login</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dashboardCard" class="card p-3 hidden">
    <div class="d-flex justify-content-between align-items-start">
      <div>
        <h4>Dashboard Dusun</h4>
        <div class="muted">Selamat datang, <b id="display_name"></b> · <span id="display_role"></span></div>
        <div class="muted">Waktu: <span id="clock"></span></div>
      </div>
      <div class="text-end">
        <button class="btn btn-danger btn-sm" onclick="onLogout()">Logout</button>
      </div>
    </div>

    <!-- kode (kepala dusun only) -->
    <div id="kodeDashboard" class="card p-3 mt-3 d-none">
      <div class="d-flex justify-content-between">
        <div>
          <div class="muted">Kode Dusun</div>
          <h5 id="display_code"></h5>
        </div>
        <div>
          <div class="muted">Sisa waktu</div>
          <div id="display_countdown" style="font-weight:600"></div>
        </div>
      </div>
    </div>

    <div class="row mt-3 g-3">
      <div class="col-lg-5">
        <div class="card p-3 mb-3">
          <h6>Buat Laporan SOS</h6>
          <select id="lap_jenis" class="form-control mb-2">
            <option>Kemalingan</option>
            <option>Kebakaran</option>
            <option>Medis</option>
            <option>Ambulance</option>
            <option>Mencurigakan</option>
          </select>
          <select id="lap_loc_opt" class="form-control mb-2" onchange="toggleLokasiInput()">
            <option value="saat_ini">Lokasi Saat Ini</option>
            <option value="lainnya">Lokasi Lain</option>
          </select>
          <textarea id="lap_lokasi" class="form-control mb-2 hidden" placeholder="Deskripsi lokasi (opsional)"></textarea>
          <div class="d-grid">
            <button class="btn btn-danger" onclick="sendReport()">Kirim Laporan</button>
          </div>
        </div>

        <div class="card p-3 mb-3">
          <h6>Statistik Kejadian</h6>
          <canvas id="chartKejadian" style="width:100%;height:220px"></canvas>
        </div>

        <div class="card p-3 mb-3">
          <h6>Daftar Laporan Terbaru</h6>
          <div id="listReports"></div>
        </div>
      </div>

      <div class="col-lg-7">
        <div class="card p-3 mb-3">
          <h6>Pos Jaga Dusun</h6>
          <div id="map"></div>
          <div class="d-flex gap-2 mt-3">
            <button class="btn btn-primary" onclick="promptAddPos()">Tambah Pos RT</button>
            <button class="btn btn-outline-secondary" onclick="loadPos()">Muat Ulang Pos</button>
          </div>
          <div id="listPos" class="mt-3"></div>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Google Maps: ganti key ini -->
<script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY"></script>

<script>
/* ================= Firebase init (compat) ================= */
const firebaseConfig = {
  apiKey: "AIzaSyA6GAeIc7ZesIed9MAelUf6x_sBFdp9E-Q",
  authDomain: "dusun-super.firebaseapp.com",
  projectId: "dusun-super",
  storageBucket: "dusun-super.firebasestorage.app",
  messagingSenderId: "1083284057385",
  appId: "1:1083284057385:web:21cfe467b047bb5a241b38",
  measurementId: "G-LJ6KP57Q9M"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* ================= State ================= */
let currentUser = null;
let currentDusunId = null;
let map = null;
let markers = [];
let laporanChart = null;
let kodeUnsub = null;
let kodeInterval = null;

/* ================= Helpers ================= */
const $ = id => document.getElementById(id);
const show = id => { const el=$(id); if(el) el.classList.remove('hidden'); };
const hide = id => { const el=$(id); if(el) el.classList.add('hidden'); };
const SwalToast = (title, icon='success', timer=2000) => { return Swal.fire({ title, icon, toast:true, position:'top-end', showConfirmButton:false, timer }); };
const SwalAlert = (title, html, icon='info') => { return Swal.fire({ title, html, icon }); };

/* Auto-uppercase for inputs with class "upper" */
document.addEventListener('input', e=>{
  if(e.target && e.target.classList && e.target.classList.contains('upper')){
    e.target.value = e.target.value.toUpperCase();
  }
});

/* ================ Phone formatting & RT/RW padding ================ */
function normalizePhoneForKey(v){
  let s = (v||"").replace(/\s+/g,"").replace(/\D/g,"");
  if(s.startsWith("0")) s = "62"+s.substring(1);
  if(!s.startsWith("62")) s = "62"+s;
  return s; // e.g. "62812..."
}
function formatPhoneTyping(el){
  let raw = el.value.replace(/[^\d\+]/g,"");
  if(raw.startsWith("+")) {
    let digits = raw.replace(/\D/g,"");
    el.value = "+" + digits;
  } else {
    el.value = raw;
  }
}
function formatPhoneOnBlur(el){
  const key = normalizePhoneForKey(el.value);
  if(!key) { el.value=""; return; }
  el.value = "+" + key;
}
function padRT(el){
  let v = (el.value||"").replace(/\D/g,"");
  v = v.padStart(3,"0");
  el.value = v;
}
function padRW(el){
  let v = (el.value||"").replace(/\D/g,"");
  v = v.padStart(3,"0");
  el.value = v;
}
['reg_hp','login_hp'].forEach(id=>{
  const el = $(id);
  if(el) { el.addEventListener('blur', ()=>formatPhoneOnBlur(el)); }
});

/* ================ Auth state listener ================ */
auth.onAuthStateChanged(async (u) => {
  if(u){ currentUser = u; await loadUserProfile(); showDashboard(); } 
  else { currentUser=null; showAuth(); }
});

/* ===================== Show/Hide UI ===================== */
function showAuth(){ show('authCard'); hide('dashboardCard'); }
function showDashboard(){ hide('authCard'); show('dashboardCard'); updateClock(); }

/* ===================== Clock ===================== */
function updateClock(){ 
  const now = new Date(); 
  $('clock').innerText = now.toLocaleString();
  setTimeout(updateClock,1000);
}

/* ===================== Dusun Code ===================== */
function generateCode(){ return Math.random().toString(36).substring(2,8).toUpperCase(); }

$('generate_btn').onclick = function(){
  const code = generateCode();
  $('dusun_code').value = code;
  show('kode_group'); show('save_dusun_btn');
};

/* Copy button */
$('copy_code_btn').onclick = ()=>{
  navigator.clipboard.writeText($('dusun_code').value);
  SwalToast("Kode Dusun disalin!");
};

/* =============== Save Dusun ================== */
async function onSaveDusun(){
  const nama=$('dusun_nama').value.trim();
  const desa=$('dusun_desa').value.trim();
  const kec=$('dusun_kecamatan').value.trim();
  const kab=$('dusun_kab').value.trim();
  const kota=$('dusun_kota').value.trim();
  const code=$('dusun_code').value.trim();
  if(!nama||!code){ SwalAlert("Gagal","Nama & Kode Dusun wajib"); return; }
  
  try{
    const docRef = await db.collection('Dusun').add({
      nama, desa, kecamatan:kec, kabupaten:kab, kota,
      kode: code,
      kepalaId: currentUser.uid,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    currentDusunId = docRef.id;
    SwalToast("Dusun tersimpan!");
    hide('save_dusun_btn');
  }catch(err){
    SwalAlert("Error", err.message,'error');
  }
}

/* =================== Register ================== */
async function onRegister(){
  const nama=$('reg_nama').value.trim();
  const hp=$('reg_hp').value.trim();
  const password=$('reg_password').value;
  const alamat=$('reg_alamat').value.trim();
  const role=$('reg_role').value;
  const kode=$('reg_kode').value.trim();
  if(!nama||!hp||!password||!role||!kode){ SwalAlert("Error","Lengkapi semua field"); return; }

  try{
    const keyEmail = normalizePhoneForKey(hp) + "@dusun.fake";
    // Auth
    const userCred = await auth.createUserWithEmailAndPassword(keyEmail,password);
    const uid = userCred.user.uid;

    // Simpan data warga
    await db.collection('Warga').doc(uid).set({
      nama, hp, alamat, role, kodeDusun:kode,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    SwalToast("Pendaftaran berhasil! Silakan login.");
    clearRegister();
  }catch(err){
    SwalAlert("Error", err.message,'error');
  }
}

function clearRegister(){
  ['reg_nama','reg_hp','reg_password','reg_alamat','reg_role','reg_kode','reg_blok','reg_no','reg_rt','reg_rw'].forEach(id=>{
    const el=$(id); if(el) el.value='';
  });
}

/* =================== Login ================== */
async function onLogin(){
  const hp=$('login_hp').value.trim();
  const password=$('login_pass').value;
  if(!hp||!password){ SwalAlert("Error","Nomor HP & password wajib"); return; }

  try{
    const keyEmail = normalizePhoneForKey(hp)+"@dusun.fake";
    const userCred = await auth.signInWithEmailAndPassword(keyEmail,password);
    currentUser = userCred.user;
    await loadUserProfile();
    SwalToast("Login berhasil!");
  }catch(err){
    SwalAlert("Error",err.message,'error');
  }
}

async function loadUserProfile(){
  if(!currentUser) return;
  const doc = await db.collection('Warga').doc(currentUser.uid).get();
  if(!doc.exists){ SwalAlert("Error","Data user tidak ditemukan"); return; }
  const data = doc.data();
  $('display_name').innerText = data.nama || '';
  $('display_role').innerText = data.role || '';
  currentDusunId = data.kodeDusun || null;
}

/* =================== Logout ================== */
function onLogout(){ auth.signOut(); currentUser=null; currentDusunId=null; SwalToast("Logout berhasil"); }

/* =================== Toggle lokasi lain ================== */
function toggleLokasiInput(){
  const val=$('lap_loc_opt').value;
  if(val==='lainnya') $('lap_lokasi').classList.remove('hidden');
  else $('lap_lokasi').classList.add('hidden');
}

/* =================== Dummy placeholders untuk laporan, pos, chart ================== */
function sendReport(){ SwalToast("Laporan terkirim (dummy)"); }
function promptAddPos(){ SwalToast("Tambah pos RT (dummy)"); }
function loadPos(){ SwalToast("Muat ulang pos (dummy)"); }

</script>
</body>
</html>
